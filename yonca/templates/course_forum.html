{% extends 'base.html' %}
{% block title %}Forum for {{ course.title }}{% endblock %}
{% block content %}
<div class="container" style="margin-top:40px;">
    <h2>Forum for {{ course.title }}</h2>
    {% for ann in announcements %}
    <div class="card mb-4">
        <div class="card-header">
            <strong>{{ ann.title }}</strong>
            <span class="text-muted">({{ ann.created_at.strftime('%b %d, %Y %I:%M %p') }})</span>
        </div>
        <div class="card-body">
            <div>{{ ann.message }}</div>
            {% macro render_replies(replies, announcement_id) %}
            <ul class="list-group mt-3">
                {% for reply in replies %}
                <li class="list-group-item">
                    <span class="font-weight-bold">{{ reply.user.username }}:</span>
                    {{ reply.message }}
                    <small class="text-muted">{{ reply.created_at.strftime('%b %d, %Y %I:%M %p') }}</small>
                    {% if is_authenticated %}
                    <button class="btn btn-link btn-sm" type="button" onclick="document.getElementById('reply-form-{{ reply.id }}').style.display = (document.getElementById('reply-form-{{ reply.id }}').style.display === 'none' ? 'block' : 'none');">Reply</button>
                    <form method="POST" class="mt-2" id="reply-form-{{ reply.id }}" style="display:none;">
                        <input type="hidden" name="action" value="reply_announcement">
                        <input type="hidden" name="announcement_id" value="{{ announcement_id }}">
                        <input type="hidden" name="parent_reply_id" value="{{ reply.id }}">
                        <textarea name="message" class="form-control mb-2" rows="2" placeholder="Reply to this reply..."></textarea>
                        <button type="submit" class="btn btn-secondary btn-sm">Post Reply</button>
                    </form>
                    {% endif %}
                    {% if reply.child_replies.count() > 0 %}
                        {{ render_replies(reply.child_replies.order_by(CourseAnnouncementReply.created_at.asc()), announcement_id) }}
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% endmacro %}

            {% if ann.replies.count() > 0 %}
                {{ render_replies(ann.replies.filter_by(parent_reply_id=None).order_by(CourseAnnouncementReply.created_at.asc()), ann.id) }}
            {% else %}
                <p class="text-muted">No replies yet.</p>
            {% endif %}
            {% if is_authenticated %}
            <form method="POST" class="mt-3">
                <input type="hidden" name="action" value="reply_announcement">
                <input type="hidden" name="announcement_id" value="{{ ann.id }}">
                <textarea name="message" class="form-control mb-2" rows="2" placeholder="Reply..."></textarea>
                <button type="submit" class="btn btn-primary btn-sm">Post Reply</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}