{% extends 'admin/master.html' %}
{% block head %}
{{ super() }}
<style>
    .builder-container {
        display: flex;
        height: calc(100vh - 200px);
        gap: 20px;
    }
    .editor-panel {
        flex: 1;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
    }
    .preview-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        overflow: hidden;
    }
    .preview-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }
    .content-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background: white;
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .section-title {
        font-weight: bold;
        color: #495057;
    }
    .form-group-inline {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .form-group-inline label {
        min-width: 120px;
        font-weight: 500;
    }
    .form-group-inline input,
    .form-group-inline textarea {
        flex: 1;
    }
    .btn-save {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-save:hover {
        background: #218838;
    }
    .live-preview {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-top: 10px;
    }
    .preview-title {
        color: #abc32f;
        font-size: 1.5em;
        margin-bottom: 10px;
    }
    .preview-subtitle {
        color: #6c757d;
        margin-bottom: 15px;
    }
    .preview-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin: 3rem 0;
    }
    .preview-feature {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .preview-feature:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .feature-title {
        color: #abc32f;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
    }
    .feature-desc {
        color: #6c757d;
        font-size: 1rem;
    }
    .feature-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    .feature-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #abc32f;
    }
    .feature-item.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .feature-placeholder {
        background: #e9ecef;
        border: 2px dashed #abc32f;
        border-radius: 8px;
        height: 60px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-style: italic;
    }
    .toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 10px 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .toolbar .btn {
        padding: 6px 12px;
        font-size: 0.9em;
    }
    .unsaved-changes {
        background: #fff3cd;
        color: #856404;
        padding: 8px 16px;
        border-radius: 4px;
        border: 1px solid #ffeaa7;
        display: none;
        margin-bottom: 15px;
    }
    .feature-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .drag-handle {
        cursor: move;
        color: #6c757d;
        padding: 5px;
        border-radius: 3px;
        transition: background-color 0.2s;
    }
    .drag-handle:hover {
        background-color: #f8f9fa;
    }
    .remove-feature {
        padding: 4px 8px;
    }
    .remove-feature:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div style="margin-bottom: 20px;">
                <a href="/" class="btn btn-success" style="float: right;">
                    <i class="fa fa-home"></i> Return to Site
                </a>
            </div>
            <h1><i class="fa fa-magic"></i> Home Page Builder</h1>
            <p class="text-muted">Design your home page with our intuitive drag-and-drop builder</p>
        </div>
    </div>

    <div class="toolbar">
        <div class="unsaved-changes" id="unsaved-indicator">
            <i class="fa fa-exclamation-triangle"></i> You have unsaved changes
        </div>
        <div style="margin-left: auto;">
            <button type="button" class="btn btn-outline-info" id="show-shortcuts" title="Keyboard Shortcuts">
                <i class="fa fa-keyboard-o"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="reset-changes">
                <i class="fa fa-undo"></i> Reset
            </button>
            <button type="button" class="btn btn-outline-primary" id="preview-mode">
                <i class="fa fa-eye"></i> Preview Mode
            </button>
        </div>
    </div>
        <!-- Editor Panel -->
        <div class="editor-panel">
            <h3><i class="fa fa-edit"></i> Content Editor</h3>

            <form method="post" id="content-form" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                <!-- Logged In Content -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-user"></i> Logged In Users</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="welcome_title">Welcome Title:</label>
                        <input type="text" id="welcome_title" name="welcome_title" class="form-control"
                               value="{{ form.welcome_title.data or 'Welcome to Yonca' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="subtitle">Subtitle:</label>
                        <textarea id="subtitle" name="subtitle" class="form-control" rows="2">{{ form.subtitle.data or 'Your gateway to knowledge and community learning.' }}</textarea>
                    </div>

                    <div class="form-group-inline">
                        <label for="get_started_text">Button Text:</label>
                        <input type="text" id="get_started_text" name="get_started_text" class="form-control"
                               value="{{ form.get_started_text.data or 'Get Started' }}">
                    </div>
                </div>

                <!-- Logged Out Content -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-users"></i> Logged Out Users</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="logged_out_welcome_title">Welcome Title:</label>
                        <input type="text" id="logged_out_welcome_title" name="logged_out_welcome_title" class="form-control"
                               value="{{ form.logged_out_welcome_title.data or 'Welcome to Yonca' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="logged_out_subtitle">Subtitle:</label>
                        <textarea id="logged_out_subtitle" name="logged_out_subtitle" class="form-control" rows="2">{{ form.logged_out_subtitle.data or 'Join our learning community today!' }}</textarea>
                    </div>

                    <div class="form-group-inline">
                        <label for="logged_out_get_started_text">Button Text:</label>
                        <input type="text" id="logged_out_get_started_text" name="logged_out_get_started_text" class="form-control"
                               value="{{ form.logged_out_get_started_text.data or 'Sign Up Now' }}">
                    </div>
                </div>

                <!-- Features Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-star"></i> Features</h4>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-feature">
                            <i class="fa fa-plus"></i> Add Feature
                        </button>
                    </div>

                    <div id="features-container">
                        <!-- Features will be dynamically added here -->
                    </div>
                </div>

                <!-- Logged Out Features Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-users"></i> Logged Out Features</h4>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-logged-out-feature">
                            <i class="fa fa-plus"></i> Add Feature
                        </button>
                    </div>

                    <div id="logged-out-features-container">
                        <!-- Logged out features will be dynamically added here -->
                    </div>
                </div>

                <!-- Gallery Images Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-images"></i> Gallery Images</h4>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-gallery-image">
                            <i class="fa fa-plus"></i> Add Image
                        </button>
                    </div>

                    <div id="gallery-container">
                        <!-- Gallery images will be dynamically added here -->
                    </div>
                </div>

                <!-- Site Branding Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-building"></i> Site Branding</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="site_name">Site Name:</label>
                        <input type="text" id="site_name" name="site_name" class="form-control"
                               value="{{ form.site_name.data or 'Yonca' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="site_logo_file">Site Logo:</label>
                        <div class="file-upload-group">
                            <input type="file" id="site_logo_file" name="site_logo_file" class="form-control-file" accept="image/*">
                            <button type="button" class="btn btn-sm btn-primary" onclick="uploadLogo()" id="upload_logo_btn">Upload Logo</button>
                            <span id="logo_upload_status" class="ml-2"></span>
                            {% if home_content.site_logo_url %}
                            <div class="mt-2">
                                <small class="text-success">âœ“ Current logo:</small><br>
                                <img src="{{ home_content.site_logo_url }}" alt="Current logo" style="max-width: 100px; max-height: 100px; border: 1px solid #ddd;">
                            </div>
                            {% else %}
                            <div class="mt-2">
                                <small class="text-muted">No logo uploaded</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Navigation Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-bars"></i> Navigation Menu</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-nav-item">
                                <i class="fa fa-plus"></i> Add Menu Item
                            </button>
                        </div>
                    </div>

                    <div id="navigation-container">
                        <!-- Navigation items will be dynamically added here -->
                    </div>
                </div>

                <!-- Courses Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-graduation-cap"></i> Courses Section</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="courses_section_title">Section Title:</label>
                        <input type="text" id="courses_section_title" name="courses_section_title" class="form-control"
                               value="{{ form.courses_section_title.data or 'Courses' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="courses_section_description">Section Description:</label>
                        <textarea id="courses_section_description" name="courses_section_description" class="form-control" rows="3">{{ form.courses_section_description.data or 'Explore our comprehensive course offerings designed to enhance your skills and knowledge.' }}</textarea>
                    </div>
                </div>

                <!-- Forum Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-comments"></i> Forum Section</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="forum_section_title">Section Title:</label>
                        <input type="text" id="forum_section_title" name="forum_section_title" class="form-control"
                               value="{{ form.forum_section_title.data or 'Forum' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="forum_section_description">Section Description:</label>
                        <textarea id="forum_section_description" name="forum_section_description" class="form-control" rows="3">{{ form.forum_section_description.data or 'Join our community discussions and connect with fellow learners and experts.' }}</textarea>
                    </div>
                </div>

                <!-- Resources Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-book"></i> Resources Section</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="resources_section_title">Section Title:</label>
                        <input type="text" id="resources_section_title" name="resources_section_title" class="form-control"
                               value="{{ form.resources_section_title.data or 'Resources' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="resources_section_description">Section Description:</label>
                        <textarea id="resources_section_description" name="resources_section_description" class="form-control" rows="3">{{ form.resources_section_description.data or 'Access valuable learning materials, guides, and tools to support your educational journey.' }}</textarea>
                    </div>
                </div>

                <!-- TAVI Test Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-clipboard-check"></i> TAVI Test Section</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="tavi_test_section_title">Section Title:</label>
                        <input type="text" id="tavi_test_section_title" name="tavi_test_section_title" class="form-control"
                               value="{{ form.tavi_test_section_title.data or 'TAVI Test' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="tavi_test_section_description">Section Description:</label>
                        <textarea id="tavi_test_section_description" name="tavi_test_section_description" class="form-control" rows="3">{{ form.tavi_test_section_description.data or 'Take our comprehensive assessment to evaluate your current knowledge level and get personalized learning recommendations.' }}</textarea>
                    </div>
                </div>

                <!-- Contacts Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-address-book"></i> Contacts Section</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="contacts_section_title">Section Title:</label>
                        <input type="text" id="contacts_section_title" name="contacts_section_title" class="form-control"
                               value="{{ form.contacts_section_title.data or 'Contacts' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="contacts_section_description">Section Description:</label>
                        <textarea id="contacts_section_description" name="contacts_section_description" class="form-control" rows="3">{{ form.contacts_section_description.data or 'Get in touch with us for support, inquiries, or collaboration opportunities.' }}</textarea>
                    </div>
                </div>

                <!-- About Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-info-circle"></i> About Section</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="about_section_title">Section Title:</label>
                        <input type="text" id="about_section_title" name="about_section_title" class="form-control"
                               value="{{ form.about_section_title.data or 'About' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="about_section_description">Section Description:</label>
                        <textarea id="about_section_description" name="about_section_description" class="form-control" rows="3">{{ form.about_section_description.data or 'Learn more about our mission, vision, and the team behind Yonca.' }}</textarea>
                    </div>
                </div>

                <button type="submit" class="btn-save">
                    <i class="fa fa-save"></i> Save Changes
                </button>
            </form>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <div class="preview-header" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                <h4 style="margin: 0;"><i class="fa fa-eye"></i> Live Preview</h4>
                <small class="text-muted">See your changes in real-time</small>
            </div>
            <div class="preview-content" style="padding: 20px; height: calc(100% - 60px); overflow-y: auto;">
                <!-- Logged In Preview -->
                <div id="logged-in-preview" style="margin-bottom: 30px;">
                    <h5 style="color: #28a745; margin-bottom: 15px;"><i class="fa fa-user"></i> Logged In View</h5>
                    <div class="live-preview">
                        <div class="preview-title" id="preview-welcome-title">
                            {{ form.welcome_title.data or 'Welcome to Yonca' }}
                        </div>
                        <div class="preview-subtitle" id="preview-subtitle">
                            {{ form.subtitle.data or 'Your gateway to knowledge and community learning.' }}
                        </div>
                        <button class="preview-button">
                            <span id="preview-get-started">{{ form.get_started_text.data or 'Get Started' }}</span>
                        </button>

                        <div class="preview-features">
                            {% if home_content.features %}
                            {% for feature in home_content.features %}
                            <div class="preview-feature">
                                <div class="feature-title">{{ feature.title }}</div>
                                <div class="feature-desc">{{ feature.description }}</div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Logged Out Preview -->
                <div id="logged-out-preview">
                    <h5 style="color: #dc3545; margin-bottom: 15px;"><i class="fa fa-users"></i> Logged Out View</h5>
                    <div class="live-preview">
                        <div class="preview-title" id="preview-logged-out-welcome-title">
                            {{ form.logged_out_welcome_title.data or 'Welcome to Yonca' }}
                        </div>
                        <div class="preview-subtitle" id="preview-logged-out-subtitle">
                            {{ form.logged_out_subtitle.data or 'Join our learning community today!' }}
                        </div>
                        <button class="preview-button">
                            <span id="preview-logged-out-get-started">{{ form.logged_out_get_started_text.data or 'Sign Up Now' }}</span>
                        </button>

                        <div class="preview-features">
                            {% if home_content.logged_out_features %}
                            {% for feature in home_content.logged_out_features %}
                            <div class="preview-feature">
                                <div class="feature-title">{{ feature.title }}</div>
                                <div class="feature-desc">{{ feature.description }}</div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Track unsaved changes
let hasUnsavedChanges = false;

function markUnsaved() {
    hasUnsavedChanges = true;
    document.getElementById('unsaved-indicator').style.display = 'block';
}

// Add change listeners to all form inputs
document.addEventListener('DOMContentLoaded', function() {
    // Track changes
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', markUnsaved);
    });

    // Reset changes
    document.getElementById('reset-changes').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all changes?')) {
            location.reload();
        }
    });

    // Show keyboard shortcuts
    document.getElementById('show-shortcuts').addEventListener('click', function() {
        const shortcuts = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000; max-width: 400px;">
                <h4 style="margin-top: 0;"><i class="fa fa-keyboard-o"></i> Keyboard Shortcuts</h4>
                <div style="margin-bottom: 15px;">
                    <strong>Ctrl+S</strong> - Save changes<br>
                    <strong>Ctrl+Z</strong> - Reset all changes<br>
                    <strong>Ctrl+P</strong> - Toggle preview mode<br>
                    <strong>Drag & Drop</strong> - Reorder features
                </div>
                <button class="btn btn-primary" onclick="this.parentElement.remove()">Close</button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', shortcuts);
    });

    // Preview mode toggle
    document.getElementById('preview-mode').addEventListener('click', function() {
        const editorPanel = document.querySelector('.editor-panel');
        const previewPanel = document.querySelector('.preview-panel');

        if (editorPanel.style.display === 'none') {
            editorPanel.style.display = 'block';
            previewPanel.style.flex = '1';
            this.innerHTML = '<i class="fa fa-eye"></i> Preview Mode';
        } else {
            editorPanel.style.display = 'none';
            previewPanel.style.flex = '1';
            this.innerHTML = '<i class="fa fa-edit"></i> Edit Mode';
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+S to save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            console.log('ADMIN: Saving changes via Ctrl+S shortcut');
            document.getElementById('content-form').submit();
        }

        // Ctrl+Z to reset (with confirmation)
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            if (confirm('Reset all changes? (Ctrl+Z)')) {
                location.reload();
            }
        }

        // Ctrl+P for preview mode
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            document.getElementById('preview-mode').click();
        }
    });

// Add form submit logging
    document.getElementById('content-form').addEventListener('submit', function(e) {
        console.log('ADMIN: Submitting home page changes...');
        console.log('ADMIN: Form data will be processed by server');
        
        // Log all form data
        const formData = new FormData(this);
        console.log('ADMIN: Form data contents:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: "${value}"`);
        }
        
        // Don't prevent default - let the form submit normally
    });

    // Log admin session start
    console.log('ADMIN: Home page editor loaded');
    console.log('ADMIN: Current user: {{ current_user.username }} (ID: {{ current_user.id }})');
    console.log('ADMIN: Available shortcuts: Ctrl+S (Save), Ctrl+Z (Reset), Ctrl+P (Preview)');

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        }
    });

    // Update logged in preview
    document.getElementById('welcome_title').addEventListener('input', function() {
        document.getElementById('preview-welcome-title').textContent = this.value || 'Welcome to Yonca';
    });

    document.getElementById('subtitle').addEventListener('input', function() {
        document.getElementById('preview-subtitle').textContent = this.value || 'Your gateway to knowledge and community learning.';
    });

    document.getElementById('get_started_text').addEventListener('input', function() {
        document.getElementById('preview-get-started').textContent = this.value || 'Get Started';
    });

    // Update logged out preview
    document.getElementById('logged_out_welcome_title').addEventListener('input', function() {
        document.getElementById('preview-logged-out-welcome-title').textContent = this.value || 'Welcome to Yonca';
    });

    document.getElementById('logged_out_subtitle').addEventListener('input', function() {
        document.getElementById('preview-logged-out-subtitle').textContent = this.value || 'Join our learning community today!';
    });

    document.getElementById('logged_out_get_started_text').addEventListener('input', function() {
        document.getElementById('preview-logged-out-get-started').textContent = this.value || 'Sign Up Now';
    });

    // Initialize features from server data
    initializeFeatures();

    // Add feature buttons
    document.getElementById('add-feature').addEventListener('click', function() {
        addFeature('features-container', 'feature');
    });

    document.getElementById('add-logged-out-feature').addEventListener('click', function() {
        addFeature('logged-out-features-container', 'logged_out_feature');
    });

    // Add navigation item button
    document.getElementById('add-nav-item').addEventListener('click', function() {
        addNavigationItem('navigation-container', 'nav');
    });

    // Add gallery image button
    document.getElementById('add-gallery-image').addEventListener('click', function() {
        addGalleryImage('gallery-container', 'gallery');
    });

    // Make features sortable
    makeSortable('features-container');
    makeSortable('logged-out-features-container');
    makeSortable('navigation-container');
    makeSortable('gallery-container');
});

function initializeFeatures() {
    // Initialize logged in features
    {% if home_content.features %}
    {% for feature in home_content.features %}
    addFeatureFromData('features-container', 'feature', {{ feature.title|tojson }}, {{ feature.description|tojson }});
    {% endfor %}
    {% endif %}

    // Initialize logged out features
    {% if home_content.logged_out_features %}
    {% for feature in home_content.logged_out_features %}
    addFeatureFromData('logged-out-features-container', 'logged_out_feature', {{ feature.title|tojson }}, {{ feature.description|tojson }});
    {% endfor %}
    {% endif %}

    // Initialize navigation items
    {% if home_content.navigation_items %}
    {% for nav_item in home_content.navigation_items %}
    addNavigationItemFromData('navigation-container', 'nav', {{ nav_item.name|tojson }}, {{ nav_item.url|tojson }});
    {% endfor %}
    {% endif %}

    // Initialize gallery images
    {% if home_content.gallery_images %}
    {% for image in home_content.gallery_images %}
    addGalleryImageFromData('gallery-container', 'gallery', {{ image.url|tojson }}, {{ image.alt|tojson }}, {{ image.caption|tojson }});
    {% endfor %}
    {% endif %}
}

function addFeature(containerId, prefix) {
    const container = document.getElementById(containerId);
    const featureIndex = container.children.length;

    const featureDiv = document.createElement('div');
    featureDiv.className = 'feature-item';
    featureDiv.draggable = true;
    featureDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline">
            <label>Title:</label>
            <input type="text" name="${prefix}_title_${featureIndex}" class="form-control feature-title"
                   placeholder="Feature title" value="">
        </div>
        <div class="form-group-inline">
            <label>Description:</label>
            <textarea name="${prefix}_desc_${featureIndex}" class="form-control feature-desc" rows="2"
                      placeholder="Feature description"></textarea>
        </div>
    `;

    container.appendChild(featureDiv);

    // Add event listeners
    featureDiv.querySelector('.remove-feature').addEventListener('click', function() {
        featureDiv.remove();
        updatePreviewFeatures();
    });

    featureDiv.querySelector('.feature-title').addEventListener('input', updatePreviewFeatures);
    featureDiv.querySelector('.feature-desc').addEventListener('input', updatePreviewFeatures);

    updatePreviewFeatures();
}

function addFeatureFromData(containerId, prefix, title, description) {
    const container = document.getElementById(containerId);
    const featureIndex = container.children.length;

    // Escape quotes for HTML attributes
    const escapedTitle = title.replace(/"/g, '&quot;');
    const escapedDescription = description.replace(/"/g, '&quot;');

    const featureDiv = document.createElement('div');
    featureDiv.className = 'feature-item';
    featureDiv.draggable = true;
    featureDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline">
            <label>Title:</label>
            <input type="text" name="${prefix}_title_${featureIndex}" class="form-control feature-title"
                   placeholder="Feature title" value="${escapedTitle}">
        </div>
        <div class="form-group-inline">
            <label>Description:</label>
            <textarea name="${prefix}_desc_${featureIndex}" class="form-control feature-desc" rows="2"
                      placeholder="Feature description">${escapedDescription}</textarea>
        </div>
    `;

    container.appendChild(featureDiv);

    // Add event listeners
    featureDiv.querySelector('.remove-feature').addEventListener('click', function() {
        featureDiv.remove();
        updatePreviewFeatures();
    });

    featureDiv.querySelector('.feature-title').addEventListener('input', updatePreviewFeatures);
    featureDiv.querySelector('.feature-desc').addEventListener('input', updatePreviewFeatures);
}

function makeSortable(containerId) {
    const container = document.getElementById(containerId);
    let draggedElement = null;
    let placeholder = null;
    let isDragging = false;

    // Create placeholder element
    function createPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'feature-placeholder';
        placeholder.innerHTML = '<i class="fa fa-plus"></i> Drop feature here';
        return placeholder;
    }

    container.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('feature-item')) {
            draggedElement = e.target;
            isDragging = true;

            // Add dragging class for better visual feedback
            draggedElement.classList.add('dragging');

            // Create and insert placeholder
            placeholder = createPlaceholder();
            draggedElement.parentNode.insertBefore(placeholder, draggedElement.nextSibling);

            // Hide the dragged element
            setTimeout(() => {
                draggedElement.style.display = 'none';
            }, 0);
        }
    });

    container.addEventListener('dragend', function(e) {
        if (draggedElement && isDragging) {
            draggedElement.classList.remove('dragging');
            draggedElement.style.display = '';
            isDragging = false;

            // Remove placeholder
            if (placeholder && placeholder.parentNode) {
                placeholder.parentNode.removeChild(placeholder);
            }

            draggedElement = null;
            placeholder = null;
            updatePreviewFeatures();
        }
    });

    container.addEventListener('dragover', function(e) {
        e.preventDefault();
        if (!isDragging || !draggedElement) return;

        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
            // Move placeholder to end
            if (placeholder && placeholder !== container.lastChild) {
                container.appendChild(placeholder);
            }
        } else {
            // Move placeholder before the target element
            if (placeholder && placeholder !== afterElement.previousSibling) {
                container.insertBefore(placeholder, afterElement);
            }
        }
    });

    // Handle drop
    container.addEventListener('drop', function(e) {
        e.preventDefault();
        if (!isDragging || !draggedElement || !placeholder) return;

        // Insert dragged element where placeholder is
        container.insertBefore(draggedElement, placeholder);

        // Clean up
        draggedElement.classList.remove('dragging');
        draggedElement.style.display = '';
        if (placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
        }

        draggedElement = null;
        placeholder = null;
        isDragging = false;
        updatePreviewFeatures();
    });

    // Touch support for mobile
    let touchStartY = 0;
    let touchStartX = 0;

    container.addEventListener('touchstart', function(e) {
        if (e.target.closest('.drag-handle')) {
            const featureItem = e.target.closest('.feature-item');
            if (featureItem) {
                touchStartY = e.touches[0].clientY;
                touchStartX = e.touches[0].clientX;
                draggedElement = featureItem;
                isDragging = true;

                draggedElement.classList.add('dragging');
                placeholder = createPlaceholder();
                draggedElement.parentNode.insertBefore(placeholder, draggedElement.nextSibling);
                setTimeout(() => {
                    draggedElement.style.display = 'none';
                }, 0);
            }
        }
    });

    container.addEventListener('touchmove', function(e) {
        if (!isDragging || !draggedElement) return;

        e.preventDefault();
        const touch = e.touches[0];
        const afterElement = getDragAfterElement(container, touch.clientY);

        if (afterElement == null) {
            if (placeholder && placeholder !== container.lastChild) {
                container.appendChild(placeholder);
            }
        } else {
            if (placeholder && placeholder !== afterElement.previousSibling) {
                container.insertBefore(placeholder, afterElement);
            }
        }
    });

    container.addEventListener('touchend', function(e) {
        if (!isDragging || !draggedElement) return;

        // Insert dragged element where placeholder is
        if (placeholder) {
            container.insertBefore(draggedElement, placeholder);
        }

        // Clean up
        draggedElement.classList.remove('dragging');
        draggedElement.style.display = '';
        if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
        }

        draggedElement = null;
        placeholder = null;
        isDragging = false;
        updatePreviewFeatures();
    });
}

// Gallery Image Functions
function addGalleryImage(containerId, prefix) {
    const container = document.getElementById(containerId);
    const imageIndex = container.children.length;

    const imageDiv = document.createElement('div');
    imageDiv.className = 'feature-item gallery-item';
    imageDiv.draggable = true;
    imageDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline">
            <label>Image File:</label>
            <input type="file" name="${prefix}_file_${imageIndex}" class="form-control gallery-file"
                   accept="image/*" required>
        </div>
        <div class="form-group-inline">
            <label>Alt Text:</label>
            <input type="text" name="${prefix}_alt_${imageIndex}" class="form-control gallery-alt"
                   placeholder="Image description" value="">
        </div>
        <div class="form-group-inline">
            <label>Caption:</label>
            <input type="text" name="${prefix}_caption_${imageIndex}" class="form-control gallery-caption"
                   placeholder="Image caption" value="">
        </div>
    `;

    container.appendChild(imageDiv);

    // Add event listeners
    imageDiv.querySelector('.remove-feature').addEventListener('click', function() {
        imageDiv.remove();
    });
}

function addGalleryImageFromData(containerId, prefix, url, alt, caption) {
    const container = document.getElementById(containerId);
    const imageIndex = container.children.length;

    // Escape quotes for HTML attributes
    const escapedAlt = alt.replace(/"/g, '&quot;');
    const escapedCaption = caption.replace(/"/g, '&quot;');

    const imageDiv = document.createElement('div');
    imageDiv.className = 'feature-item gallery-item';
    imageDiv.draggable = true;
    imageDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline" style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
            <small style="color: #6c757d;"><i class="fa fa-info-circle"></i> Image already uploaded: <code>${url}</code></small>
        </div>
        <div class="form-group-inline">
            <label>Alt Text:</label>
            <input type="text" name="${prefix}_alt_${imageIndex}" class="form-control gallery-alt"
                   placeholder="Image description" value="${escapedAlt}">
        </div>
        <div class="form-group-inline">
            <label>Caption:</label>
            <input type="text" name="${prefix}_caption_${imageIndex}" class="form-control gallery-caption"
                   placeholder="Image caption" value="${escapedCaption}">
        </div>
    `;

    container.appendChild(imageDiv);

    // Add event listeners
    imageDiv.querySelector('.remove-feature').addEventListener('click', function() {
        imageDiv.remove();
    });
}

// Navigation Item Functions
function addNavigationItem(containerId, prefix) {
    const container = document.getElementById(containerId);
    const navIndex = container.children.length;

    const navDiv = document.createElement('div');
    navDiv.className = 'feature-item nav-item';
    navDiv.draggable = true;
    navDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline">
            <label>Title:</label>
            <input type="text" name="${prefix}_title_${navIndex}" class="form-control nav-title"
                   placeholder="Menu item title" value="">
        </div>
        <div class="form-group-inline">
            <label>URL:</label>
            <input type="url" name="${prefix}_url_${navIndex}" class="form-control nav-url"
                   placeholder="https://example.com or /page" value="">
        </div>
    `;

    container.appendChild(navDiv);

    // Add event listeners
    navDiv.querySelector('.remove-feature').addEventListener('click', function() {
        navDiv.remove();
    });
}

function addNavigationItemFromData(containerId, prefix, title, url) {
    const container = document.getElementById(containerId);
    const navIndex = container.children.length;

    // Escape quotes for HTML attributes
    const escapedTitle = title.replace(/"/g, '&quot;');
    const escapedUrl = url.replace(/"/g, '&quot;');

    const navDiv = document.createElement('div');
    navDiv.className = 'feature-item nav-item';
    navDiv.draggable = true;
    navDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline">
            <label>Title:</label>
            <input type="text" name="${prefix}_title_${navIndex}" class="form-control nav-title"
                   placeholder="Menu item title" value="${escapedTitle}">
        </div>
        <div class="form-group-inline">
            <label>URL:</label>
            <input type="url" name="${prefix}_url_${navIndex}" class="form-control nav-url"
                   placeholder="https://example.com or /page" value="${escapedUrl}">
        </div>
    `;

    container.appendChild(navDiv);

    // Add event listeners
    navDiv.querySelector('.remove-feature').addEventListener('click', function() {
        navDiv.remove();
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.feature-item:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updatePreviewFeatures() {
    // Update logged in features preview
    const loggedInFeatures = document.querySelectorAll('#features-container .feature-item');
    const loggedInPreview = document.querySelector('#logged-in-preview .preview-features');
    loggedInPreview.innerHTML = '';

    loggedInFeatures.forEach(feature => {
        const title = feature.querySelector('.feature-title').value;
        const desc = feature.querySelector('.feature-desc').value;

        if (title || desc) {
            const featureDiv = document.createElement('div');
            featureDiv.className = 'preview-feature';
            featureDiv.innerHTML = `
                <div class="feature-title">${title || 'Feature Title'}</div>
                <div class="feature-desc">${desc || 'Feature description'}</div>
            `;
            loggedInPreview.appendChild(featureDiv);
        }
    });

    // Update logged out features preview
    const loggedOutFeatures = document.querySelectorAll('#logged-out-features-container .feature-item');
    const loggedOutPreview = document.querySelector('#logged-out-preview .preview-features');
    loggedOutPreview.innerHTML = '';

    loggedOutFeatures.forEach(feature => {
        const title = feature.querySelector('.feature-title').value;
        const desc = feature.querySelector('.feature-desc').value;

        if (title || desc) {
            const featureDiv = document.createElement('div');
            featureDiv.className = 'preview-feature';
            featureDiv.innerHTML = `
                <div class="feature-title">${title || 'Feature Title'}</div>
                <div class="feature-desc">${desc || 'Feature description'}</div>
            `;
            loggedOutPreview.appendChild(featureDiv);
        }
    });
}

// Logo upload function
function uploadLogo() {
    const fileInput = document.getElementById('site_logo_file');
    const uploadBtn = document.getElementById('upload_logo_btn');
    const statusSpan = document.getElementById('logo_upload_status');
    const fileUploadGroup = fileInput.closest('.file-upload-group');

    if (!fileInput.files[0]) {
        statusSpan.textContent = 'Please select a file first';
        statusSpan.className = 'ml-2 text-warning';
        return;
    }

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    uploadBtn.disabled = true;
    statusSpan.textContent = 'Uploading...';
    statusSpan.className = 'ml-2 text-info';

    fetch('/api/logo/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update or create hidden input to store the logo URL
            let hiddenInput = fileUploadGroup.querySelector('input[type="hidden"][name="site_logo_url"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'site_logo_url';
                fileUploadGroup.appendChild(hiddenInput);
            }
            hiddenInput.value = data.image_url;

            // Update status and show preview
            statusSpan.textContent = 'Upload successful!';
            statusSpan.className = 'ml-2 text-success';

            // Update the status div
            const statusDiv = fileUploadGroup.querySelector('.mt-2');
            statusDiv.innerHTML = `
                <small class="text-success">âœ“ Logo uploaded</small>
                <br>
                <img src="${data.image_url}" alt="Site logo" style="max-width: 100px; max-height: 100px; border: 1px solid #ddd;">
            `;

            // Clear file input
            fileInput.value = '';
        } else {
            statusSpan.textContent = 'Upload failed: ' + data.error;
            statusSpan.className = 'ml-2 text-danger';
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        statusSpan.textContent = 'Upload failed';
        statusSpan.className = 'ml-2 text-danger';
    })
    .finally(() => {
        uploadBtn.disabled = false;
    });
}
</script>
{% endblock %}