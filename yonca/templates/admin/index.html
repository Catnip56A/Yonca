{% extends 'admin/master.html' %}
{% block head %}
{{ super() }}
<style>
    .builder-container {
        display: flex;
        height: calc(100vh - 200px);
        gap: 20px;
    }
    .editor-panel {
        flex: 1;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
    }
    .preview-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        overflow: hidden;
    }
    .preview-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }
    .content-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background: white;
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .section-title {
        font-weight: bold;
        color: #495057;
    }
    .form-group-inline {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .form-group-inline label {
        min-width: 120px;
        font-weight: 500;
    }
    .form-group-inline input,
    .form-group-inline textarea {
        flex: 1;
    }
    .btn-save {
        background: #337a2c;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-save:hover {
        background: #809c13;
    }
    .live-preview {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-top: 10px;
    }
    .preview-title {
        color: #337a2c;
        font-size: 1.5em;
        margin-bottom: 10px;
    }
    .preview-subtitle {
        color: #6c757d;
        margin-bottom: 15px;
    }
    .preview-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin: 3rem 0;
    }
    .preview-feature {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .preview-feature:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    .feature-title {
        color: #337a2c;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
    }
    .feature-desc {
        color: #6c757d;
        font-size: 1rem;
    }
    .feature-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    .feature-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #337a2c;
    }
    .feature-item.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .feature-placeholder {
        background: #e9ecef;
        border: 2px dashed #337a2c;
        border-radius: 8px;
        height: 60px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-style: italic;
    }
    .toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 10px 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .toolbar .btn {
        padding: 6px 12px;
        font-size: 0.9em;
    }
    .unsaved-changes {
        background: #fff3cd;
        color: #856404;
        padding: 8px 16px;
        border-radius: 4px;
        border: 1px solid #ffeaa7;
        display: none;
        margin-bottom: 15px;
    }
    .feature-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .drag-handle {
        cursor: move;
        color: #6c757d;
        padding: 5px;
        border-radius: 3px;
        transition: background-color 0.2s;
    }
    .drag-handle:hover {
        background-color: #f8f9fa;
    }
    .remove-feature {
        padding: 4px 8px;
    }
    .remove-feature:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .builder-container {
            flex-direction: column;
            height: auto;
            gap: 15px;
        }

        .editor-panel, .preview-panel {
            flex: none;
            height: 50vh;
            min-height: 400px;
        }

        .content-section {
            margin-bottom: 15px;
            padding: 12px;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .form-group-inline {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .form-group-inline label {
            margin-bottom: 0;
        }

        .btn {
            min-height: 44px;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .form-control {
            min-height: 44px;
            font-size: 16px; /* Prevent zoom on iOS */
            margin-bottom: 0.5rem;
        }

        .table-responsive {
            font-size: 0.9rem;
        }

        .card {
            margin-bottom: 1rem;
        }

        .gallery-preview {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .gallery-item {
            padding: 8px;
        }

        .gallery-item img {
            max-width: 100%;
            height: auto;
        }
    }

    @media (max-width: 480px) {
        .editor-panel, .preview-panel {
            height: 40vh;
            min-height: 300px;
        }

        .content-section {
            padding: 10px;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .gallery-preview {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div style="margin-bottom: 20px;">
                <a href="/" class="btn btn-success" style="float: right;">
                    <i class="fa fa-home"></i> Return to Site
                </a>
            </div>
            <h1><i class="fa fa-magic"></i> Home Page Builder</h1>
            <p class="text-muted">Design your home page with our intuitive drag-and-drop builder</p>
        </div>
    </div>

    <div class="toolbar">
        <div class="unsaved-changes" id="unsaved-indicator">
            <i class="fa fa-exclamation-triangle"></i> You have unsaved changes
        </div>
        <div class="google-drive-status" id="google-drive-status">
            {% if current_user.google_access_token %}
                <div class="alert alert-success" style="display: inline-block; padding: 8px 16px; margin: 0;">
                    <i class="fa fa-google"></i> Google Drive Connected
                </div>
            {% else %}
                <div class="alert alert-warning" style="display: inline-block; padding: 8px 16px; margin: 0;">
                    <i class="fa fa-google"></i> Google Drive Not Connected
                    <a href="{{ url_for('google_login.index') }}" class="btn btn-sm btn-primary" style="margin-left: 10px;">
                        Connect Now
                    </a>
                </div>
            {% endif %}
        </div>
        <div style="margin-left: auto;">
            <button type="button" class="btn btn-outline-success" id="translate-all" title="Translate All Content">
                <i class="fa fa-language"></i> Translate Content
            </button>
            <button type="button" class="btn btn-outline-danger" id="delete-translations" title="Delete All Translations">
                <i class="fa fa-trash"></i> Delete Translations
            </button>
            <button type="button" class="btn btn-outline-info" id="show-shortcuts" title="Keyboard Shortcuts">
                <i class="fa fa-keyboard-o"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="reset-changes">
                <i class="fa fa-undo"></i> Reset
            </button>
            <button type="button" class="btn btn-outline-primary" id="preview-mode">
                <i class="fa fa-eye"></i> Preview Mode
            </button>
        </div>
    </div>
        <!-- Editor Panel -->
        <div class="editor-panel">
            <h3><i class="fa fa-edit"></i> Content Editor</h3>

            <form method="post" id="content-form" enctype="multipart/form-data">
                {{ form.hidden_tag() }}

                <!-- Logged In / Logged Out welcome fields removed per request -->

                <!-- Features Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-star"></i> Features</h4>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div style="display:flex; flex-direction:column; margin-right:10px;">
                                <label style="font-weight:600;">Title:</label>
                                <input type="text" id="features_title" name="features_title" class="form-control" value="{{ form.features_title.data or 'Our Features' }}">
                            </div>
                            <div style="display:flex; flex-direction:column;">
                                <label style="font-weight:600;">Subtitle:</label>
                                <textarea id="features_subtitle" name="features_subtitle" class="form-control" rows="1">{{ form.features_subtitle.data or 'Discover what makes our platform special.' }}</textarea>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-feature">
                                <i class="fa fa-plus"></i> Add Feature
                            </button>
                        </div>
                    </div>

                    <div id="features-container">
                        <!-- Features will be dynamically added here -->
                    </div>
                </div>

                <!-- Logged Out Features Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-users"></i> Logged Out Features</h4>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-logged-out-feature">
                            <i class="fa fa-plus"></i> Add Feature
                        </button>
                    </div>

                    <div id="logged-out-features-container">
                        <!-- Logged out features will be dynamically added here -->
                    </div>
                </div>

                <!-- What's New Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-star"></i> What's New (Images, Videos, YouTube, Vimeo)</h4>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-gallery-image">
                            <i class="fa fa-plus"></i> Add Media
                        </button>
                    </div>

                    <div id="gallery-container">
                        <!-- What's New media will be dynamically added here -->
                    </div>
                </div>

                <!-- Site Branding Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h4 class="section-title"><i class="fa fa-building"></i> Site Branding</h4>
                    </div>

                    <div class="form-group-inline">
                        <label for="site_name">Site Name:</label>
                        <input type="text" id="site_name" name="site_name" class="form-control"
                               value="{{ form.site_name.data or 'Yonca' }}">
                    </div>

                    <div class="form-group-inline">
                        <label for="site_logo_file">Site Logo:</label>
                        <div class="file-upload-group">
                            <input type="file" id="site_logo_file" name="site_logo_file" class="form-control-file" accept="image/*">
                            {% if home_content.site_logo_url %}
                            <div class="mt-2">
                                <small class="text-success">✓ Current logo:</small><br>
                                <img src="{{ home_content.site_logo_url }}" alt="Current logo" style="max-width: 100px; max-height: 100px; border: 1px solid #ddd;">
                            </div>
                            {% else %}
                            <div class="mt-2">
                                <small class="text-muted">No logo uploaded</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-save">
                    <i class="fa fa-save"></i> Save Changes
                </button>
            </form>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <div class="preview-header" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                <h4 style="margin: 0;"><i class="fa fa-eye"></i> Live Preview</h4>
                <small class="text-muted">See your changes in real-time</small>
            </div>
            <div class="preview-content" style="padding: 20px; height: calc(100% - 60px); overflow-y: auto;">
                <!-- Previews: welcome title/subtitle/button removed; keeping feature previews -->
                <div id="preview-features-container">
                    <h5 style="color: #28a745; margin-bottom: 8px;"><i class="fa fa-user"></i> <span id="preview-features-title">{{ form.features_title.data or home_content.features_title or 'Our Features' }}</span></h5>
                    <div id="preview-features-subtitle" style="color: #6c757d; margin-bottom: 12px;">{{ form.features_subtitle.data or home_content.features_subtitle or 'Discover what makes our platform special.' }}</div>
                    <div class="live-preview">
                        <div class="preview-features">
                            {% if home_content.features %}
                            {% for feature in home_content.features %}
                            <div class="preview-feature">
                                <div class="feature-title">{{ feature.title }}</div>
                                <div class="feature-desc">{{ feature.description }}</div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% if home_content.logged_out_features %}
                        <h5 style="color: #dc3545; margin-top: 1.5rem;">Logged Out Features</h5>
                        <div class="preview-features">
                            {% for feature in home_content.logged_out_features %}
                            <div class="preview-feature">
                                <div class="feature-title">{{ feature.title }}</div>
                                <div class="feature-desc">{{ feature.description }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="features-data" data-features='{{ home_content.features|tojson }}' data-logged-out-features='{{ home_content.logged_out_features|tojson }}' data-gallery-images='{{ home_content.gallery_images|tojson }}' style="display: none;"></div>

<script>
// Track unsaved changes
let hasUnsavedChanges = false;

function markUnsaved() {
    hasUnsavedChanges = true;
    document.getElementById('unsaved-indicator').style.display = 'block';
}

// Add change listeners to all form inputs
document.addEventListener('DOMContentLoaded', function() {
    // Track changes
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', markUnsaved);
    });

    // Reset changes
    document.getElementById('reset-changes').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all changes?')) {
            location.reload();
        }
    });

    // Show keyboard shortcuts
    document.getElementById('show-shortcuts').addEventListener('click', function() {
        const shortcuts = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000; max-width: 400px;">
                <h4 style="margin-top: 0;"><i class="fa fa-keyboard-o"></i> Keyboard Shortcuts</h4>
                <div style="margin-bottom: 15px;">
                    <strong>Ctrl+S</strong> - Save changes<br>
                    <strong>Ctrl+Z</strong> - Reset all changes<br>
                    <strong>Ctrl+P</strong> - Toggle preview mode<br>
                    <strong>Drag & Drop</strong> - Reorder features
                </div>
                <button class="btn btn-primary" onclick="this.parentElement.remove()">Close</button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', shortcuts);
    });

    // Preview mode toggle
    document.getElementById('preview-mode').addEventListener('click', function() {
        const editorPanel = document.querySelector('.editor-panel');
        const previewPanel = document.querySelector('.preview-panel');

        if (editorPanel.style.display === 'none') {
            editorPanel.style.display = 'block';
            previewPanel.style.flex = '1';
            this.innerHTML = '<i class="fa fa-eye"></i> Preview Mode';
        } else {
            editorPanel.style.display = 'none';
            previewPanel.style.flex = '1';
            this.innerHTML = '<i class="fa fa-edit"></i> Edit Mode';
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+S to save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            console.log('ADMIN: Saving changes via Ctrl+S shortcut');
            document.getElementById('content-form').submit();
        }

        // Ctrl+Z to reset (with confirmation)
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            if (confirm('Reset all changes? (Ctrl+Z)')) {
                location.reload();
            }
        }

        // Ctrl+P for preview mode
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            document.getElementById('preview-mode').click();
        }
    });

// Add form submit logging
    document.getElementById('content-form').addEventListener('submit', function(e) {
        console.log('ADMIN: Submitting home page changes...');
        console.log('ADMIN: Form data will be processed by server');
        
        // Log all form data
        const formData = new FormData(this);
        console.log('ADMIN: Form data contents:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: "${value}"`);
        }
        
        // Don't prevent default - let the form submit normally
    });

    // Log admin session start
    console.log('ADMIN: Home page editor loaded');
    console.log('ADMIN: Current user: {{ current_user.username }} (ID: {{ current_user.id }})');
    console.log('ADMIN: Available shortcuts: Ctrl+S (Save), Ctrl+Z (Reset), Ctrl+P (Preview)');

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        }
    });

    // Welcome/title/button fields removed; no preview listeners required

    // Initialize features from server data
    initializeFeatures();

    // Features title/subtitle preview sync
    const featuresTitleInput = document.getElementById('features_title');
    const featuresSubtitleInput = document.getElementById('features_subtitle');
    if (featuresTitleInput) {
        featuresTitleInput.addEventListener('input', function() {
            const el = document.getElementById('preview-features-title');
            if (el) el.textContent = this.value || 'Our Features';
        });
    }
    if (featuresSubtitleInput) {
        featuresSubtitleInput.addEventListener('input', function() {
            const el = document.getElementById('preview-features-subtitle');
            if (el) el.textContent = this.value || 'Discover what makes our platform special.';
        });
    }

    // Add feature buttons
    document.getElementById('add-feature').addEventListener('click', function() {
        addFeature('features-container', 'feature');
    });

    document.getElementById('add-logged-out-feature').addEventListener('click', function() {
        addFeature('logged-out-features-container', 'logged_out_feature');
    });

    // Add gallery image button
    document.getElementById('add-gallery-image').addEventListener('click', function() {
        addGalleryImage('gallery-container', 'gallery');
    });

    // Make features sortable
    makeSortable('features-container');
    makeSortable('logged-out-features-container');
    makeSortable('gallery-container');
});

function initializeFeatures() {
    const featuresData = document.getElementById('features-data');
    const features = JSON.parse(featuresData.dataset.features || '[]');
    const loggedOutFeatures = JSON.parse(featuresData.dataset.loggedOutFeatures || '[]');
    const galleryImages = JSON.parse(featuresData.dataset.galleryImages || '[]');

    // Initialize logged in features
    features.forEach(feature => {
        addFeatureFromData('features-container', 'feature', feature.title || '', feature.description || '', feature.button_text || '', feature.button_url || '');
    });

    // Initialize logged out features
    loggedOutFeatures.forEach(feature => {
        addFeatureFromData('logged-out-features-container', 'logged_out_feature', feature.title || '', feature.description || '', feature.button_text || '', feature.button_url || '');
    });

    // Initialize What's New media
    galleryImages.forEach(image => {
        addGalleryImageFromData('gallery-container', 'gallery', image.url || '', image.alt || '', image.caption || '');
    });
}

function addFeature(containerId, prefix) {
    const container = document.getElementById(containerId);
    const featureIndex = container.children.length;

    const featureDiv = document.createElement('div');
    featureDiv.className = 'feature-item';
    featureDiv.draggable = true;
    featureDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_title_${featureIndex}">Title:</label>
            <input type="text" id="${prefix}_title_${featureIndex}" name="${prefix}_title_${featureIndex}" class="form-control feature-title"
                   placeholder="Feature title" value="">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_desc_${featureIndex}">Description:</label>
            <textarea id="${prefix}_desc_${featureIndex}" name="${prefix}_desc_${featureIndex}" class="form-control feature-desc" rows="2"
                      placeholder="Feature description"></textarea>
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_button_text_${featureIndex}">Button Text:</label>
            <input type="text" id="${prefix}_button_text_${featureIndex}" name="${prefix}_button_text_${featureIndex}" class="form-control feature-button-text"
                   placeholder="e.g. Learn More" value="">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_button_url_${featureIndex}">Button URL:</label>
            <input type="url" id="${prefix}_button_url_${featureIndex}" name="${prefix}_button_url_${featureIndex}" class="form-control feature-button-url"
                   placeholder="/courses/1 or https://..." value="">
        </div>
    `;

    container.appendChild(featureDiv);

    // Add event listeners
    featureDiv.querySelector('.remove-feature').addEventListener('click', function() {
        featureDiv.remove();
        updatePreviewFeatures();
    });

    featureDiv.querySelector('.feature-title').addEventListener('input', updatePreviewFeatures);
    featureDiv.querySelector('.feature-desc').addEventListener('input', updatePreviewFeatures);

    updatePreviewFeatures();
}

function addFeatureFromData(containerId, prefix, title, description, buttonText = '', buttonUrl = '') {
    const container = document.getElementById(containerId);
    const featureIndex = container.children.length;

    // Escape quotes for HTML attributes
    const escapedTitle = title.replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/`/g, '&#96;').replace(/\$\{/g, '\\${');
    const escapedDescription = description.replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/`/g, '&#96;').replace(/\$\{/g, '\\${');
    const escapedButtonText = buttonText.replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/`/g, '&#96;').replace(/\$\{/g, '\\${');
    const escapedButtonUrl = buttonUrl.replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/`/g, '&#96;').replace(/\$\{/g, '\\${');

    console.log('addFeatureFromData:', { title, description, buttonText, buttonUrl, escapedTitle, escapedDescription, escapedButtonText, escapedButtonUrl });

    const featureDiv = document.createElement('div');
    featureDiv.className = 'feature-item';
    featureDiv.draggable = true;
    featureDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_title_${featureIndex}">Title:</label>
                 <input type="text" id="${prefix}_title_${featureIndex}" name="${prefix}_title_${featureIndex}" class="form-control feature-title"
                     placeholder="Feature title" value="${escapedTitle}">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_desc_${featureIndex}">Description:</label>
            <textarea id="${prefix}_desc_${featureIndex}" name="${prefix}_desc_${featureIndex}" class="form-control feature-desc" rows="2"
                      placeholder="Feature description">${escapedDescription}</textarea>
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_button_text_${featureIndex}">Button Text:</label>
            <input type="text" id="${prefix}_button_text_${featureIndex}" name="${prefix}_button_text_${featureIndex}" class="form-control feature-button-text"
                   placeholder="e.g. Learn More" value="${escapedButtonText}">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_button_url_${featureIndex}">Button URL:</label>
            <input type="url" id="${prefix}_button_url_${featureIndex}" name="${prefix}_button_url_${featureIndex}" class="form-control feature-button-url"
                   placeholder="/courses/1 or https://..." value="${escapedButtonUrl}">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_button_text_${featureIndex}">Button Text:</label>
            <input type="text" id="${prefix}_button_text_${featureIndex}" name="${prefix}_button_text_${featureIndex}" class="form-control feature-button-text"
                   placeholder="e.g. Learn More" value="">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_button_url_${featureIndex}">Button URL:</label>
            <input type="url" id="${prefix}_button_url_${featureIndex}" name="${prefix}_button_url_${featureIndex}" class="form-control feature-button-url"
                   placeholder="/courses/1 or https://..." value="">
        </div>
    `;

    container.appendChild(featureDiv);

    // Add event listeners
    featureDiv.querySelector('.remove-feature').addEventListener('click', function() {
        featureDiv.remove();
        updatePreviewFeatures();
    });

    featureDiv.querySelector('.feature-title').addEventListener('input', updatePreviewFeatures);
    featureDiv.querySelector('.feature-desc').addEventListener('input', updatePreviewFeatures);
}

function makeSortable(containerId) {
    const container = document.getElementById(containerId);
    let draggedElement = null;
    let placeholder = null;
    let isDragging = false;

    // Create placeholder element
    function createPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'feature-placeholder';
        placeholder.innerHTML = '<i class="fa fa-plus"></i> Drop feature here';
        return placeholder;
    }

    container.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('feature-item')) {
            draggedElement = e.target;
            isDragging = true;

            // Add dragging class for better visual feedback
            draggedElement.classList.add('dragging');

            // Create and insert placeholder
            placeholder = createPlaceholder();
            draggedElement.parentNode.insertBefore(placeholder, draggedElement.nextSibling);

            // Hide the dragged element
            setTimeout(() => {
                draggedElement.style.display = 'none';
            }, 0);
        }
    });

    container.addEventListener('dragend', function(e) {
        if (draggedElement && isDragging) {
            draggedElement.classList.remove('dragging');
            draggedElement.style.display = '';
            isDragging = false;

            // Remove placeholder
            if (placeholder && placeholder.parentNode) {
                placeholder.parentNode.removeChild(placeholder);
            }

            draggedElement = null;
            placeholder = null;
            updatePreviewFeatures();
        }
    });

    container.addEventListener('dragover', function(e) {
        e.preventDefault();
        if (!isDragging || !draggedElement) return;

        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
            // Move placeholder to end
            if (placeholder && placeholder !== container.lastChild) {
                container.appendChild(placeholder);
            }
        } else {
            // Move placeholder before the target element
            if (placeholder && placeholder !== afterElement.previousSibling) {
                container.insertBefore(placeholder, afterElement);
            }
        }
    });

    // Handle drop
    container.addEventListener('drop', function(e) {
        e.preventDefault();
        if (!isDragging || !draggedElement || !placeholder) return;

        // Insert dragged element where placeholder is
        container.insertBefore(draggedElement, placeholder);

        // Clean up
        draggedElement.classList.remove('dragging');
        draggedElement.style.display = '';
        if (placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
        }

        draggedElement = null;
        placeholder = null;
        isDragging = false;
        updatePreviewFeatures();
    });

    // Touch support for mobile
    let touchStartY = 0;
    let touchStartX = 0;

    container.addEventListener('touchstart', function(e) {
        if (e.target.closest('.drag-handle')) {
            const featureItem = e.target.closest('.feature-item');
            if (featureItem) {
                touchStartY = e.touches[0].clientY;
                touchStartX = e.touches[0].clientX;
                draggedElement = featureItem;
                isDragging = true;

                draggedElement.classList.add('dragging');
                placeholder = createPlaceholder();
                draggedElement.parentNode.insertBefore(placeholder, draggedElement.nextSibling);
                setTimeout(() => {
                    draggedElement.style.display = 'none';
                }, 0);
            }
        }
    });

    container.addEventListener('touchmove', function(e) {
        if (!isDragging || !draggedElement) return;

        e.preventDefault();
        const touch = e.touches[0];
        const afterElement = getDragAfterElement(container, touch.clientY);

        if (afterElement == null) {
            if (placeholder && placeholder !== container.lastChild) {
                container.appendChild(placeholder);
            }
        } else {
            if (placeholder && placeholder !== afterElement.previousSibling) {
                container.insertBefore(placeholder, afterElement);
            }
        }
    });

    container.addEventListener('touchend', function(e) {
        if (!isDragging || !draggedElement) return;

        // Insert dragged element where placeholder is
        if (placeholder) {
            container.insertBefore(draggedElement, placeholder);
        }

        // Clean up
        draggedElement.classList.remove('dragging');
        draggedElement.style.display = '';
        if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
        }

        draggedElement = null;
        placeholder = null;
        isDragging = false;
        updatePreviewFeatures();
    });
}

// Gallery Image Functions
function addGalleryImage(containerId, prefix) {
    const container = document.getElementById(containerId);
    const imageIndex = container.children.length;

    const imageDiv = document.createElement('div');
    imageDiv.className = 'feature-item gallery-item';
    imageDiv.draggable = true;
    imageDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Choose input type:</label>
            <div style="display: flex; gap: 10px;">
                <label><input type="radio" name="input_type_${imageIndex}" value="file" checked> Upload File</label>
                <label><input type="radio" name="input_type_${imageIndex}" value="url"> Enter URL</label>
            </div>
        </div>
        <div class="file-input-group">
            <div class="form-group-inline">
                <label for="${prefix}_file_${imageIndex}">Media File:</label>
                <input type="file" id="${prefix}_file_${imageIndex}" name="${prefix}_file_${imageIndex}" class="form-control gallery-file"
                       accept="image/*,video/*" required>
            </div>
        </div>
        <div class="url-input-group" style="display: none;">
            <div class="form-group-inline">
                <label for="${prefix}_url_${imageIndex}">Media URL:</label>
                <input type="url" id="${prefix}_url_${imageIndex}" name="${prefix}_url_${imageIndex}" class="form-control gallery-url"
                       placeholder="https://youtube.com/watch?v=... or https://drive.google.com/file/d/... or direct video URL" value="">
            </div>
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_alt_${imageIndex}">Alt Text:</label>
            <input type="text" id="${prefix}_alt_${imageIndex}" name="${prefix}_alt_${imageIndex}" class="form-control gallery-alt"
                   placeholder="Image description" value="">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_caption_${imageIndex}">Caption:</label>
            <input type="text" id="${prefix}_caption_${imageIndex}" name="${prefix}_caption_${imageIndex}" class="form-control gallery-caption"
                   placeholder="Image caption" value="">
        </div>
    `;

    container.appendChild(imageDiv);

    // Add radio button event listeners
    const fileRadio = imageDiv.querySelector(`input[name="input_type_${imageIndex}"][value="file"]`);
    const urlRadio = imageDiv.querySelector(`input[name="input_type_${imageIndex}"][value="url"]`);
    const fileGroup = imageDiv.querySelector('.file-input-group');
    const urlGroup = imageDiv.querySelector('.url-input-group');
    const fileInput = imageDiv.querySelector('.gallery-file');
    const urlInput = imageDiv.querySelector('.gallery-url');

    fileRadio.addEventListener('change', function() {
        fileGroup.style.display = 'block';
        urlGroup.style.display = 'none';
        fileInput.required = true;
        urlInput.required = false;
    });

    urlRadio.addEventListener('change', function() {
        fileGroup.style.display = 'none';
        urlGroup.style.display = 'block';
        fileInput.required = false;
        urlInput.required = true;
    });

    // Add event listeners
    imageDiv.querySelector('.remove-feature').addEventListener('click', function() {
        imageDiv.remove();
    });
}

function addGalleryImageFromData(containerId, prefix, url, alt, caption) {
    const container = document.getElementById(containerId);
    const imageIndex = container.children.length;

    // Escape quotes for HTML attributes
    const escapedAlt = alt.replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/`/g, '&#96;').replace(/\$\{/g, '\\${');
    const escapedCaption = caption.replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/`/g, '&#96;').replace(/\$\{/g, '\\${');
    const escapedUrl = url.replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/`/g, '&#96;').replace(/\$\{/g, '\\${');

    const imageDiv = document.createElement('div');
    imageDiv.className = 'feature-item gallery-item';
    imageDiv.draggable = true;
    imageDiv.innerHTML = `
        <div class="feature-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="drag-handle" style="cursor: move; color: #6c757d;"><i class="fa fa-grip-vertical"></i></span>
            <button type="button" class="btn btn-sm btn-outline-danger remove-feature">
                <i class="fa fa-trash"></i>
            </button>
        </div>
        <div class="form-group-inline" style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
            <small style="color: #6c757d;"><i class="fa fa-info-circle"></i> Image already uploaded: <code>${escapedUrl}</code></small>
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_alt_${imageIndex}">Alt Text:</label>
            <input type="text" id="${prefix}_alt_${imageIndex}" name="${prefix}_alt_${imageIndex}" class="form-control gallery-alt"
                   placeholder="Image description" value="${escapedAlt}">
        </div>
        <div class="form-group-inline">
            <label for="${prefix}_caption_${imageIndex}">Caption:</label>
            <input type="text" id="${prefix}_caption_${imageIndex}" name="${prefix}_caption_${imageIndex}" class="form-control gallery-caption"
                   placeholder="Image caption" value="${escapedCaption}">
        </div>
    `;

    container.appendChild(imageDiv);

    // Add event listeners
    imageDiv.querySelector('.remove-feature').addEventListener('click', function() {
        imageDiv.remove();
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.feature-item:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updatePreviewFeatures() {
    // Update logged in features preview
    const loggedInFeatures = document.querySelectorAll('#features-container .feature-item');
    const loggedInPreview = document.querySelector('#logged-in-preview .preview-features');
    loggedInPreview.innerHTML = '';

    loggedInFeatures.forEach(feature => {
        const title = feature.querySelector('.feature-title').value;
        const desc = feature.querySelector('.feature-desc').value;
        const btnText = feature.querySelector('.feature-button-text') ? feature.querySelector('.feature-button-text').value : '';
        const btnUrl = feature.querySelector('.feature-button-url') ? feature.querySelector('.feature-button-url').value : '';

        console.log('updatePreviewFeatures loggedIn:', { title, desc, btnText, btnUrl });

        if (title || desc) {
            const featureDiv = document.createElement('div');
            featureDiv.className = 'preview-feature';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'feature-title';
            titleDiv.textContent = title || 'Feature Title';
            featureDiv.appendChild(titleDiv);
            
            const descDiv = document.createElement('div');
            descDiv.className = 'feature-desc';
            descDiv.textContent = desc || 'Feature description';
            featureDiv.appendChild(descDiv);
            
            if (btnText) {
                const btnDiv = document.createElement('div');
                btnDiv.style.marginTop = '8px';
                const link = document.createElement('a');
                link.href = btnUrl || '#';
                link.className = 'feature-btn';
                link.target = '_blank';
                link.textContent = btnText;
                btnDiv.appendChild(link);
                featureDiv.appendChild(btnDiv);
            }
            
            loggedInPreview.appendChild(featureDiv);
        }
    });

    // Update logged out features preview
    const loggedOutFeatures = document.querySelectorAll('#logged-out-features-container .feature-item');
    const loggedOutPreview = document.querySelector('#logged-out-preview .preview-features');
    loggedOutPreview.innerHTML = '';

    loggedOutFeatures.forEach(feature => {
        const title = feature.querySelector('.feature-title').value;
        const desc = feature.querySelector('.feature-desc').value;
        const btnText = feature.querySelector('.feature-button-text') ? feature.querySelector('.feature-button-text').value : '';
        const btnUrl = feature.querySelector('.feature-button-url') ? feature.querySelector('.feature-button-url').value : '';

        console.log('updatePreviewFeatures loggedOut:', { title, desc, btnText, btnUrl });

        if (title || desc) {
            const featureDiv = document.createElement('div');
            featureDiv.className = 'preview-feature';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'feature-title';
            titleDiv.textContent = title || 'Feature Title';
            featureDiv.appendChild(titleDiv);
            
            const descDiv = document.createElement('div');
            descDiv.className = 'feature-desc';
            descDiv.textContent = desc || 'Feature description';
            featureDiv.appendChild(descDiv);
            
            if (btnText) {
                const btnDiv = document.createElement('div');
                btnDiv.style.marginTop = '8px';
                const link = document.createElement('a');
                link.href = btnUrl || '#';
                link.className = 'feature-btn';
                link.target = '_blank';
                link.textContent = btnText;
                btnDiv.appendChild(link);
                featureDiv.appendChild(btnDiv);
            }
            
            loggedOutPreview.appendChild(featureDiv);
        }
    });
}

// Translation button handler with background job processing
document.getElementById('translate-all').addEventListener('click', async function() {
    const button = this;
    const originalHtml = button.innerHTML;

    if (!confirm('This will translate all courses, resources, and home content to Azerbaijani and Russian. The system will automatically detect the source language of each content piece and create translations for all other languages. This process runs in the background and may take several minutes. Continue?')) {
        return;
    }

    button.disabled = true;
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Queuing translation job...';

    try {
        // Queue the translation job
        const response = await fetch('/admin/translate/translate-content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (result.success) {
            const jobId = result.job_id;
            button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Translation job started...';

            // Poll for job status
            await pollJobStatus(jobId, button, originalHtml);
        } else {
            const escapedError = result.error.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
            alert(`✗ Failed to queue translation job: ${escapedError}`);
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    } catch (error) {
        const escapedMessage = error.message.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
        alert(`✗ Error: ${escapedMessage}`);
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
});

// Function to poll job status
async function pollJobStatus(jobId, button, originalHtml) {
    try {
        const response = await fetch(`/admin/translate/job-status/${jobId}`);
        const result = await response.json();

        if (result.success) {
            const job = result.job;

            if (job.status === 'completed') {
                // Job completed successfully
                const stats = job.result;
                const escapedMessage = job.message.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
                alert(`✓ Translation completed successfully!\n\n${escapedMessage}\n\nProcessed: ${stats.total_processed} items\n- ${stats.courses} courses\n- ${stats.resources} resources\n- ${stats.home_content} home content\n- ${stats.course_content} course items\n- ${stats.folders} folders\n\nRefresh the page to see translated content when changing languages.`);
                button.disabled = false;
                button.innerHTML = originalHtml;
            } else if (job.status === 'failed') {
                // Job failed
                const escapedError = job.error.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
                alert(`✗ Translation failed: ${escapedError}`);
                button.disabled = false;
                button.innerHTML = originalHtml;
            } else {
                // Job still running, update progress and continue polling
                const escapedMessage = job.message.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
                button.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${job.progress}% - ${escapedMessage}`;
                setTimeout(() => pollJobStatus(jobId, button, originalHtml), 2000); // Poll every 2 seconds
            }
        } else {
            const escapedError = result.error.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
            alert(`✗ Failed to check job status: ${escapedError}`);
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    } catch (error) {
        const escapedMessage = error.message.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
        alert(`✗ Error checking job status: ${escapedMessage}`);
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

// Delete translations button handler
document.getElementById('delete-translations').addEventListener('click', async function() {
    const button = this;
    const originalHtml = button.innerHTML;
    
    if (!confirm('⚠️ WARNING: This will permanently delete ALL translations for Azerbaijani and Russian languages!\n\nThis action cannot be undone. Are you sure you want to continue?')) {
        return;
    }
    
    // Double confirmation for destructive action
    if (!confirm('🔴 FINAL WARNING: All translations will be lost and content will display in English only until re-translated.\n\nClick OK to proceed with deletion.')) {
        return;
    }
    
    button.disabled = true;
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Deleting...';
    
    try {
        const response = await fetch('/admin/translate/delete-translations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            const escapedMessage = result.message.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
            alert(`✓ Translations deleted successfully!\n\n${escapedMessage}\n\nContent will now display in English. Use "Translate Content" to re-create translations.`);
        } else {
            const escapedError = result.error.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
            alert(`✗ Deletion failed: ${escapedError}`);
        }
    } catch (error) {
        const escapedMessage = error.message.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
        alert(`✗ Error: ${escapedMessage}`);
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
});


</script>
{% endblock %}