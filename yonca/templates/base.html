<!DOCTYPE html>
<html lang="{{ current_locale or 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ home_content.site_name or 'Yonca' }}{% endblock %}</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ctext y=%270.9em%27 font-size=%2790%27%3E%F0%9F%8D%80%3C/text%3E%3C/svg%3E">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Site-wide styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">

    {% block head %}
    <style>
        /* Active navigation styling */
        .navbar-nav .nav-link.active {
            color: #007bff !important;
            font-weight: bold;
            border-bottom: 2px solid #007bff;
        }
    </style>
    {% endblock %}
</head>
<body>
    {% block content %}{% endblock %}

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    {% block scripts %}
    <!-- Scroll position preservation -->
    <script>
        // Store scroll position before page unload
        window.addEventListener('beforeunload', function() {
            sessionStorage.setItem('scrollPosition', window.scrollY);
        });

        // Restore scroll position after page load
        window.addEventListener('load', function() {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                // Small delay to ensure page is fully rendered
                setTimeout(function() {
                    window.scrollTo(0, parseInt(scrollPosition));
                    sessionStorage.removeItem('scrollPosition');
                }, 100);
            }
        });

        // Also handle browser back/forward navigation
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                const scrollPosition = sessionStorage.getItem('scrollPosition');
                if (scrollPosition) {
                    window.scrollTo(0, parseInt(scrollPosition));
                    sessionStorage.removeItem('scrollPosition');
                }
            }
        });

        // Modify login links to include current URL as next parameter
        document.addEventListener('DOMContentLoaded', function() {
            const loginLinks = document.querySelectorAll('a[href="/login"], button[onclick*="window.location.href=\'/login\'"]');
            loginLinks.forEach(function(link) {
                if (link.tagName === 'A') {
                    const currentUrl = encodeURIComponent(window.location.href);
                    link.href = '/login?next=' + currentUrl;
                } else if (link.tagName === 'BUTTON') {
                    const currentUrl = encodeURIComponent(window.location.href);
                    link.onclick = function() {
                        window.location.href = '/login?next=' + currentUrl;
                    };
                }
            });
        });

        // Navigation state preservation
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link[data-nav]');
            
            // Function to set active navigation item
            function setActiveNav(navKey) {
                // Remove active class from all nav items
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });
                
                // Add active class to the specified nav item
                const activeLink = document.querySelector(`.navbar-nav .nav-link[data-nav="${navKey}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
            }
            
            // Store navigation state when clicking nav links
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const navKey = this.getAttribute('data-nav');
                    sessionStorage.setItem('activeNav', navKey);
                });
            });
            
            // Restore navigation state on page load
            const savedActiveNav = sessionStorage.getItem('activeNav');
            if (savedActiveNav) {
                setActiveNav(savedActiveNav);
            } else {
                // Default to home if no saved state
                setActiveNav('home');
            }
            
            // Also handle URL-based navigation (hash changes)
            function updateNavFromHash() {
                const hash = window.location.hash.substring(1); // Remove the #
                const pathname = window.location.pathname;
                let navKey = 'home'; // Default
                
                // Check if on course description page
                if (pathname.startsWith('/courseDescription/')) {
                    navKey = 'courses';
                } else {
                    // Map hash to nav key
                    switch(hash) {
                        case 'courses':
                            navKey = 'courses';
                            break;
                        case 'forum':
                            navKey = 'forum';
                            break;
                        case 'resources':
                            navKey = 'resources';
                            break;
                        case 'tavi-test':
                            navKey = 'tavi-test';
                            break;
                        case 'contact':
                            navKey = 'contact';
                            break;
                        case 'about':
                            navKey = 'about';
                            break;
                        default:
                            navKey = 'home';
                    }
                }
                
                setActiveNav(navKey);
                sessionStorage.setItem('activeNav', navKey);
            }
            
            // Listen for hash changes
            window.addEventListener('hashchange', updateNavFromHash);
            
            // Set initial state based on current URL
            updateNavFromHash();
        });
    </script>
    {% endblock %}
</body>
</html>