<!DOCTYPE html>
<html lang="{{ current_locale.language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{{ _('Yonca - Learning Platform') }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'OpenDyslexic', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
            letter-spacing: 0.5px;
            color: #212121;
            background-color: #212121;
        }

        canvas {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        header {
            background: #fff6ed;
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            min-height: 80px; /* Ensure minimum height for content */
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
                position: relative; /* For absolute positioning context */
        }

        .nav-section {
            flex: 1;
            display: flex;
            justify-content: center;
            max-width: 600px;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Mobile Menu Styles */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #353e45;
            cursor: pointer;
            padding: 0.5rem;
        }

        .mobile-menu-toggle:hover {
            color: #337a2c;
        }

        nav.mobile-hidden {
            display: none !important;
        }

        /* Mobile Navigation Overlay */
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .mobile-nav-overlay.active {
            display: block;
        }

        .mobile-nav-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1001;
            padding: 2rem 1rem;
            overflow-y: auto;
        }

        .mobile-nav-menu.active {
            right: 0;
        }

        .mobile-nav-menu .nav-link {
            display: block;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
        }

        .mobile-nav-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
        }

        .white-overlay {
            background: #fff6ed;
            min-height: 66vh; /* keep initial visual height but allow expansion */
            height: auto;
            overflow: visible;
            border-radius: 20px;
            padding: 24px; /* give inner content breathing room */
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #337a2c;
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        nav {
            margin-top: 1rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #353e45;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover {
            background-color: #fafbed;
            color: #337a2c;
        }

        .nav-link.active {
            background-color: #337a2c;
            color: #fafbed;
        }

        #auth-buttons button {
            background: white;
            color: #82a302;
            border: 1px solid #82a302;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #auth-buttons button:hover {
            background: #82a302;
            color: white;
        }

        #user-info button {
            background: #dc2626;
            color: white;
            border: 1px solid #dc2626;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #user-info button:hover {
            background: #b91c1c;
        }

        #admin-btn {
            background: #337a2c !important;
            border-color: #337a2c !important;
        }

        #admin-btn:hover {
            background: #2a5a22 !important;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .hero {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #337a2c 0%, #82a302 100%);
            color: white;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .feature-card {
            background: #fff6ed;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .feature-card h3 {
            color: #337a2c;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .gallery-item {
            background: #fff6ed;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            height: 250px;
            display: flex;
            flex-direction: column;
        }

        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
            border-radius: 8px 8px 0 0;
        }

        .gallery-item video, .gallery-item iframe {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
            border-radius: 8px 8px 0 0;
        }

        .gallery-caption {
            padding: 1rem;
            background: #f9fafb;
            text-align: center;
            font-size: 0.9rem;
            color: #353e45;
            border-top: 1px solid #e5e7eb;
        }

        .gallery-section {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
            background: #fff6ed;
            border-radius: 15px;
            padding: 20px;
        }

        #about {
            background: #fff6ed;
            border-radius: 15px;
            padding: 20px;
        }

        .section-title {
            color: #212121;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 700;
        }

        .forum-container {
            background: #fff6ed;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .message-form {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .message-form h3 {
            color: #212121;
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #353e45;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: #337a2c;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background: #809c13;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .forum-message {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .forum-message.current-user {
            border-color: #337a2c;
            background: #f0fdf4;
        }

        .forum-message .user {
            font-weight: 600;
            color: #212121;
            margin-bottom: 0.5rem;
        }

        .forum-message .message-text {
            color: #353e45;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .forum-message .timestamp {
            color: #353e45;
            font-size: 0.875rem;
        }

        .message-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .forum-message .edit-btn,
        .forum-message .delete-btn,
        .forum-message .reply-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .forum-message .edit-btn {
            color: #abc32f;
        }

        .forum-message .edit-btn:hover {
            background-color: rgba(171, 195, 47, 0.1);
        }

        .forum-message .delete-btn {
            color: #dc3545;
        }

        .forum-message .delete-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .forum-message .reply-btn {
            color: #353e45;
        }

        .forum-message .reply-btn:hover {
            background-color: rgba(107, 114, 128, 0.1);
        }

        .forum-message .translate-btn {
            color: white;
        }

        .forum-message .translate-btn:hover {
            background-color: rgba(51, 122, 44, 0.1);
        }

        .auth-message {
            text-align: center;
            padding: 2rem;
            background: #f8fafc;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .auth-message h3 {
            color: #212121;
            margin-bottom: 1rem;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
            align-items: start;
        }

        .resource-card {
            background: #fff6ed;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .resource-card.course-card {
            cursor: pointer;
        }

        .resource-card.course-card:hover .dropdown-indicator {
            color: #2b5a1d;
            transform: translateY(2px);
        }

        .resource-card.course-card.enrolled-course {
            border-left: 4px solid #2b5a1d;
            background: linear-gradient(135deg, rgba(43, 90, 29, 0.08), rgba(43, 90, 29, 0.04));
        }

        .resource-card.course-card.enrolled-course:hover {
            box-shadow: 0 6px 16px rgba(43, 90, 29, 0.15);
            border-left-color: #1e3a0f;
        }

        .dropdown-indicator {
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .dropdown-indicator.active {
            color: #abc32f;
            transform: rotate(180deg);
        }

        .resource-card h4 {
            color: #212121;
            margin-bottom: 0.5rem;
        }

        .resource-card p {
            color: #353e45;
            margin-bottom: 1rem;
        }

        .pdf-access-form {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
            max-width: 500px;
        }

        .pdf-upload-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .pdf-upload-section h3 {
            color: #212121;
            margin-bottom: 1rem;
        }

        .status-message {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-weight: 500;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            header {
                padding: 0.75rem 0;
                min-height: auto; /* Allow flexible height on mobile */
                position: relative;
                min-height: 70px; /* Ensure adequate height for mobile toggle */
            }

            .header-content {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }

            .logo-section {
                justify-content: center;
                order: 1;
            }

            .logo {
                font-size: 1.5rem;
            }

            .logo img {
                height: 40px;
            }

            .nav-section {
                order: 3;
                max-width: none;
            }

            .auth-section {
                order: 2;
                justify-content: center;
                padding: 0.5rem 0;
                border-top: 1px solid #e5e7eb;
                border-bottom: 1px solid #e5e7eb;
                margin: 0.5rem 0;
                background: #f9fafb;
                border-radius: 8px;
            }

            #user-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
            }

            #user-info span {
                margin-right: 0;
                margin-bottom: 0.5rem;
                text-align: center;
            }

            #user-info button {
                width: auto;
                min-width: 80px;
            }

            /* Hide desktop nav, show mobile toggle */
            #main-nav {
                display: none;
            }

            .mobile-menu-container {
                display: block;
                margin-left: auto;
            }

            .mobile-menu-toggle {
                background: #f3f4f6;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                padding: 0.5rem;
                color: #353e45;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .hamburger-icon {
                width: 20px;
                height: 14px;
                position: relative;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .hamburger-icon span {
                display: block;
                height: 2px;
                width: 100%;
                background-color: #353e45;
                border-radius: 1px;
                transition: all 0.3s ease;
            }

            .mobile-menu-toggle:hover .hamburger-icon span {
                background-color: #337a2c;
            }

            .mobile-menu-toggle:hover {
                background: #e5e7eb;
                border-color: #337a2c;
                transform: scale(1.05);
            }

            .mobile-menu-toggle:hover {
                background: #e5e7eb;
                color: #abc32f;
            }

            .mobile-menu-toggle:hover {
                background: #e5e7eb;
                color: #abc32f;
            }

            .hero {
                padding: 2rem 1rem;
                margin: 1rem 0;
                border-radius: 8px;
                background: linear-gradient(135deg, #337a2c 0%, #82a302 100%);
                color: white;
            }

            .hero h1 {
                font-size: 2rem;
                margin-bottom: 0.75rem;
            }

            .hero p {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            .features {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin: 2rem 0;
            }

            .feature-card {
                padding: 1.5rem 1rem;
            }

            .feature-card h3 {
                font-size: 1.25rem;
                margin-bottom: 0.75rem;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin: 2rem 0;
            }

            .gallery-item {
                padding: 1rem;
                height: auto;
                display: block;
            }

            .gallery-caption {
                font-size: 0.9rem;
            }

            .section-title {
                font-size: 1.75rem;
                margin-bottom: 1rem;
            }

            .course-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .course-card {
                padding: 1.5rem;
            }

            .course-card h3 {
                font-size: 1.25rem;
            }

            .forum-post {
                padding: 1rem;
            }

            .forum-post h4 {
                font-size: 1.1rem;
            }

            .message-input {
                margin-bottom: 1rem;
            }

            .message-input textarea {
                min-height: 80px;
            }

            .channel-tabs {
                flex-direction: column;
                gap: 0.25rem;
            }

            .channel-tab {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .contact-info {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin: 2rem 0;
            }

            .contact-item {
                padding: 1.5rem 1rem;
            }

            .contact-item h3 {
                font-size: 1.25rem;
                margin-bottom: 0.75rem;
                color: #80a826;
            }

            /* Touch-friendly buttons */
            button, .btn, .nav-link {
                min-height: 44px;
                min-width: 44px;
            }

            /* Improve readability on small screens */
            body {
                font-size: 16px;
                line-height: 1.5;
            }

            .white-overlay {
                padding: 16px;
                border-radius: 12px;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .hero h1 {
                font-size: 1.75rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .feature-card h3, .contact-item h3 {
                font-size: 1.1rem;
            }

            .auth-section {
                padding: 0.75rem 0.5rem;
            }

            #user-info span {
                font-size: 0.9rem;
            }

            #user-info button {
                font-size: 0.85rem;
                padding: 0.375rem 0.75rem;
                min-width: 70px;
            }

            .mobile-nav-menu {
                width: 100%;
                right: -100%;
                max-width: 320px;
                right: -320px;
            }

            .logo {
                font-size: 1.25rem;
            }

            .logo img {
                height: 35px;
            }
        }

        .contact-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .contact-item {
            background: #fff6ed;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .contact-item h3 {
            color: #80a826;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .channel-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .channel-tab {
            background: #e8f5e8;
            color: #2d5a2d;
            border: 1px solid #c8e6c9;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .channel-tab:hover {
            background: #d4edda;
            border-color: #a8d5a2;
        }

        .channel-tab.active {
            background: #2b5a1d;
            color: #e8f5e8;
            border-color: #2b5a1d;
        }

        .channel-tab.locked {
            background: #fce4ec;
            color: #ad1457;
            border-color: #f8bbd9;
            cursor: not-allowed;
        }

        .channel-tab.locked:hover {
            background: #f8bbd9;
        }

        /* Course dropdown styles */
        .course-card {
            position: relative;
            transition: all 0.3s ease;
            overflow: visible;
        }

        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .course-dropdown {
            margin-top: 15px;
            padding: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .dropdown-item:last-child {
            border-bottom: none !important;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body>
    <canvas></canvas>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <img src="{{ home_content.site_logo_url or 'https://lh3.googleusercontent.com/d/1abc123def456ghi789jkl012mno345pqr/view' }}" alt="Yonca Logo">
                    </div>
                </div>

                <div class="nav-section">
                    <nav id="main-nav">
                        <a href="javascript:void(0)" class="nav-link active" id="home-link">{{ _('Home') }}</a>
                        <a href="javascript:void(0)" class="nav-link" id="courses-link">{{ _('Courses') }}</a>
                        <a href="javascript:void(0)" class="nav-link" id="forum-link">{{ _('Forum') }}</a>
                        <a href="javascript:void(0)" class="nav-link" id="resources-link">{{ _('Resources') }}</a>
                        <a href="javascript:void(0)" class="nav-link" id="tavi-link">{{ _('TAVI Test') }}</a>
                        <a href="javascript:void(0)" class="nav-link" id="contacts-link">{{ _('Contacts') }}</a>
                        <a href="javascript:void(0)" class="nav-link" id="about-link">{{ _('About Company') }}</a>
                    </nav>
                </div>

                <div class="auth-section">
                    <div id="auth-buttons" style="display: block;">
                        <button id="login-btn" onclick="window.location.href='/login'">{{ _('Login') }}</button>
                    </div>
                    <div id="user-info" style="display: none; align-items: center;">
                        <span style="color: #353e45; margin-right: 0.5rem; white-space: nowrap;">{{ _('Welcome') }}, <span id="user-name"></span>!</span>
                        <button id="admin-btn" onclick="window.location.href='/admin'" style="margin-right: 0.25rem; display: none;">{{ _('Admin') }}</button>
                        <button onclick="window.location.href='/logout'">{{ _('Logout') }}</button>
                    </div>
                </div>

                <div class="mobile-menu-container">
                    <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                        <span class="hamburger-icon">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay">
        <div class="mobile-nav-menu" id="mobile-nav-menu">
            <button class="mobile-nav-close" id="mobile-nav-close">
                <i class="fas fa-times"></i>
            </button>
            <a href="javascript:void(0)" class="nav-link active" id="mobile-home-link">{{ _('Home') }}</a>
            <a href="javascript:void(0)" class="nav-link" id="mobile-courses-link">{{ _('Courses') }}</a>
            <a href="javascript:void(0)" class="nav-link" id="mobile-forum-link">{{ _('Forum') }}</a>
            <a href="javascript:void(0)" class="nav-link" id="mobile-resources-link">{{ _('Resources') }}</a>
            <a href="javascript:void(0)" class="nav-link" id="mobile-tavi-link">{{ _('TAVI Test') }}</a>
            <a href="javascript:void(0)" class="nav-link" id="mobile-contacts-link">{{ _('Contacts') }}</a>
            <a href="javascript:void(0)" class="nav-link" id="mobile-about-link">{{ _('About Company') }}</a>
            <div id="mobile-auth-buttons" style="margin-top: 2rem; text-align: center;">
                <button id="mobile-login-btn" onclick="window.location.href='/login'" style="width: 100%; margin-bottom: 0.5rem;">{{ _('Login') }}</button>
            </div>
            <div id="mobile-user-info" style="margin-top: 2rem; text-align: center; display: none;">
                <p style="color: #353e45; margin-bottom: 1rem;">{{ _('Welcome') }}, <span id="mobile-user-name"></span>!</p>
                <button id="mobile-admin-btn" onclick="window.location.href='/admin'" style="width: 100%; margin-bottom: 0.5rem; display: none;">{{ _('Admin') }}</button>
                <button onclick="window.location.href='/logout'" style="width: 100%;">{{ _('Logout') }}</button>
            </div>
        </div>
    </div>

    <main class="container">
        <div class="white-overlay">
        <!-- Home Page -->
        <section id="home" class="page active">
            {% if is_authenticated %}
            <div class="hero">
                <h1>{{ home_content.welcome_title or _('Welcome to Yonca') }}</h1>
                <p>{{ home_content.subtitle or _('Your gateway to knowledge and community learning.') }}</p>
                <p>{{ home_content.get_started_text or _('Get Started') }}</p>
                {% if current_user.is_authenticated and not current_user.google_access_token %}
                <div style="margin-top: 1.5rem;">
                    <a href="{{ url_for('auth.link_google_account') }}" style="display: inline-block; padding: 0.75rem 1.5rem; background: #34a853; color: white; text-decoration: none; border-radius: 6px; font-weight: 500; transition: background-color 0.3s ease;">
                        üîó {{ _('Link Google Account') }}
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="features">
                {% if home_content.features %}
                {% for feature in home_content.features %}
                <div class="feature-card">
                    <h3>{{ feature.title }}</h3>
                    <p>{{ feature.description }}</p>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            {% else %}
            <div class="hero">
                <h1>{{ home_content.logged_out_welcome_title or _('Welcome to Yonca') }}</h1>
                <p>{{ home_content.logged_out_subtitle or _('Join our learning community today!') }}</p>
                <p>{{ home_content.logged_out_get_started_text or _('Sign Up Now') }}</p>
            </div>

            <div class="features">
                {% if home_content.logged_out_features %}
                {% for feature in home_content.logged_out_features %}
                <div class="feature-card">
                    <h3>{{ feature.title }}</h3>
                    <p>{{ feature.description }}</p>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Gallery Section -->
            <div class="gallery-section">
                <h2 class="section-title" style="color: #80a826;">{{ _('What\'s New') }}</h2>
                <p>{{ _('Discover the latest updates, new features, and exciting developments in our learning platform.') }}</p>

                <div class="gallery-grid">
                    {% if home_content.gallery_images %}
                    {% for image in home_content.gallery_images %}
                    <div class="gallery-item">
                        {% if image.url %}
                        {% if 'youtube.com' in image.url or 'youtu.be' in image.url %}
                        {% set video_id = '' %}
                        {% if 'youtube.com/watch?v=' in image.url %}
                        {% set video_id = image.url.split('v=')[1].split('&')[0] %}
                        {% elif 'youtu.be/' in image.url %}
                        {% set video_id = image.url.split('youtu.be/')[1].split('?')[0] %}
                        {% endif %}
                        <iframe width="100%" height="250" 
                                src="https://www.youtube.com/embed/{{ video_id }}" 
                                frameborder="0" allowfullscreen
                                style="border-radius: 8px; max-width: 100%;"></iframe>
                        {% elif 'vimeo.com' in image.url %}
                        {% set video_id = image.url.split('vimeo.com/')[1].split('?')[0] %}
                        <iframe width="100%" height="250" 
                                src="https://player.vimeo.com/video/{{ video_id }}" 
                                frameborder="0" allowfullscreen
                                style="border-radius: 8px; max-width: 100%;"></iframe>
                        {% elif 'drive.google.com' in image.url %}
                        {% set file_id = '' %}
                        {% if '/d/' in image.url %}
                        {% set file_id = image.url.split('/d/')[1].split('/')[0] %}
                        {% elif 'id=' in image.url %}
                        {% set file_id = image.url.split('id=')[1].split('&')[0] %}
                        {% endif %}
                        <iframe src="https://drive.google.com/file/d/{{ file_id }}/preview" 
                                width="100%" height="250" frameborder="0" allowfullscreen
                                style="border-radius: 8px; max-width: 100%;"></iframe>
                        <div class="gallery-caption" style="background: #fff3cd; color: #856404; border-color: #ffeaa7;">
                            <small><i class="fa fa-clock-o"></i> If video shows "still being processed," please wait 5-60 minutes for Google Drive to finish processing, then refresh the page.</small>
                        </div>
                        {% elif image.url.endswith(('.mp4', '.avi', '.mov', '.wmv', '.flv', '.webm', '.mkv', '.mp3', '.wav', '.ogg')) %}
                        <video controls style="width: 100%; height: auto; max-height: 250px;">
                            <source src="{{ image.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% else %}
                        <img src="{{ image.url }}" alt="{{ image.alt }}" loading="lazy">
                        {% endif %}
                        {% else %}
                        <img src="{{ image.url }}" alt="{{ image.alt }}" loading="lazy">
                        {% endif %}
                        {% if image.caption %}
                        <div class="gallery-caption">{{ image.caption }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%23abc32f' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3ELearning Community%3C/text%3E%3C/svg%3E" alt="Learning Community" loading="lazy">
                        <div class="gallery-caption">Our vibrant learning community</div>
                    </div>
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%234a90e2' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3EInteractive Courses%3C/text%3E%3C/svg%3E" alt="Interactive Courses" loading="lazy">
                        <div class="gallery-caption">Engage with interactive course content</div>
                    </div>
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%237ed321' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3EStudy Groups%3C/text%3E%3C/svg%3E" alt="Study Groups" loading="lazy">
                        <div class="gallery-caption">Collaborate in study groups</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Courses Page -->
        <section id="courses" class="page">
            <h2 class="section-title">{{ _('Courses') }}</h2>
            <p>{{ _('Explore our available courses and start your learning journey.') }}</p>

            <!-- Enrolled Courses Section (shown only for authenticated users) -->
            <div id="enrolled-courses-section" style="display: none;">
                <h3 style="color: #80a826; margin-top: 2rem; margin-bottom: 1rem;">{{ _('My Enrolled Courses') }}</h3>
                <div class="courses-grid enrolled-courses-grid">
                    <p style="text-align: center; color: #6b7280; font-style: italic;">{{ _('Loading enrolled courses...') }}</p>
                </div>
            </div>

            <!-- Available Courses Section -->
            <div id="available-courses-section">
                <h3 id="available-courses-title" style="margin-top: 2rem; margin-bottom: 1rem;">{{ _('Available Courses') }}</h3>
                <div class="courses-grid available-courses-grid">
                    <p style="text-align: center; color: #6b7280; font-style: italic;">{{ _('Loading courses...') }}</p>
                </div>
            </div>
        </section>

        <!-- Forum Page -->
        <section id="forum" class="page">
            <h2 class="section-title">{{ _('Community Forum') }}</h2>

            <div id="forum-auth-required" style="display: none;">
                <div class="auth-message">
                    <h3>üîí {{ _('Authentication Required') }}</h3>
                    <p>{{ _('Please log in to participate in the community forum.') }}</p>
                    <p>{{ _('You can still view messages without logging in.') }}</p>
                </div>
            </div>

            <div id="forum-content">
                <!-- Channel Tabs -->
                <div class="channel-tabs" style="margin-bottom: 2rem;">
                    <!-- Tabs will be loaded dynamically -->
                </div>

                <!-- Language Selection for Translation -->
                <div class="language-selector" style="margin-bottom: 2rem; background: #fff6ed; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #212121;">üåê Translation Settings</h4>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label for="target-language" style="font-weight: 500; color: #353e45;">Language:</label>
                            <select id="target-language" onchange="changeTargetLanguage()" style="margin-left: 0.5rem; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="none">Don't translate</option>
                                <option value="en">English</option>
                                <option value="ru">Russian</option>
                                <option value="az">Azerbaijani</option>
                            </select>
                        </div>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">Select a language to translate messages, or choose "Don't translate" to view messages in their original language. Click individual messages to toggle translation.</p>
                </div>

                <div class="message-form">
                    <h3>{{ _('Post a New Message') }}</h3>
                    <form onsubmit="postMessage(event)">
                        <div class="form-group" id="username-group" style="display: none;">
                            <label for="username">{{ _('Username:') }}</label>
                            <input type="text" id="username" name="username">
                        </div>
                        <div class="form-group">
                            <label for="message">{{ _('Message:') }}</label>
                            <textarea id="message" name="message" placeholder="{{ _('Share your thoughts, ask questions, or help others...') }}" required></textarea>
                        </div>
                        <button type="submit" id="post-btn">{{ _('Post Message') }}</button>
                    </form>
                </div>

                <div class="forum-container">
                    <h3 id="channel-title">{{ _('General Discussion') }}</h3>
                    <div id="messages-container">
                        <div class="forum-message">
                            <div class="user">{{ _('Welcome to Yonca Forum!') }}</div>
                            <p>{{ _('This is where community members can connect, ask questions, and share knowledge.') }}</p>
                            <div class="timestamp">{{ _('Posted on December 8, 2025') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Resources Page -->
        <section id="resources" class="page">
            <h2 class="section-title">{{ _('Resources') }}</h2>
            <p>{{ _('Download educational materials, documents, and access protected files.') }}</p>

            <!-- Learning Materials -->
            <h3 style="color: #212121; margin: 2rem 0 1rem 0; font-size: 1.4rem; font-weight: 600;">üìö {{ _('Learning Materials') }}</h3>
            <div class="resources-grid">
                <p style="text-align: center; color: #6b7280; font-style: italic;">{{ _('Loading materials...') }}</p>
            </div>

            <!-- Resource Upload Section (Admin Only) -->
            <div id="resource-upload-section" style="display: none; background: #fff6ed; border-radius: 15px; padding: 20px;">
                <h3 style="color: #212121; margin: 3rem 0 1rem 0; font-size: 1.4rem; font-weight: 600;">üì§ {{ _('Upload Learning Material') }}</h3>
                <p style="color: #6b7280; margin-bottom: 2rem;">{{ _('Upload documents, presentations, PDFs, or other materials. PIN protection will be automatically applied for security.') }}</p>
                <form id="resource-upload-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="resource-title">{{ _('Title:') }}</label>
                        <input type="text" id="resource-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="resource-description">{{ _('Description:') }}</label>
                        <textarea id="resource-description" name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="resource-preview">{{ _('Preview Image (optional):') }}</label>
                        <input type="file" id="resource-preview" name="preview_image" accept="image/*">
                        <small style="color: #6b7280;">{{ _('Upload an image to display as a preview for this resource') }}</small>
                    </div>
                    <div class="form-group">
                        <label for="resource-file">{{ _('Choose file...') }}</label>
                        <input type="file" id="resource-file" name="file" required>
                    </div>
                    <div class="form-group">
                        <p style="font-size: 0.9em; color: #6b7280; margin: 0;">{{ _('Access PIN will be auto-generated (6 characters, expires in 10 minutes)') }}</p>
                    </div>
                    <button type="submit" id="resource-upload-btn">{{ _('Upload Material') }}</button>
                </form>
                <div id="resource-upload-status"></div>
            </div>
        </section>

        <!-- TAVI Test Page -->
        <section id="tavi" class="page">
            <h2 class="section-title">{{ _('TAVI Test') }}</h2>
            <div class="empty-section">
                <p>{{ _('TAVI Test section is coming soon.') }}</p>
            </div>
        </section>

        <!-- Contacts Page -->
        <section id="contacts" class="page">
            <h2 class="section-title">{{ _('Contact Us') }}</h2>

            <div class="contact-info">
                <div class="contact-item">
                    <h3>üì± {{ _('WhatsApp') }}</h3>
                    <p>
                        <a href="https://wa.me/994516237394" target="_blank" style="color: #80a826; text-decoration: none; font-weight: 500;">
                            +994 51 623 73 94
                        </a><br>
                        {{ _('Available: Mon-Fri, 9AM-6PM') }}
                    </p>
                </div>

                <div class="contact-item">
                    <h3>üìß {{ _('Email') }}</h3>
                    <p>
                        <a href="mailto:info@yonca.az" style="color: #80a826; text-decoration: none; font-weight: 500;">
                            info@yonca.az
                        </a><br>
                        {{ _('We respond within 24 hours') }}
                    </p>
                </div>

                <div class="contact-item">
                    <h3>üìç {{ _('Location') }}</h3>
                    <p>
                        <a href="https://www.google.com/maps/place/Yonca+Psixoloji+D%C9%99st%C9%99k+v%C9%99+%C4%B0nki%C5%9Faf+M%C9%99rk%C9%99zi/@40.4023792,49.8405822,17z/data=!3m1!4b1!4m6!3m5!1s0x40307dd1ada7fa99:0x8bfdd1b0bb8989bd!8m2!3d40.4023792!4d49.8405822!16s%2Fg%2F11scbknt07?entry=ttu&g_ep=EgoyMDI1MTIwOS4wIKXMDSoASAFQAw%3D%3D" target="_blank" style="color: #80a826; text-decoration: none; font-weight: 500;">52 Maqsud ∆èlizad…ô</a><br>
                        {{ _('Baku, Azerbaijan') }}
                    </p>
                </div>
            </div>
        </section>

        <!-- About Company Page -->
        <section id="about" class="page">
            <h2 class="section-title">{{ home_content.about_welcome_title or _('Welcome to Yonca') }}</h2>
            <p>{{ home_content.about_subtitle or _('Join our learning community and discover amazing features designed to enhance your educational experience.') }}</p>

            <!-- Features Section -->
            <div class="features-section">
                <h2 class="section-title" style="color: #80a826;">{{ home_content.about_features_title or _('Our Features') }}</h2>
                <p>{{ home_content.about_features_subtitle or _('Discover what makes our platform special.') }}</p>

                <div class="features">
                {% if home_content.about_features %}
                {% for feature in home_content.about_features %}
                <div class="feature-card">
                    <h3>{{ feature.title }}</h3>
                    <p>{{ feature.description }}</p>
                </div>
                {% endfor %}
                {% else %}
                <div class="feature-card">
                    <h3>{{ _('Interactive Courses') }}</h3>
                    <p>{{ _('Engage with dynamic course content and interactive learning materials.') }}</p>
                </div>
                <div class="feature-card">
                    <h3>{{ _('Study Groups') }}</h3>
                    <p>{{ _('Collaborate with fellow learners in our vibrant study communities.') }}</p>
                </div>
                <div class="feature-card">
                    <h3>{{ _('Expert Support') }}</h3>
                    <p>{{ _('Get help from our team of educational experts and specialists.') }}</p>
                </div>
                {% endif %}
            </div>
            </div>

            <!-- Gallery Section -->
            <div class="gallery-section">
                <h2 class="section-title" style="color: #80a826;">{{ home_content.about_gallery_title or _('What\'s New') }}</h2>
                <p>{{ home_content.about_gallery_subtitle or _('Discover the latest updates, new features, and exciting developments in our learning platform.') }}</p>

                <div class="gallery-grid">
                    {% if home_content.about_gallery_images %}
                    {% for image in home_content.about_gallery_images %}
                    <div class="gallery-item">
                        {% if image.url %}
                        {% if 'youtube.com' in image.url or 'youtu.be' in image.url %}
                        {% set video_id = '' %}
                        {% if 'youtube.com/watch?v=' in image.url %}
                        {% set video_id = image.url.split('v=')[1].split('&')[0] %}
                        {% elif 'youtu.be/' in image.url %}
                        {% set video_id = image.url.split('youtu.be/')[1].split('?')[0] %}
                        {% endif %}
                        <iframe width="100%" height="250" 
                                src="https://www.youtube.com/embed/{{ video_id }}" 
                                frameborder="0" allowfullscreen
                                style="border-radius: 8px; max-width: 100%;"></iframe>
                        {% elif 'vimeo.com' in image.url %}
                        {% set video_id = image.url.split('vimeo.com/')[1].split('?')[0] %}
                        <iframe width="100%" height="250" 
                                src="https://player.vimeo.com/video/{{ video_id }}" 
                                frameborder="0" allowfullscreen
                                style="border-radius: 8px; max-width: 100%;"></iframe>
                        {% elif 'drive.google.com' in image.url %}
                        {% set file_id = '' %}
                        {% if '/d/' in image.url %}
                        {% set file_id = image.url.split('/d/')[1].split('/')[0] %}
                        {% elif 'id=' in image.url %}
                        {% set file_id = image.url.split('id=')[1].split('&')[0] %}
                        {% endif %}
                        <iframe src="https://drive.google.com/file/d/{{ file_id }}/preview" 
                                width="100%" height="250" frameborder="0" allowfullscreen
                                style="border-radius: 8px; max-width: 100%;"></iframe>
                        <div class="gallery-caption" style="background: #fff3cd; color: #856404; border-color: #ffeaa7;">
                            <small><i class="fa fa-clock-o"></i> If video shows "still being processed," please wait 5-60 minutes for Google Drive to finish processing, then refresh the page.</small>
                        </div>
                        {% elif image.url.endswith(('.mp4', '.avi', '.mov', '.wmv', '.flv', '.webm', '.mkv', '.mp3', '.wav', '.ogg')) %}
                        <video controls style="width: 100%; height: auto; max-height: 250px;">
                            <source src="{{ image.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        {% else %}
                        <img src="{{ image.url }}" alt="{{ image.alt }}" loading="lazy">
                        {% endif %}
                        {% else %}
                        <img src="{{ image.url }}" alt="{{ image.alt }}" loading="lazy">
                        {% endif %}
                        {% if image.caption %}
                        <div class="gallery-caption">{{ image.caption }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%23abc32f' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3ELearning Community%3C/text%3E%3C/svg%3E" alt="Learning Community" loading="lazy">
                        <div class="gallery-caption">Our vibrant learning community</div>
                    </div>
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%234a90e2' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3EInteractive Courses%3C/text%3E%3C/svg%3E" alt="Interactive Courses" loading="lazy">
                        <div class="gallery-caption">Engage with interactive course content</div>
                    </div>
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%237ed321' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3EStudy Groups%3C/text%3E%3C/svg%3E" alt="Study Groups" loading="lazy">
                        <div class="gallery-caption">Collaborate in study groups</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>
        </div>
    </main>

    <script>
        // API base URL
        const API_BASE = window.location.origin;

        // Current page management
        function showPage(pageId, event) {
            console.log('showPage called with pageId:', pageId, 'event:', event);
            
            // Prevent default if event is provided
            if (event && typeof event.preventDefault === 'function') {
                event.preventDefault();
                console.log('Prevented default event');
            }

            console.log('Hiding all pages...');
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            console.log('Found', pages.length, 'pages');
            pages.forEach(page => {
                page.classList.remove('active');
                console.log('Removed active from page:', page.id);
            });

            console.log('Removing active from all nav links...');
            // Remove active class from all nav links
            const navLinks = document.querySelectorAll('.nav-link');
            console.log('Found', navLinks.length, 'nav links');
            navLinks.forEach(link => {
                link.classList.remove('active');
                console.log('Removed active from link:', link.id);
            });

            // Show selected page
            const pageElement = document.getElementById(pageId);
            const linkElement = document.getElementById(pageId + '-link');
            
            if (pageElement) {
                pageElement.classList.add('active');
                console.log('Activated page:', pageId);
            } else {
                console.error('Page element not found:', pageId);
                return;
            }
            
            if (linkElement) {
                linkElement.classList.add('active');
                console.log('Activated link:', pageId + '-link');
            } else {
                console.error('Link element not found:', pageId + '-link');
            }

            // Load data for specific pages
            if (pageId === 'courses') {
                console.log('Loading courses...');
                loadCourses();
                // Refresh dropdowns in case they were populated before auth check completed
                setTimeout(() => refreshCourseDropdowns(), 100);
            } else if (pageId === 'forum') {
                console.log('Loading forum...');
                loadForumChannels();
            } else if (pageId === 'resources') {
                console.log('Loading resources...');
                loadResources();
            }
            
            console.log('showPage completed for:', pageId);
        }

        // Load courses
        async function loadCourses() {
            // Define translated strings to avoid Jinja2 conflicts in JavaScript
            const enrolledAllCoursesText = "{{ _('You\'re enrolled in all available courses!') }}";
            const errorLoadingCoursesText = "{{ _('Error loading courses. Please try again.') }}";
            const availableCoursesText = "{{ _('Available Courses') }}";
            
            try {
                const response = await fetch(`${API_BASE}/api/courses`, { cache: 'no-store', credentials: 'include' });
                const courses = await response.json();

                // Clear both grids
                const enrolledGrid = document.querySelector('.enrolled-courses-grid');
                const availableGrid = document.querySelector('.available-courses-grid');
                const enrolledSection = document.getElementById('enrolled-courses-section');
                const availableTitle = document.getElementById('available-courses-title');

                enrolledGrid.innerHTML = '';
                availableGrid.innerHTML = '';

                if (courses.length === 0) {
                    availableGrid.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">{{ _("No courses available at the moment.") }}</p>';
                    return;
                }

                // Separate courses based on enrollment status
                let enrolledCourses = [];
                let availableCourses = [];

                if (window.currentUser) {
                    // For authenticated users, separate enrolled and available courses
                    enrolledCourses = courses.filter(course => course.is_enrolled);
                    availableCourses = courses.filter(course => !course.is_enrolled);

                    // Show enrolled courses section if user has enrolled courses
                    if (enrolledCourses.length > 0) {
                        enrolledSection.style.display = 'block';
                        availableTitle.textContent = '{{ _("Other Available Courses") }}';
                    } else {
                        enrolledSection.style.display = 'none';
                        availableTitle.textContent = '{{ _("Available Courses") }}';

                    }
                } else {
                    // For non-authenticated users, all courses are "available"
                    availableCourses = courses;
                    enrolledSection.style.display = 'none';
                    availableTitle.textContent = availableCoursesText;
                }

                // Render enrolled courses
                if (enrolledCourses.length > 0) {
                    enrolledCourses.forEach(course => {
                        const courseCard = createCourseCard(course, true); // true = enrolled
                        enrolledGrid.appendChild(courseCard);
                    });
                }

                // Render available courses
                if (availableCourses.length > 0) {
                    availableCourses.forEach(course => {
                        const courseCard = createCourseCard(course, false); // false = not enrolled
                        availableGrid.appendChild(courseCard);
                    });
                } else if (window.currentUser && enrolledCourses.length > 0) {
                    availableGrid.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">' + enrolledAllCoursesText + '</p>';
                }

            } catch (error) {
                console.error('Error loading courses:', error);
                document.querySelector('.available-courses-grid').innerHTML = '<p style="text-align: center; color: #dc2626;">' + errorLoadingCoursesText + '</p>';
            }
        }

        // Create course card with enrollment styling
        function createCourseCard(course, isEnrolled) {
            const courseCard = document.createElement('div');
            courseCard.className = `resource-card course-card ${isEnrolled ? 'enrolled-course' : ''}`;
            courseCard.style.cursor = 'pointer';

            const enrolledBadge = isEnrolled ? '<span style="background: #28a84e; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">‚úì ENROLLED</span>' : '';

            // Only show dropdown elements for non-enrolled users
            const dropdownElements = isEnrolled ? '' : `
                <div style="margin-top: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <span>${course.profile_emoji || 'üìö'}</span>
                    <span class="dropdown-indicator" style="font-size: 14px; color: #6b7280; margin-left: 8px;">‚ñº</span>
                </div>
                <div class="course-dropdown" style="display: none;"></div>
            `;

            courseCard.innerHTML = `
                <h4>${course.title} ${enrolledBadge}</h4>
                <p>${course.description}</p>
                <p><strong>Time Slot:</strong> ${course.time_slot || 'TBD'}</p>
                ${dropdownElements}
            `;

            // Add special styling for enrolled courses
            if (isEnrolled) {
                courseCard.style.borderLeft = '4px solid #2b5a1d';
                courseCard.style.background = 'linear-gradient(135deg, rgba(43, 90, 29, 0.08), rgba(43, 90, 29, 0.04))';
            }

            // Add action button for enrolled users
            if (isEnrolled) {
                const actionBtn = document.createElement('a');
                actionBtn.textContent = 'Go to Course';
                actionBtn.href = `/course/${course.title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '').trim()}`;
                actionBtn.style.background = '#337a2c';
                actionBtn.style.color = '#e8f5e8';
                actionBtn.style.textDecoration = 'none';
                actionBtn.style.border = '1px solid #337a2c';
                actionBtn.style.padding = '0.5rem 1rem';
                actionBtn.style.borderRadius = '4px';
                actionBtn.style.fontWeight = '500';
                actionBtn.style.display = 'inline-block';
                actionBtn.style.marginTop = '0.5rem';
                courseCard.appendChild(actionBtn);
            }

            // Make course card clickable
            courseCard.addEventListener('click', function(e) {
                e.stopPropagation();
                const courseSlug = course.title.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '')
                    .trim();
                if (window.currentUser && isEnrolled) {
                    window.location.href = `/course/${courseSlug}`;
                    return;
                }
                // For non-enrolled users, open dropdown instead of redirect
                if (!isEnrolled) {
                    const dropdown = this.querySelector('.course-dropdown');
                    const indicator = this.querySelector('.dropdown-indicator');
                    // Hide other dropdowns
                    document.querySelectorAll('.course-dropdown').forEach(d => {
                        if (d !== dropdown) {
                            d.style.display = 'none';
                            d.closest('.course-card').querySelector('.dropdown-indicator').classList.remove('active');
                        }
                    });
                    // Toggle this dropdown
                    if (dropdown.style.display === 'none') {
                        dropdown.style.display = 'block';
                        indicator.classList.add('active');
                        populateCourseDropdown(dropdown, course, isEnrolled);
                    } else {
                        dropdown.style.display = 'none';
                        indicator.classList.remove('active');
                    }
                }
            });

            return courseCard;
        }

        // Populate course dropdown menu
        function populateCourseDropdown(dropdown, course, isEnrolled = false) {
            dropdown.innerHTML = '';

            let menuItems = [];

            // Check if user authentication has been determined
            // If window.currentUser is undefined, it means checkUser() hasn't completed yet
            if (typeof window.currentUser === 'undefined') {
                // Authentication check still pending - show loading or default state
                const courseSlug = course.title.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '')
                    .trim();
                menuItems = [
                    { text: '{{ _("Loading...") }}', icon: '‚è≥', url: '#' },
                    { text: '{{ _("View Details") }}', icon: 'üìñ', url: '/courseDescription/' + courseSlug }
                ];
            } else if (window.currentUser) {
                // User is logged in
                if (isEnrolled) {
                    // User is enrolled in this course - dropdown should not be shown for enrolled users
                    // The entire card will be clickable instead
                    return; // Don't populate dropdown for enrolled users
                } else {
                    // User is logged in but not enrolled
                    const courseSlug = course.title.toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '')
                        .trim();
                    menuItems = [
                        { text: '{{ _("Enroll Now") }}', icon: '‚úÖ', url: 'https://epoint.az/yonca-psychological-support-and-development-center' },
                        { text: '{{ _("View Details") }}', icon: 'üìñ', url: '/courseDescription/' + courseSlug }
                    ];
                }
            } else {
                // User is not logged in
                const courseSlug = course.title.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '')
                    .trim();
                menuItems = [
                    { text: '{{ _("Login to Enroll") }}', icon: 'üîê', url: '/login' },
                    { text: '{{ _("View Details") }}', icon: 'üìñ', url: '/courseDescription/' + courseSlug }
                ];
            }

            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'dropdown-item';
                menuItem.style.padding = '10px 15px';
                menuItem.style.cursor = 'pointer';
                menuItem.style.borderBottom = '1px solid #eee';
                menuItem.style.display = 'flex';
                menuItem.style.alignItems = 'center';
                menuItem.innerHTML = `<span style="margin-right: 10px;">${item.icon || 'üîó'}</span>${item.text}`;

                menuItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (item.url && item.url !== '#') {
                        // Replace {description} placeholder with course slug
                        let url = item.url;
                        if (url.includes('{description}')) {
                            const courseSlug = course.title.toLowerCase()
                                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                                .replace(/\s+/g, '-') // Replace spaces with hyphens
                                .replace(/-+/g, '-') // Replace multiple hyphens with single
                                .trim(); // Remove leading/trailing whitespace
                            url = url.replace('{description}', `${courseSlug}`);
                        }
                        window.location.href = url;
                    } else {
                        handleCourseAction('details', course);
                    }
                    dropdown.style.display = 'none';
                });

                menuItem.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });

                menuItem.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'white';
                });

                dropdown.appendChild(menuItem);
            });
        }

        // Handle course actions
        function handleCourseAction(action, course) {
            switch (action) {
                case 'details':
                    // Navigate to course description page
                    const courseSlug = course.title.toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-') // Replace multiple hyphens with single
                        .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                        .trim();
                    window.location.href = `/courseDescription/${courseSlug}`;
                    break;
                case 'enroll':
                    if (window.currentUser) {
                        alert(`{{ _("Enrolling in") }}: ${course.title}`);
                        // TODO: Implement enrollment logic
                    } else {
                        window.location.href = '/login';
                    }
                    break;
                case 'contact':
                    // Scroll to contact section
                    const contactSection = document.getElementById('contact');
                    if (contactSection) {
                        contactSection.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        window.location.href = '/#contact';
                    }
                    break;
                case 'login':
                    window.location.href = '/login';
                    break;
                default:
                    console.log('Unknown action:', action);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.course-card')) {
                document.querySelectorAll('.course-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        // Ensure we re-check auth and reload courses when the page is shown (covers reload and bfcache restores)
        window.addEventListener('pageshow', (event) => {
            // If the page was persisted in bfcache or it's a manual reload, re-fetch user and courses
            try {
                window.currentUser = undefined;
                checkUser();
                // Only call loadCourses if the courses section exists on the page
                if (document.getElementById('courses')) {
                    loadCourses();
                }
            } catch (e) {
                console.warn('pageshow handler error', e);
            }
        });

        // Load resources
        async function loadResources() {
            try {
                const response = await fetch(`${API_BASE}/api/resources`);
                const resources = await response.json();
                const resourcesGrid = document.querySelector('.resources-grid');
                resourcesGrid.innerHTML = '';

                if (resources.length === 0) {
                    resourcesGrid.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">{{ _("No materials available at the moment.") }}</p>';
                    return;
                }

                resources.forEach(resource => {
                    const resourceCard = document.createElement('div');
                    resourceCard.className = 'resource-card';
                    
                    // Check if current user uploaded this resource
                    const isUploader = window.currentUser && resource.uploaded_by === window.currentUser.id;
                    const isAdmin = window.currentUser && window.currentUser.is_admin;
                    const canDelete = isUploader || isAdmin;
                    
                    if (resource.has_pin) {
                        // PIN-protected resource
                        let accessButton = '';
                        if (resource.requires_login) {
                            // User needs to log in to access PIN-protected resources
                            accessButton = `<button onclick="window.location.href='/login'" style="background: #3b82f6; color: white; border: 1px solid #3b82f6; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">{{ _('Log In to Access') }}</button>`;
                        } else if (resource.permanent_access) {
                            // User has permanent access - show direct link
                            accessButton = `<a href="${resource.drive_view_link}" target="_blank" style="background: #337a2c; color: white; text-decoration: none; border: 1px solid #337a2c; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 500; transition: all 0.3s ease; display: inline-block;">{{ _('View Resource') }}</a>`;
                        } else if (isUploader && resource.access_pin) {
                            // Show PIN to uploader with expiration info
                            const expiresAt = new Date(resource.pin_expires_at);
                            const now = new Date();
                            const timeLeft = expiresAt - now;
                            const minutesLeft = Math.max(0, Math.floor(timeLeft / (1000 * 60)));
                            
                            let expirationText = '';
                            if (minutesLeft > 0) {
                                expirationText = `{{ _('Expires in:') }} ${minutesLeft} {{ _('minutes') }}`;
                            } else {
                                expirationText = '<span style="color: #dc2626;">{{ _("PIN has expired") }}</span>';
                            }
                            
                            accessButton = `<div style="background: #f0f9ff; border: 1px solid #0ea5e9; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem;">
                                <strong style="color: #0ea5e9;">{{ _('Your Access PIN:') }}</strong> 
                                <span style="font-family: monospace; font-size: 1.1em; color: #1e40af; background: #e0f2fe; padding: 0.25rem 0.5rem; border-radius: 3px; margin-left: 0.5rem;">${resource.access_pin}</span>
                                <br><small style="color: #64748b;">${expirationText} | {{ _('Share this PIN with others to grant access') }}</small>
                            </div>
                            <a href="${resource.drive_view_link}" target="_blank" style="background: #337a2c; color: white; text-decoration: none; border: 1px solid #337a2c; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 500; transition: all 0.3s ease; display: inline-block; margin-top: 0.5rem;">{{ _('View Resource') }}</a>`;
                        } else {
                            // Show request access button to others
                            accessButton = `<button onclick="requestResourceAccess(${resource.id}, '${resource.title}')" style="background: #337a2c; color: white; border: 1px solid #337a2c; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">{{ _('Request Access') }}</button>`;
                        }
                        
                        resourceCard.innerHTML = `
                            ${resource.preview_image ? `<img src="${resource.preview_image}" alt="${resource.title}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">` : ''}
                            <h4>${resource.title} üîí</h4>
                            <p>${resource.description || '{{ _("No description available") }}'}</p>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">
                                {{ _('Uploaded:') }} ${new Date(resource.upload_date).toLocaleDateString()}
                            </p>
                            ${accessButton}
                            ${canDelete ? `
                                <form method="POST" action="/" style="display: inline; margin-left: 0.5rem;" onsubmit="return confirm('{{ _("Are you sure you want to delete this resource?") }}')">
                                    <input type="hidden" name="action" value="delete_resource">
                                    <input type="hidden" name="resource_id" value="${resource.id}">
                                    <button type="submit" class="btn btn-danger btn-sm">{{ _('Delete') }}</button>
                                </form>
                            ` : ''}
                        `;
                    } else {
                        // Public resource
                        resourceCard.innerHTML = `
                            ${resource.preview_image ? `<img src="${resource.preview_image}" alt="${resource.title}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">` : ''}
                            <h4>${resource.title}</h4>
                            <p>${resource.description || '{{ _("No description available") }}'}</p>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">
                                {{ _('Uploaded:') }} ${new Date(resource.upload_date).toLocaleDateString()}
                            </p>
                            <a href="${resource.drive_view_link}" target="_blank" style="background: #337a2c; color: white; text-decoration: none; border: 1px solid #337a2c; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 500; transition: all 0.3s ease; display: inline-block;">{{ _('View Resource') }}</a>
                            ${canDelete ? `
                                <form method="POST" action="/" style="display: inline; margin-left: 0.5rem;" onsubmit="return confirm('{{ _("Are you sure you want to delete this resource?") }}')">
                                    <input type="hidden" name="action" value="delete_resource">
                                    <input type="hidden" name="resource_id" value="${resource.id}">
                                    <button type="submit" class="btn btn-danger btn-sm">{{ _('Delete') }}</button>
                                </form>
                            ` : ''}
                        `;
                    }
                    
                    resourcesGrid.appendChild(resourceCard);
                });
            } catch (error) {
                console.error('Error loading resources:', error);
                document.querySelector('.resources-grid').innerHTML = '<p style="text-align: center; color: #dc2626;">{{ _("Error loading materials. Please try again.") }}</p>';
            }
        }

        // Load PDFs
        async function loadPDFs() {
            try {
                const response = await fetch(`${API_BASE}/api/pdfs`);
                const pdfs = await response.json();
                
                const pdfsList = document.getElementById('pdfs-list');
                pdfsList.innerHTML = '';

                if (pdfs.length === 0) {
                    pdfsList.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">{{ _("No PDF documents available at the moment.") }}</p>';
                    return;
                }

                pdfs.forEach(pdf => {
                    const pdfCard = document.createElement('div');
                    pdfCard.className = 'resource-card';
                    
                    // Check if current user uploaded this PDF
                    const isUploader = window.currentUser && pdf.uploaded_by === window.currentUser.id;
                    const isAdmin = window.currentUser && window.currentUser.is_admin;
                    const canDelete = isUploader || isAdmin;
                    
                    let accessButton = '';
                    if (isUploader && pdf.access_pin) {
                        // Show PIN to uploader
                        accessButton = `<div style="background: #f0f9ff; border: 1px solid #0ea5e9; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem;">
                            <strong style="color: #0ea5e9;">{{ _('Your Access PIN:') }}</strong> 
                            <span style="font-family: monospace; font-size: 1.1em; color: #1e40af; background: #e0f2fe; padding: 0.25rem 0.5rem; border-radius: 3px; margin-left: 0.5rem;">${pdf.access_pin}</span>
                            <br><small style="color: #64748b;">{{ _('Share this PIN with others to grant access') }}</small>
                        </div>
                        <button onclick="requestPDFAccess(${pdf.id}, '${pdf.title}')" style="background: #337a2c; color: white; border: 1px solid #337a2c; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin-top: 0.5rem;">{{ _('Access PDF') }}</button>`;
                    } else {
                        // Show request access button to others
                        accessButton = `<button onclick="requestPDFAccess(${pdf.id}, '${pdf.title}')" style="background: #337a2c; color: white; border: 1px solid #337a2c; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">{{ _('Request Access') }}</button>`;
                    }
                    
                    pdfCard.innerHTML = `
                        <h4>${pdf.title}</h4>
                        <p>${pdf.description || '{{ _("No description available") }}'}</p>
                        <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">
                            {{ _('Uploaded:') }} ${new Date(pdf.upload_date).toLocaleDateString()}
                        </p>
                        ${accessButton}
                        ${canDelete ? `
                            <form method="POST" action="/" style="display: inline; margin-left: 0.5rem;" onsubmit="return confirm('{{ _("Are you sure you want to delete this PDF?") }}')">
                                <input type="hidden" name="action" value="delete_pdf">
                                <input type="hidden" name="pdf_id" value="${pdf.id}">
                                <button type="submit" class="btn btn-danger btn-sm">{{ _('Delete') }}</button>
                            </form>
                        ` : ''}
                    `;
                    pdfsList.appendChild(pdfCard);
                });
            } catch (error) {
                console.error('Error loading PDFs:', error);
                document.getElementById('pdfs-list').innerHTML = '<p style="text-align: center; color: #dc2626;">{{ _("Error loading PDFs. Please try again.") }}</p>';
            }
        }

        // Request resource access
        function requestResourceAccess(resourceId, title) {
            const pin = prompt(`{{ _('Enter access PIN for:') }} ${title}`);
            if (pin && pin.trim()) {
                accessResourceById(resourceId, pin.trim());
            }
        }

        // Access resource by ID and PIN
        async function accessResourceById(resourceId, pin) {
            try {
                const response = await fetch(`${API_BASE}/api/resources/${resourceId}/access`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ pin: pin })
                });

                const result = await response.json();

                if (response.ok) {
                    // Success - open the view link and reload resources to show permanent access
                    window.open(result.drive_view_link, '_blank');
                    // Reload resources to update the UI with permanent access
                    loadResources();
                } else {
                    alert(result.error || '{{ _("Invalid PIN or access denied.") }}');
                }
            } catch (error) {
                console.error('Error accessing resource:', error);
                alert('{{ _("Error accessing resource. Please try again.") }}');
            }
        }

        // Upload PDF
        async function uploadPDF(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('pdf-upload-btn');
            const statusDiv = document.getElementById('pdf-upload-status');

            submitBtn.disabled = true;
            submitBtn.textContent = '{{ _("Uploading PDF...") }}';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span style="color: #6b7280;">{{ _("Uploading PDF...") }}</span>';

            try {
                const response = await fetch(`${API_BASE}/api/pdfs/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                });

                let result;
                if (response.status === 401) {
                    result = await response.json();
                    if (result.error === 'login_required') {
                        // Redirect to Google login
                        window.location.href = result.login_url;
                        return;
                    }
                } else {
                    result = await response.json();
                }

                if (response.ok) {
                    statusDiv.innerHTML = `<span style="color: #059669;">‚úÖ {{ _("PDF uploaded successfully! Access PIN:") }} <strong>${result.pin}</strong></span>`;

                    // Clear form
                    form.reset();

                    // Reload PDFs
                    loadPDFs();
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå ${result.error || '{{ _("Error uploading PDF. Please try again.") }}'}</span>`;
                }
            } catch (error) {
                console.error('Error uploading PDF:', error);
                statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå {{ _("Error uploading PDF. Please try again.") }}</span>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '{{ _("Upload PDF") }}';
            }
        }

        // Upload resource
        async function uploadResource(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('resource-upload-btn');
            const statusDiv = document.getElementById('resource-upload-status');

            submitBtn.disabled = true;
            submitBtn.textContent = '{{ _("Uploading...") }}';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span style="color: #6b7280;">{{ _("Uploading resource...") }}</span>';

            try {
                const response = await fetch(`${API_BASE}/api/resources`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                });

                let result;
                if (response.status === 401) {
                    result = await response.json();
                    if (result.error === 'login_required') {
                        // Redirect to Google login
                        window.location.href = result.login_url;
                        return;
                    }
                } else {
                    result = await response.json();
                }

                if (response.ok) {
                    statusDiv.innerHTML = `<span style="color: #059669;">‚úÖ {{ _("Material uploaded successfully! Access PIN:") }} <strong>${result.pin}</strong></span>`;

                    // Clear form
                    form.reset();

                    // Reload resources
                    loadResources();
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå ${result.error || '{{ _("Error uploading material. Please try again.") }}'}</span>`;
                }
            } catch (error) {
                console.error('Error uploading resource:', error);
                statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå {{ _("Error uploading resource. Please try again.") }}</span>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '{{ _("Upload Material") }}';
            }
        }

        // Forum functionality
        let currentChannel = 'general';
        let availableChannels = [];

        // Translation functionality
        let targetLanguage = 'none';
        let autoTranslateEnabled = false; // Auto-translate is disabled
        let currentLanguageIndex = 0;
        const availableLanguages = [
            {code: 'en', name: 'EN', flag: 'üåê'},
            {code: 'ru', name: 'RU', flag: 'üá∑üá∫'},
            {code: 'az', name: 'AZ', flag: 'üá¶üáø'}
        ];

        // Forum translation variables only

        async function loadForumChannels() {
            try {
                const response = await fetch(`${API_BASE}/api/forum/channels`);
                const channels = await response.json();
                availableChannels = channels;
                
                // Build channel tabs dynamically
                const channelTabsContainer = document.querySelector('.channel-tabs');
                channelTabsContainer.innerHTML = '';
                
                channels.forEach((channel, index) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'channel-tab' + (index === 0 ? ' active' : '');
                    tabButton.setAttribute('data-channel', channel.slug);
                    tabButton.textContent = channel.name;
                    
                    // Handle channel visibility and access
                    if (channel.admin_only) {
                        // Admin-only channels
                        if (!window.currentUser || !window.currentUser.is_admin) {
                            return; // Don't show this tab to non-admins
                        }
                    } else if (channel.requires_login) {
                        // Login-required channels
                        if (!window.currentUser) {
                            tabButton.classList.add('locked');
                            tabButton.disabled = true;
                        }
                    }
                    // Public channels are always shown and enabled
                    
                    channelTabsContainer.appendChild(tabButton);
                });
                
                // Add event listeners to new tabs
                document.querySelectorAll('.channel-tab').forEach(tab => {
                    tab.addEventListener('click', (event) => {
                        const channel = event.target.getAttribute('data-channel');
                        switchChannel(channel);
                    });
                });
                
                // Load messages for the first channel
                if (channels.length > 0) {
                    currentChannel = channels[0].slug;
                    updateForumAuth(); // Update form visibility for the initial channel
                    loadForumMessages(currentChannel);
                }
            } catch (error) {
                console.error('Error loading forum channels:', error);
                // Fallback to default behavior
                loadForumMessages(currentChannel);
            }
        }

        function switchChannel(channel) {
            // Check permissions
            const channelObj = availableChannels.find(c => c.slug === channel);
            if (channelObj) {
                if (channelObj.admin_only && (!window.currentUser || !window.currentUser.is_admin)) {
                    alert('Admin access required for this channel');
                    return;
                } else if (channelObj.requires_login && !window.currentUser) {
                    alert('Authentication required for this channel');
                    return;
                }
            }
            
            currentChannel = channel;
            
            // Update active tab
            document.querySelectorAll('.channel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-channel="${channel}"]`).classList.add('active');
            
            // Update channel title
            document.getElementById('channel-title').textContent = channelObj ? channelObj.name : channel;
            
            // Update form visibility based on channel permissions
            updateForumAuth();
            
            // Load messages for this channel
            loadForumMessages(channel);
        }

        async function loadForumMessages(channel = 'general') {
            try {
                const response = await fetch(`${API_BASE}/api/forum/messages?channel=${channel}`);
                
                if (response.status === 403) {
                    // Access denied - try general channel first, then show empty
                    console.warn(`Access denied for channel '${channel}'. Trying general channel.`);
                    if (channel !== 'general') {
                        loadForumMessages('general');
                        return;
                    } else {
                        // Even general requires auth - show empty forum
                        const messagesContainer = document.getElementById('messages-container');
                        messagesContainer.innerHTML = '<div class="forum-message"><div class="user">System</div><p>This forum requires authentication. Please log in to view messages.</p></div>';
                        return;
                    }
                }
                
                if (response.status === 404) {
                    // Channel not found - show appropriate message
                    console.warn(`Channel '${channel}' not found.`);
                    const messagesContainer = document.getElementById('messages-container');
                    messagesContainer.innerHTML = '<div class="forum-message"><div class="user">System</div><p>Channel not found or no channels available.</p></div>';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';

                // Extract messages from the response object
                const messages = data.messages || [];

                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<div class="forum-message"><div class="user">No messages yet</div><p>Be the first to start a conversation!</p></div>';
                    return;
                }

                function renderMessage(message, container, depth = 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'forum-message' + (message.is_current_user ? ' current-user' : '');
                    messageDiv.setAttribute('data-message-id', message.id);
                    messageDiv.setAttribute('data-original-text', message.message);
                    messageDiv.setAttribute('data-translated-text', '');
                    messageDiv.setAttribute('data-translation-shown', 'false');
                    messageDiv.style.marginLeft = `${depth * 20}px`;

                    let actionsHtml = '';
                    // Show reply button for all users (logged in and anonymous)
                    actionsHtml = `
                        <div class="message-actions">
                            <button onclick="replyToMessage(${message.id}, '${message.username}', '${message.channel}')" class="reply-btn">üí¨ Reply</button>
                            <button onclick="toggleTranslation(${message.id})" class="translate-btn" title="Toggle translation" style="display: ${targetLanguage === 'none' ? 'none' : 'inline-block'};">üåê Translate</button>
                    `;

                    // Show edit/delete buttons only for message owner or admin
                    if (window.currentUser && (message.is_current_user || window.currentUser.is_admin)) {
                        actionsHtml += `
                            <button onclick="editMessage(${message.id}, '${message.message.replace(/'/g, "\\'")}')" class="edit-btn">‚úèÔ∏è Edit</button>
                            <button onclick="deleteMessage(${message.id})" class="delete-btn">üóëÔ∏è Delete</button>
                        `;
                    }

                    actionsHtml += '</div>';

                    messageDiv.innerHTML = `
                        <div class="user">${message.username}${message.is_current_user ? ' (You)' : ''}</div>
                        <p class="message-text" id="message-text-${message.id}">${message.message}</p>
                        <div class="timestamp">Posted on ${new Date(message.timestamp).toLocaleDateString()} at ${new Date(message.timestamp).toLocaleTimeString()}</div>
                        ${actionsHtml}
                    `;
                    container.appendChild(messageDiv);

                    // Note: Auto-translation is handled by toggleAutoTranslate when the setting changes
                    // Individual translation is handled by the translate button

                    // Render replies
                    if (message.replies && message.replies.length > 0) {
                        message.replies.forEach(reply => renderMessage(reply, container, depth + 1));
                    }
                }

                messages.forEach(message => renderMessage(message, messagesContainer));

                // No auto-translation applied
            } catch (error) {
                console.error('Error loading forum messages:', error);
            }
        }

        async function postMessage(event) {
            event.preventDefault();

            const message = document.getElementById('message').value.trim();
            const username = document.getElementById('username').value.trim();

            if (message === '') {
                alert('Please enter a message');
                return;
            }

            // Check if user can post to this channel
            const channelObj = availableChannels.find(c => c.slug === currentChannel);
            if (channelObj && channelObj.requires_login && !window.currentUser) {
                alert('Please log in to post to this channel');
                return;
            }

            if (!window.currentUser && !username) {
                alert('Please enter a username');
                return;
            }

            const postBtn = document.getElementById('post-btn');
            const originalText = postBtn.textContent;
            postBtn.textContent = 'Posting...';
            postBtn.disabled = true;

            try {
                const requestData = { 
                    message,
                    channel: currentChannel
                };
                
                if (!window.currentUser) {
                    requestData.username = username;
                }

                const response = await fetch(`${API_BASE}/api/forum/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(requestData),
                });

                if (response.ok) {
                    // Reload messages
                    loadForumMessages(currentChannel);
                    // Clear form
                    document.getElementById('message').value = '';
                    if (!window.currentUser) {
                        document.getElementById('username').value = '';
                    }
                    alert('Message posted successfully!');
                } else if (response.status === 401 || response.status === 403) {
                    alert('You do not have permission to post to this channel');
                } else {
                    const error = await response.json();
                    alert('Error posting message: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error posting message:', error);
                alert('Error posting message. Please try again.');
            } finally {
                postBtn.textContent = originalText;
                postBtn.disabled = false;
            }
        }

        async function replyToMessage(parentId, parentUsername, channel) {
            let replyMessage = prompt(`Reply to ${parentUsername}:`, '');
            if (replyMessage === null || replyMessage.trim() === '') {
                return;
            }

            let username = null;
            if (!window.currentUser) {
                // Anonymous user - ask for username
                username = prompt('Enter your username:', '');
                if (username === null || username.trim() === '') {
                    alert('Username is required for anonymous posting');
                    return;
                }
                username = username.trim();
            }

            try {
                const requestData = {
                    message: replyMessage.trim(),
                    parent_id: parentId,
                    channel: channel
                };
                
                if (!window.currentUser) {
                    requestData.username = username;
                }

                const response = await fetch(`${API_BASE}/api/forum/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(requestData),
                });

                if (response.ok) {
                    // Reload messages to show the new reply
                    loadForumMessages(currentChannel);
                    alert('Reply posted successfully!');
                } else if (response.status === 401 || response.status === 403) {
                    alert('You do not have permission to reply to messages in this channel');
                } else {
                    const error = await response.json();
                    alert('Error posting reply: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error posting reply:', error);
                alert('Error posting reply. Please try again.');
            }
        }

        async function editMessage(messageId, currentMessage) {
            const newMessage = prompt('Edit your message:', currentMessage);
            if (newMessage === null || newMessage.trim() === '' || newMessage.trim() === currentMessage) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/forum/messages/${messageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ message: newMessage.trim() }),
                });

                if (response.ok) {
                    loadForumMessages(currentChannel);
                    alert('Message updated successfully!');
                } else {
                    const error = await response.json();
                    alert('Error updating message: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error editing message:', error);
                alert('Error updating message. Please try again.');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/forum/messages/${messageId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                });

                if (response.ok) {
                    loadForumMessages(currentChannel);
                    alert('Message deleted successfully!');
                } else {
                    const error = await response.json();
                    alert('Error deleting message: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            }
        }

        // Refresh all course dropdowns with current user authentication status
        function refreshCourseDropdowns() {
            // Find all course cards and refresh their dropdowns if they're open
            const courseCards = document.querySelectorAll('.course-card');
            courseCards.forEach((card, index) => {
                const dropdown = card.querySelector('.course-dropdown');
                if (dropdown && dropdown.style.display !== 'none') {
                    // Check if this card has enrolled styling
                    const isEnrolled = card.classList.contains('enrolled-course');
                    
                    // Create a mock course object - in a real implementation, 
                    // you'd store the full course data in the DOM or have a global courses array
                    const courseTitle = card.querySelector('h4')?.textContent?.replace('‚úì ENROLLED', '').trim() || 'Course';
                    const courseDesc = card.querySelectorAll('p')[0]?.textContent || '';
                    const timeSlot = card.querySelectorAll('p')[1]?.textContent?.replace('Time Slot: ', '') || 'TBD';
                    
                    const mockCourse = { 
                        title: courseTitle, 
                        description: courseDesc,
                        time_slot: timeSlot,
                        dropdown_menu: null,
                        id: index + 1 // Simple ID for URL generation
                    };
                    
                    populateCourseDropdown(dropdown, mockCourse, isEnrolled);
                }
            });
        }
        async function checkUser() {
            try {
                console.log('Checking user login status...');
                const response = await fetch(`${API_BASE}/api/user`, {
                    credentials: 'include'
                });
                console.log('User check response status:', response.status);
                if (response.ok) {
                    const user = await response.json();
                    console.log('User data received:', user);
                    if (user) {
                        // User is logged in
                        console.log('User logged in:', user);
                        document.getElementById('auth-buttons').style.display = 'none';
                        document.getElementById('user-info').style.display = 'block';
                        document.getElementById('user-name').textContent = user.username;
                        window.currentUser = user;
                        updateForumForm(true);
                        showHomeCourses(user.courses);

                        // Set user's preferred language
                        if (user.preferred_language) {
                            targetLanguage = user.preferred_language;
                            const languageSelect = document.getElementById('target-language');
                            if (languageSelect) {
                                languageSelect.value = user.preferred_language;
                            }
                        }

                        // Show admin button for admin users
                        if (user.is_admin) {
                            document.getElementById('admin-btn').style.display = 'inline-block';
                            document.getElementById('resource-upload-section').style.display = 'block';
                        } else {
                            document.getElementById('admin-btn').style.display = 'none';
                            document.getElementById('resource-upload-section').style.display = 'none';
                        }
                        
                        // Load forum messages for authenticated user
                        loadForumMessages(currentChannel);
                        
                        // Refresh course dropdowns with authenticated user context
                        refreshCourseDropdowns();
                    } else {
                        // User is not logged in - anonymous visitor
                        console.log('User is not logged in (anonymous visitor)');
                        document.getElementById('auth-buttons').style.display = 'block';
                        document.getElementById('user-info').style.display = 'none';
                        document.getElementById('admin-btn').style.display = 'none';
                        window.currentUser = null;
                        updateForumForm(false);
                        hideHomeCourses();
                        // Hide resource upload section for anonymous users
                        document.getElementById('resource-upload-section').style.display = 'none';
                        
                        // Load forum messages for anonymous user
                        loadForumMessages(currentChannel);
                        
                        // Refresh course dropdowns with anonymous user context
                        refreshCourseDropdowns();
                    }
                } else {
                    // API error
                    console.warn('API error checking user status:', response.status);
                    document.getElementById('auth-buttons').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('admin-btn').style.display = 'none';
                    window.currentUser = null;
                    updateForumForm(false);
                    hideHomeCourses();
                    document.getElementById('resource-upload-section').style.display = 'none';
                    
                    // Load forum messages for anonymous user (API error)
                    loadForumMessages(currentChannel);
                }
            } catch (error) {
                console.error('Network error checking user:', error);
                // Assume anonymous user on network errors
                document.getElementById('auth-buttons').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('admin-btn').style.display = 'none';
                window.currentUser = null;
                updateForumForm(false);
                hideHomeCourses();
                document.getElementById('resource-upload-section').style.display = 'none';
                
                // Load forum messages for anonymous user (network error)
                loadForumMessages(currentChannel);
            }
        }

        function updateForumForm(isLoggedIn) {
            const usernameGroup = document.getElementById('username-group');
            if (isLoggedIn) {
                usernameGroup.style.display = 'none';
            } else {
                usernameGroup.style.display = 'block';
            }
            updateForumAuth();
        }

        function updateForumAuth() {
            const authRequired = document.getElementById('forum-auth-required');
            const forumContent = document.getElementById('forum-content');
            const messageForm = document.querySelector('.message-form');
            const usernameGroup = document.getElementById('username-group');
            const membersTab = document.getElementById('members-tab');
            const staffTab = document.getElementById('staff-tab');

            if (window.currentUser) {
                // User is logged in - show full forum
                authRequired.style.display = 'none';
                forumContent.style.display = 'block';
                
                // Show form based on channel permissions
                const currentChannelObj = availableChannels.find(c => c.slug === currentChannel);
                if (currentChannelObj) {
                    if (currentChannelObj.admin_only && !window.currentUser.is_admin) {
                        // Admin-only channels require admin access
                        if (messageForm) messageForm.style.display = 'none';
                    } else {
                        // User can post in this channel
                        if (messageForm) messageForm.style.display = 'block';
                    }
                } else {
                    if (messageForm) messageForm.style.display = 'block';
                }
                
                usernameGroup.style.display = 'none';
            } else {
                // User is not logged in
                authRequired.style.display = 'none';
                forumContent.style.display = 'block';
                
                // Check if current channel allows anonymous posting
                const currentChannelObj = availableChannels.find(c => c.slug === currentChannel);
                if (currentChannelObj && !currentChannelObj.requires_login && !currentChannelObj.admin_only) {
                    // Public channel - show form for anonymous posting
                    if (messageForm) messageForm.style.display = 'block';
                    usernameGroup.style.display = 'block';
                } else {
                    // Private channel - hide form
                    if (messageForm) messageForm.style.display = 'none';
                    usernameGroup.style.display = 'none';
                }
                
                // If current channel is private, switch to general
                if (currentChannel === 'members' || currentChannel === 'staff') {
                    switchChannel('general');
                }
            }
        }

        function showHomeCourses(courses) {
            // Implementation for showing user courses on home page
            console.log('User courses:', courses);
        }

        function hideHomeCourses() {
            // Implementation for hiding courses when not logged in
            console.log('Hiding courses');
        }

        // Translation functions
        function changeTargetLanguage() {
            const select = document.getElementById('target-language');
            targetLanguage = select.value;
            console.log('Target language changed to:', targetLanguage);

            // Show/hide translate buttons based on language selection
            const translateButtons = document.querySelectorAll('.translate-btn');
            if (targetLanguage === 'none') {
                // Hide translate buttons when "Don't translate" is selected
                translateButtons.forEach(button => {
                    button.style.display = 'none';
                });
                // Show original text for all messages
                const messageElements = document.querySelectorAll('.forum-message');
                messageElements.forEach(element => {
                    const messageId = element.getAttribute('data-message-id');
                    const originalText = element.getAttribute('data-original-text');
                    if (originalText) {
                        const messageTextElement = document.getElementById(`message-text-${messageId}`);
                        if (messageTextElement) {
                            messageTextElement.textContent = originalText;
                            element.setAttribute('data-translation-shown', 'false');
                        }
                    }
                });
            } else {
                // Show translate buttons when a language is selected
                translateButtons.forEach(button => {
                    button.style.display = 'inline-block';
                    // Reset button to default "Translate" state
                    button.textContent = 'üåê Translate';
                    button.style.color = 'white';
                    button.style.backgroundColor = '';
                });
                // Clear any existing translations when switching languages
                const messageElements = document.querySelectorAll('.forum-message');
                messageElements.forEach(element => {
                    const messageId = element.getAttribute('data-message-id');
                    const originalText = element.getAttribute('data-original-text');
                    if (originalText) {
                        const messageTextElement = document.getElementById(`message-text-${messageId}`);
                        if (messageTextElement) {
                            messageTextElement.textContent = originalText;
                            element.setAttribute('data-translation-shown', 'false');
                            element.setAttribute('data-translated-text', ''); // Clear cached translation
                        }
                    }
                });
            }
        }

        function toggleAutoTranslate() {
            const checkbox = document.getElementById('auto-translate');
            autoTranslateEnabled = checkbox.checked;

            if (autoTranslateEnabled) {
                translateAllVisibleMessages();
            } else {
                // Show original text for all messages
                const messageElements = document.querySelectorAll('.forum-message');
                messageElements.forEach(element => {
                    const messageId = element.getAttribute('data-message-id');
                    const originalText = element.getAttribute('data-original-text');
                    if (originalText) {
                        const messageTextElement = document.getElementById(`message-text-${messageId}`);
                        if (messageTextElement) {
                            messageTextElement.textContent = originalText;
                            element.setAttribute('data-translation-shown', 'false');
                        }
                    }
                });
            }
        }







        async function translateMessage(messageId, text) {
            if (!text || !text.trim() || targetLanguage === 'none') return;

            try {
                const response = await fetch(`${API_BASE}/api/translate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        target_language: targetLanguage
                    })
                });

                const data = await response.json();
                if (data.translated_text) {
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.setAttribute('data-translated-text', data.translated_text);
                        // Always update the display when called for auto-translation
                        const messageTextElement = document.getElementById(`message-text-${messageId}`);
                        const translateButton = messageElement.querySelector('.translate-btn');
                        if (messageTextElement) {
                            messageTextElement.textContent = data.translated_text;
                            messageElement.setAttribute('data-translation-shown', 'true');
                        }
                        // Update button to "Translate Back" state
                        if (translateButton) {
                            translateButton.textContent = 'üåê Translate Back';
                            translateButton.style.color = 'white'; // White color for "back" state
                            translateButton.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
                        }
                    }
                }
            } catch (error) {
                // Translation error handled silently
            }
        }

        function toggleTranslation(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;

            const originalText = messageElement.getAttribute('data-original-text');
            const translatedText = messageElement.getAttribute('data-translated-text');
            const currentlyShowingTranslation = messageElement.getAttribute('data-translation-shown') === 'true';
            const messageTextElement = document.getElementById(`message-text-${messageId}`);
            const translateButton = messageElement.querySelector('.translate-btn');

            if (!messageTextElement || !translateButton) return;

            if (currentlyShowingTranslation) {
                // Show original text
                messageTextElement.textContent = originalText;
                messageElement.setAttribute('data-translation-shown', 'false');
                // Reset button to "Translate" state
                translateButton.textContent = 'üåê Translate';
                translateButton.style.color = 'white';
                translateButton.style.backgroundColor = '';
            } else {
                // Show translated text
                if (translatedText) {
                    messageTextElement.textContent = translatedText;
                    messageElement.setAttribute('data-translation-shown', 'true');
                    // Change button to "Translate Back" state
                    translateButton.textContent = 'üåê Translate Back';
                    translateButton.style.color = 'white'; // White color for "back" state
                    translateButton.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
                } else {
                    // Need to translate first
                    const textToTranslate = originalText;
                    translateMessage(messageId, textToTranslate);
                }
            }
        }

        async function translateAllVisibleMessages() {
            const messageElements = document.querySelectorAll('.forum-message');
            const textsToTranslate = [];

            messageElements.forEach(element => {
                const messageId = element.getAttribute('data-message-id');
                const originalText = element.getAttribute('data-original-text');
                if (originalText && originalText.trim()) {
                    textsToTranslate.push({
                        id: messageId,
                        text: originalText
                    });
                }
            });

            if (textsToTranslate.length === 0) return;

            try {
                const response = await fetch(`${API_BASE}/api/translate/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        texts: textsToTranslate.map(item => item.text),
                        target_language: targetLanguage
                    })
                });

                const data = await response.json();
                if (data.translations) {
                    data.translations.forEach((translation, index) => {
                        const item = textsToTranslate[index];
                        const messageElement = document.querySelector(`[data-message-id="${item.id}"]`);
                        if (messageElement) {
                            messageElement.setAttribute('data-translated-text', translation.translated);
                            // Always update the display for "Translate All" function
                            const messageTextElement = document.getElementById(`message-text-${item.id}`);
                            if (messageTextElement) {
                                messageTextElement.textContent = translation.translated;
                                messageElement.setAttribute('data-translation-shown', 'true');
                            }
                        }
                    });
                }
            } catch (error) {
                // Batch translation error handled silently
            }
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize currentUser as undefined to indicate auth check is pending
            window.currentUser = undefined;
            
            // Initialize translate button visibility based on default language
            const translateButtons = document.querySelectorAll('.translate-btn');
            if (targetLanguage === 'none') {
                translateButtons.forEach(button => {
                    button.style.display = 'none';
                });
            }
            
            // Check if initial page is set from server
            const initialPage = '{{ initial_page|default("home") }}';
            
            // Check URL hash and show appropriate page
            const hash = window.location.hash.substring(1); // Remove the '#'
            if (hash && hash !== 'home') {
                // Valid page hashes - must match section IDs in HTML
                const validPages = ['courses', 'forum', 'resources', 'tavi', 'contacts', 'about'];
                if (validPages.includes(hash)) {
                    showPage(hash);
                } else {
                    showPage(initialPage);
                }
            } else {
                // Show initial page from server or default to home
                showPage(initialPage);
            }

            checkUser();
            // Don't load forum messages here - let checkUser handle it after determining auth status

            // Add navigation event listeners
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const pageId = link.id.replace('-link', '');
                    showPage(pageId, event);
                });
            });

            // Add PDF upload form listener
            const pdfUploadForm = document.getElementById('pdf-upload-form');
            if (pdfUploadForm) {
                pdfUploadForm.addEventListener('submit', uploadPDF);
            }

            // Add resource upload form listener
            const resourceUploadForm = document.getElementById('resource-upload-form');
            if (resourceUploadForm) {
                resourceUploadForm.addEventListener('submit', uploadResource);
            }

            // Add channel tab event listeners
            const channelTabs = document.querySelectorAll('.channel-tab');
            channelTabs.forEach(tab => {
                tab.addEventListener('click', (event) => {
                    const channel = event.target.getAttribute('data-channel');
                    switchChannel(channel);
                });
            });

            // Mobile menu functionality
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            const mobileNavClose = document.getElementById('mobile-nav-close');

            // Mobile menu toggle
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', () => {
                    mobileNavOverlay.classList.add('active');
                    mobileNavMenu.classList.add('active');
                });
            }

            // Close mobile menu
            if (mobileNavClose) {
                mobileNavClose.addEventListener('click', () => {
                    closeMobileMenu();
                });
            }

            // Close mobile menu when clicking overlay
            if (mobileNavOverlay) {
                mobileNavOverlay.addEventListener('click', (e) => {
                    if (e.target === mobileNavOverlay) {
                        closeMobileMenu();
                    }
                });
            }

            // Mobile navigation links
            const mobileNavLinks = document.querySelectorAll('#mobile-nav-menu .nav-link');
            mobileNavLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    closeMobileMenu();
                    const pageId = link.id.replace('mobile-', '').replace('-link', '');
                    showPage(pageId, event);
                });
            });

            function closeMobileMenu() {
                mobileNavOverlay.classList.remove('active');
                mobileNavMenu.classList.remove('active');
            }

            // Update mobile auth buttons when user status changes
            function updateMobileAuthButtons() {
                const mobileAuthButtons = document.getElementById('mobile-auth-buttons');
                const mobileUserInfo = document.getElementById('mobile-user-info');
                const mobileUserName = document.getElementById('mobile-user-name');
                const mobileAdminBtn = document.getElementById('mobile-admin-btn');

                if (window.currentUser) {
                    mobileAuthButtons.style.display = 'none';
                    mobileUserInfo.style.display = 'block';
                    mobileUserName.textContent = window.currentUser.username;
                    if (window.currentUser.is_admin) {
                        mobileAdminBtn.style.display = 'block';
                    }
                } else {
                    mobileAuthButtons.style.display = 'block';
                    mobileUserInfo.style.display = 'none';
                }
            }

            // Override checkUser to also update mobile auth buttons
            const originalCheckUser = window.checkUser;
            window.checkUser = function() {
                originalCheckUser().then(() => {
                    updateMobileAuthButtons();
                });
            };
        });
    </script>
    <script>
        /*          *     .        *  .    *    *   . 
 .  *  Stars move automatically toward center  .
 *  .  .   change these values:   .  *
   .      * .        .          * .       */
        const STAR_COLOR = '#fff';
        const STAR_SIZE = 3;
        const STAR_MIN_SCALE = 0.2;
        const OVERFLOW_THRESHOLD = 50;
        const STAR_COUNT = ( window.innerWidth + window.innerHeight ) / 8;

        const canvas = document.querySelector( 'canvas' ),
              context = canvas.getContext( '2d' );

        let scale = 1, // device pixel ratio
            width,
            height;

        let stars = [];

        let velocity = { x: 0, y: 0, tx: 0, ty: 0, z: 0.0008 }; // Increased z for more noticeable movement

        generate();
        resize();
        step();

        window.onresize = resize;
        // Removed mouse and touch event listeners to disable interactive movement

        function generate() {

           for( let i = 0; i < STAR_COUNT; i++ ) {
            stars.push({
              x: 0,
              y: 0,
              z: STAR_MIN_SCALE + Math.random() * ( 1 - STAR_MIN_SCALE ),
              color: Math.random() < 0.20 ? `hsl(${100 + Math.random() * 40}, 70%, ${40 + Math.random() * 30}%)` : STAR_COLOR
            });
           }

        }

        function placeStar( star ) {

          star.x = Math.random() * width;
          star.y = Math.random() * height;

        }

        function recycleStar( star ) {

          let direction = 'z';

          let vx = Math.abs( velocity.x ),
                vy = Math.abs( velocity.y );

          if( vx > 1 || vy > 1 ) {
            let axis;

            if( vx > vy ) {
              axis = Math.random() < vx / ( vx + vy ) ? 'h' : 'v';
            }
            else {
              axis = Math.random() < vy / ( vx + vy ) ? 'v' : 'h';
            }

            if( axis === 'h' ) {
              direction = velocity.x > 0 ? 'l' : 'r';
            }
            else {
              direction = velocity.y > 0 ? 't' : 'b';
            }
          }
          
          star.z = STAR_MIN_SCALE + Math.random() * ( 1 - STAR_MIN_SCALE );

          if( direction === 'z' ) {
            star.z = 0.1;
            star.x = Math.random() * width;
            star.y = Math.random() * height;
          }
          else if( direction === 'l' ) {
            star.x = -OVERFLOW_THRESHOLD;
            star.y = height * Math.random();
          }
          else if( direction === 'r' ) {
            star.x = width + OVERFLOW_THRESHOLD;
            star.y = height * Math.random();
          }
          else if( direction === 't' ) {
            star.x = width * Math.random();
            star.y = -OVERFLOW_THRESHOLD;
          }
          else if( direction === 'b' ) {
            star.x = width * Math.random();
            star.y = height + OVERFLOW_THRESHOLD;
          }

        }

        function resize() {

          scale = window.devicePixelRatio || 1;

          width = window.innerWidth * scale;
          height = window.innerHeight * scale;

          canvas.width = width;
          canvas.height = height;

          stars.forEach( placeStar );

        }

        function step() {

          context.clearRect( 0, 0, width, height );

          update();
          render();

          requestAnimationFrame( step );

        }

        function update() {

          velocity.tx *= 0.96;
          velocity.ty *= 0.96;

          velocity.x += ( velocity.tx - velocity.x ) * 0.8;
          velocity.y += ( velocity.ty - velocity.y ) * 0.8;

          stars.forEach( ( star ) => {

            star.x += velocity.x * star.z;
            star.y += velocity.y * star.z;

            star.x += ( star.x - width/2 ) * velocity.z * star.z;
            star.y += ( star.y - height/2 ) * velocity.z * star.z;
            star.z += velocity.z;
          
            // recycle when out of bounds
            if( star.x < -OVERFLOW_THRESHOLD || star.x > width + OVERFLOW_THRESHOLD || star.y < -OVERFLOW_THRESHOLD || star.y > height + OVERFLOW_THRESHOLD ) {
              recycleStar( star );
            }

          } );

        }

        function render() {

          stars.forEach( ( star ) => {

            context.beginPath();
            context.lineCap = 'round';
            context.lineWidth = STAR_SIZE * star.z * scale;
            context.globalAlpha = 0.5 + 0.5*Math.random();
            context.strokeStyle = star.color;

            context.beginPath();
            context.moveTo( star.x, star.y );

            var tailX = velocity.x * 2,
                tailY = velocity.y * 2;

            // stroke() wont work on an invisible line
            if( Math.abs( tailX ) < 0.1 ) tailX = 0.5;
            if( Math.abs( tailY ) < 0.1 ) tailY = 0.5;

            context.lineTo( star.x + tailX, star.y + tailY );

            context.stroke();

          } );

        }
    </script>
    <footer style="width: 100%; background: #fff6ed; border-top: 1px solid #e0e0e0; padding: 1rem; text-align: center; margin-top: 2rem;">
        <a href="{{ url_for('main.terms') }}" style="color: #2e7d32; text-decoration: none;">{{ _('Terms of Service') }}</a>
    </footer>
</body>
</html>