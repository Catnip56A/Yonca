<!DOCTYPE html>
<html lang="{{ current_locale.language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{{ _('Yonca - Learning Platform') }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #000;
            background-image: radial-gradient(circle at top right, rgba(121, 68, 154, 0.13), transparent),
                radial-gradient(circle at 20% 80%, rgba(41, 196, 255, 0.13), transparent);
        }

        canvas {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        header {
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 40px;
        }

        .white-overlay {
            background: #fff;
            height: 66vh;
            overflow: visible;
            border-radius: 20px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #abc32f;
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        nav {
            margin-top: 1rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover {
            background-color: #f3f4f6;
            color: #abc32f;
        }

        .nav-link.active {
            background-color: #abc32f;
            color: white;
        }

        #auth-buttons button {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #auth-buttons button:hover {
            background: #667eea;
            color: white;
        }

        #user-info button {
            background: #dc2626;
            color: white;
            border: 1px solid #dc2626;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #user-info button:hover {
            background: #b91c1c;
        }

        #admin-btn {
            background: #abc32f !important;
            border-color: #abc32f !important;
        }

        #admin-btn:hover {
            background: #9bb92a !important;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .hero {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .feature-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .feature-card h3 {
            color: #abc32f;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .gallery-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .gallery-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }

        .gallery-caption {
            padding: 1rem;
            background: #f9fafb;
            text-align: center;
            font-size: 0.9rem;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
        }

        .gallery-section {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
            background: #fff;
            border-radius: 15px;
            padding: 20px;
        }

        #about {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
        }

        .section-title {
            color: #1f2937;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 700;
        }

        .forum-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .message-form {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .message-form h3 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: #abc32f;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background: #809c13;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .forum-message {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .forum-message.current-user {
            border-color: #abc32f;
            background: #f0fdf4;
        }

        .forum-message .user {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .forum-message .message-text {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .forum-message .timestamp {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .message-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .forum-message .edit-btn,
        .forum-message .delete-btn,
        .forum-message .reply-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .forum-message .edit-btn {
            color: #abc32f;
        }

        .forum-message .edit-btn:hover {
            background-color: rgba(171, 195, 47, 0.1);
        }

        .forum-message .delete-btn {
            color: #dc3545;
        }

        .forum-message .delete-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .forum-message .reply-btn {
            color: #6b7280;
        }

        .forum-message .reply-btn:hover {
            background-color: rgba(107, 114, 128, 0.1);
        }

        .forum-message .translate-btn {
            color: #3b82f6;
        }

        .forum-message .translate-btn:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .auth-message {
            text-align: center;
            padding: 2rem;
            background: #f8fafc;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .auth-message h3 {
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
            align-items: start;
        }

        .resource-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .resource-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .resource-card.course-card {
            cursor: pointer;
        }

        .resource-card.course-card:hover .dropdown-indicator {
            color: #abc32f;
            transform: translateY(2px);
        }

        .resource-card.course-card.enrolled-course {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
        }

        .resource-card.course-card.enrolled-course:hover {
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.15);
            border-left-color: #059669;
        }

        .dropdown-indicator {
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .dropdown-indicator.active {
            color: #abc32f;
            transform: rotate(180deg);
        }

        .resource-card h4 {
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .resource-card p {
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .pdf-access-form {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
            max-width: 500px;
        }

        .pdf-upload-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .pdf-upload-section h3 {
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .status-message {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-weight: 500;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            nav {
                flex-direction: column;
                gap: 1rem;
            }

            .features {
                grid-template-columns: 1fr;
            }

            .message-actions {
                position: static;
                margin-top: 1rem;
                justify-content: flex-end;
            }
        }

        .contact-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .contact-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .contact-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .contact-item h3 {
            color: #abc32f;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .channel-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .channel-tab {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .channel-tab:hover {
            background: #e5e7eb;
        }

        .channel-tab.active {
            background: #abc32f;
            color: white;
            border-color: #abc32f;
        }

        .channel-tab.locked {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
            cursor: not-allowed;
        }

        .channel-tab.locked:hover {
            background: #fecaca;
        }

        /* Course dropdown styles */
        .course-card {
            position: relative;
            transition: all 0.3s ease;
            overflow: visible;
        }

        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .course-dropdown {
            margin-top: 15px;
            padding: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .dropdown-item:last-child {
            border-bottom: none !important;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body>
    <canvas></canvas>
    <header>
        <div class="container">
            <div class="logo">
                <img src="/static/images/Logo.jpeg" alt="Yonca Logo">
            </div>
            <nav>
                <a href="javascript:void(0)" class="nav-link active" id="home-link">{{ _('Home') }}</a>
                <a href="javascript:void(0)" class="nav-link" id="courses-link">{{ _('Courses') }}</a>
                <a href="javascript:void(0)" class="nav-link" id="forum-link">{{ _('Forum') }}</a>
                <a href="javascript:void(0)" class="nav-link" id="resources-link">{{ _('Resources') }}</a>
                <a href="javascript:void(0)" class="nav-link" id="tavi-link">{{ _('TAVI Test') }}</a>
                <a href="javascript:void(0)" class="nav-link" id="contacts-link">{{ _('Contacts') }}</a>
                <a href="javascript:void(0)" class="nav-link" id="about-link">{{ _('About Company') }}</a>
            </nav>
            <div id="auth-buttons" style="position: absolute; top: 1rem; right: 20px; display: block;">
                <button id="login-btn" onclick="window.location.href='/login'">{{ _('Login') }}</button>
            </div>
            <div id="user-info" style="position: absolute; top: 1rem; right: 20px; display: none;">
                <span style="color: #374151; margin-right: 1rem;">{{ _('Welcome') }}, <span id="user-name"></span>!</span>
                <button id="admin-btn" onclick="window.location.href='/admin'" style="margin-right: 0.5rem; display: none;">{{ _('Admin') }}</button>
                <button onclick="window.location.href='/logout'">{{ _('Logout') }}</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="white-overlay">
        <!-- Home Page -->
        <section id="home" class="page active">
            {% if is_authenticated %}
            <div class="hero">
                <h1>{{ home_content.welcome_title or _('Welcome to Yonca') }}</h1>
                <p>{{ home_content.subtitle or _('Your gateway to knowledge and community learning.') }}</p>
                <p>{{ home_content.get_started_text or _('Get Started') }}</p>
            </div>

            <div class="features">
                {% if home_content.features %}
                {% for feature in home_content.features %}
                <div class="feature-card">
                    <h3>{{ feature.title }}</h3>
                    <p>{{ feature.description }}</p>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            {% else %}
            <div class="hero">
                <h1>{{ home_content.logged_out_welcome_title or _('Welcome to Yonca') }}</h1>
                <p>{{ home_content.logged_out_subtitle or _('Join our learning community today!') }}</p>
                <p>{{ home_content.logged_out_get_started_text or _('Sign Up Now') }}</p>
            </div>

            <div class="features">
                {% if home_content.logged_out_features %}
                {% for feature in home_content.logged_out_features %}
                <div class="feature-card">
                    <h3>{{ feature.title }}</h3>
                    <p>{{ feature.description }}</p>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Gallery Section -->
            <div class="gallery-section">
                <h2 class="section-title">{{ _('Gallery') }}</h2>
                <p>{{ _('Explore our community and learning environment through these images.') }}</p>

                <div class="gallery-grid">
                    {% if home_content.gallery_images %}
                    {% for image in home_content.gallery_images %}
                    <div class="gallery-item">
                        <img src="{{ image.url }}" alt="{{ image.alt }}" loading="lazy">
                        {% if image.caption %}
                        <div class="gallery-caption">{{ image.caption }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%23abc32f' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3ELearning Community%3C/text%3E%3C/svg%3E" alt="Learning Community" loading="lazy">
                        <div class="gallery-caption">Our vibrant learning community</div>
                    </div>
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%234a90e2' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3EInteractive Courses%3C/text%3E%3C/svg%3E" alt="Interactive Courses" loading="lazy">
                        <div class="gallery-caption">Engage with interactive course content</div>
                    </div>
                    <div class="gallery-item">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='250'%3E%3Crect fill='%237ed321' width='400' height='250'/%3E%3Ctext fill='%23ffffff' font-family='Arial' font-size='24' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3EStudy Groups%3C/text%3E%3C/svg%3E" alt="Study Groups" loading="lazy">
                        <div class="gallery-caption">Collaborate in study groups</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Courses Page -->
        <section id="courses" class="page">
            <h2 class="section-title">{{ _('Courses') }}</h2>
            <p>{{ _('Explore our available courses and start your learning journey.') }}</p>

            <!-- Enrolled Courses Section (shown only for authenticated users) -->
            <div id="enrolled-courses-section" style="display: none;">
                <h3 style="color: #10b981; margin-top: 2rem; margin-bottom: 1rem;">{{ _('My Enrolled Courses') }}</h3>
                <div class="courses-grid enrolled-courses-grid">
                    <p style="text-align: center; color: #6b7280; font-style: italic;">{{ _('Loading enrolled courses...') }}</p>
                </div>
            </div>

            <!-- Available Courses Section -->
            <div id="available-courses-section">
                <h3 id="available-courses-title" style="margin-top: 2rem; margin-bottom: 1rem;">{{ _('Available Courses') }}</h3>
                <div class="courses-grid available-courses-grid">
                    <p style="text-align: center; color: #6b7280; font-style: italic;">{{ _('Loading courses...') }}</p>
                </div>
            </div>
        </section>

        <!-- Forum Page -->
        <section id="forum" class="page">
            <h2 class="section-title">{{ _('Community Forum') }}</h2>

            <div id="forum-auth-required" style="display: none;">
                <div class="auth-message">
                    <h3>üîí {{ _('Authentication Required') }}</h3>
                    <p>{{ _('Please log in to participate in the community forum.') }}</p>
                    <p>{{ _('You can still view messages without logging in.') }}</p>
                </div>
            </div>

            <div id="forum-content">
                <!-- Channel Tabs -->
                <div class="channel-tabs" style="margin-bottom: 2rem;">
                    <!-- Tabs will be loaded dynamically -->
                </div>

                <!-- Language Selection for Translation -->
                <div class="language-selector" style="margin-bottom: 2rem; background: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #1f2937;">üåê Translation Settings</h4>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label for="target-language" style="font-weight: 500; color: #374151;">Translate to:</label>
                            <select id="target-language" onchange="changeTargetLanguage()" style="margin-left: 0.5rem; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="en">English</option>
                                <option value="ru">Russian</option>
                                <option value="az">Azerbaijani</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="auto-translate" onchange="toggleAutoTranslate()" checked>
                            <label for="auto-translate" style="font-weight: 500; color: #374151;">Auto-translate messages</label>
                        </div>
                        <button onclick="translateAllVisibleMessages()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">üîÑ Translate All</button>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">Messages will be automatically translated to your selected language. Click individual messages to toggle translation.</p>
                </div>

                <div class="message-form">
                    <h3>{{ _('Post a New Message') }}</h3>
                    <form onsubmit="postMessage(event)">
                        <div class="form-group" id="username-group" style="display: none;">
                            <label for="username">{{ _('Username:') }}</label>
                            <input type="text" id="username" name="username">
                        </div>
                        <div class="form-group">
                            <label for="message">{{ _('Message:') }}</label>
                            <textarea id="message" name="message" placeholder="{{ _('Share your thoughts, ask questions, or help others...') }}" required></textarea>
                        </div>
                        <button type="submit" id="post-btn">{{ _('Post Message') }}</button>
                    </form>
                </div>

                <div class="forum-container">
                    <h3 id="channel-title">{{ _('General Discussion') }}</h3>
                    <div id="messages-container">
                        <div class="forum-message">
                            <div class="user">{{ _('Welcome to Yonca Forum!') }}</div>
                            <p>{{ _('This is where community members can connect, ask questions, and share knowledge.') }}</p>
                            <div class="timestamp">{{ _('Posted on December 8, 2025') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Resources Page -->
        <section id="resources" class="page">
            <h2 class="section-title">{{ _('Resources') }}</h2>
            <p>{{ _('Download educational materials, documents, and access protected files.') }}</p>

            <!-- Learning Materials -->
            <h3 style="color: #1f2937; margin: 2rem 0 1rem 0; font-size: 1.4rem; font-weight: 600;">üìö {{ _('Learning Materials') }}</h3>
            <div class="resources-grid">
                <p style="text-align: center; color: #6b7280; font-style: italic;">{{ _('Loading materials...') }}</p>
            </div>

            <!-- Resource Upload Section (Admin Only) -->
            <div id="resource-upload-section" style="display: none; background: #fff; border-radius: 15px; padding: 20px;">
                <h3 style="color: #1f2937; margin: 3rem 0 1rem 0; font-size: 1.4rem; font-weight: 600;">üì§ {{ _('Upload Learning Material') }}</h3>
                <p style="color: #6b7280; margin-bottom: 2rem;">{{ _('Upload documents, presentations, PDFs, or other materials. PIN protection will be automatically applied for security.') }}</p>
                <form id="resource-upload-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="resource-title">{{ _('Title:') }}</label>
                        <input type="text" id="resource-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="resource-description">{{ _('Description:') }}</label>
                        <textarea id="resource-description" name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="resource-file">{{ _('Choose file...') }}</label>
                        <input type="file" id="resource-file" name="file" required>
                    </div>
                    <div class="form-group">
                        <label for="resource-pin">{{ _('Access PIN (leave empty for auto-generated):') }}</label>
                        <input type="text" id="resource-pin" name="pin" placeholder="{{ _('Auto-generated if empty') }}">
                    </div>
                    <button type="submit" id="resource-upload-btn">{{ _('Upload Material') }}</button>
                </form>
                <div id="resource-upload-status"></div>
            </div>
        </section>

        <!-- TAVI Test Page -->
        <section id="tavi" class="page">
            <h2 class="section-title">{{ _('TAVI Test') }}</h2>
            <div class="empty-section">
                <p>{{ _('TAVI Test section is coming soon.') }}</p>
            </div>
        </section>

        <!-- Contacts Page -->
        <section id="contacts" class="page">
            <h2 class="section-title">{{ _('Contact Us') }}</h2>

            <div class="contact-info">
                <div class="contact-item">
                    <h3>üì± {{ _('WhatsApp') }}</h3>
                    <p>
                        <a href="https://wa.me/994516237394" target="_blank" style="color: #abc32f; text-decoration: none; font-weight: 500;">
                            +994 51 623 73 94
                        </a><br>
                        {{ _('Available: Mon-Fri, 9AM-6PM') }}
                    </p>
                </div>

                <div class="contact-item">
                    <h3>üìß {{ _('Email') }}</h3>
                    <p>
                        <a href="mailto:info@yonca.az" style="color: #abc32f; text-decoration: none; font-weight: 500;">
                            info@yonca.az
                        </a><br>
                        {{ _('We respond within 24 hours') }}
                    </p>
                </div>

                <div class="contact-item">
                    <h3>üìç {{ _('Location') }}</h3>
                    <p>
                        {{ _('Baku, Azerbaijan') }}<br>
                        {{ _('Serving clients worldwide') }}
                    </p>
                </div>
            </div>
        </section>

        <!-- About Company Page -->
        <section id="about" class="page">
            <h2 class="section-title">{{ _('About Yonca') }}</h2>

            <div class="about-content">
                <p>
                    {{ _('Today, Yonca Support & Development Center is one of the leading centers in Baku in the field of psychological support and correction. Our mission is to provide professional, evidence-based psychological assistance to children, adolescents and adults with developmental features (and without), as well as support for their families. The center has been operating for more than four years and during this time has become a brand of quality and reliability, associated with effectiveness, ethics and a modern approach to correction.') }}
                </p>

                <p>
                    {{ _('In our work, we rely on international standards (DSM-5-TR, ICD-11, ABA, ICF) and actively cooperate with leading specialists from different countries, primarily from Israel. Our format: "correctly, effectively and with soul". We work both offline in Baku and online worldwide, ensuring accessibility and a high level of support for each family.') }}
                </p>

                <h3>{{ _('International Team of Experts') }}</h3>
                <p>
                    {{ _('The international team of experts collaborating with Yonca includes six specialists from Israel:') }}
                </p>
                <ul style="margin-left: 2rem; color: #666;">
                    <li><strong>{{ _('Ronni Edelstein') }}</strong> - {{ _('physician-therapist, physician for diagnosis and correction of ADHD') }}</li>
                    <li><strong>{{ _('Olesia Frolova') }}</strong> - {{ _('pediatrician, nutritionist, physician for diagnosis and correction of ADHD') }}</li>
                    <li><strong>{{ _('Albert Feigelson') }}</strong> - {{ _('psychologist, behavioral analyst. Author of books and courses on working with ADHD for parents and specialists. Specialist in PCT (parent competence training). Founder of the company "ADHD_Israel"') }}</li>
                    <li><strong>{{ _('Elena Pinski-Volcman') }}</strong> - {{ _('behavioral analyst, instructor on sex education for people with developmental features') }}</li>
                    <li><strong>{{ _('Svetlana Revich') }}</strong> - {{ _('occupational therapist, BOT, M.A. specialist in child development and nutrition. Founder and director of the "Visut" center in Israel. Co-author of the SEB-method. Author of the book - "Sensory perception or Sensory glasses in child upbringing"') }}</li>
                    <li><strong>{{ _('Dan Mirdzharov') }}</strong> - {{ _('coach, specialist in working with adults with ADHD') }}</li>
                </ul>

                <p>
                    {{ _('As well as specialists from different countries:') }}
                </p>
                <ul style="margin-left: 2rem; color: #666;">
                    <li><strong>{{ _('Dr. Aysel Mammadova') }}</strong> - {{ _('clinical psychologist, ABA specialist') }}</li>
                    <li><strong>{{ _('Dr. Nigar Hajiyeva') }}</strong> - {{ _('psychiatrist, specialist in child and adolescent psychiatry') }}</li>
                    <li><strong>{{ _('Dr. Aytan Mammadova') }}</strong> - {{ _('speech therapist, specialist in speech development correction') }}</li>
                    <li><strong>{{ _('Dr. Gunel Mammadova') }}</strong> - {{ _('occupational therapist, sensory integration specialist') }}</li>
                    <li><strong>{{ _('Dr. Leyla Aliyeva') }}</strong> - {{ _('clinical psychologist, CBT specialist') }}</li>
                    <li><strong>{{ _('Dr. Samira Hasanova') }}</strong> - {{ _('child psychologist, play therapy specialist') }}</li>
                </ul>

                <h3>{{ _('Our Services') }}</h3>
                <ul style="margin-left: 2rem; color: #666;">
                    <li>{{ _('Psychological diagnostics and correction') }}</li>
                    <li>{{ _('Speech therapy services') }}</li>
                    <li>{{ _('Occupational therapy') }}</li>
                    <li>{{ _('Behavioral analysis and correction (ABA)') }}</li>
                    <li>{{ _('Parent training and support') }}</li>
                    <li>{{ _('Online consultations worldwide') }}</li>
                    <li>{{ _('School readiness programs') }}</li>
                    <li>{{ _('Social skills development') }}</li>
                </ul>

                <h3>{{ _('Contact Us') }}</h3>
                <p>
                    {{ _('For more information about our services or to schedule a consultation, please contact us:') }}
                </p>
                <p>
                    üì± <strong>{{ _('WhatsApp') }}</strong>: <a href="https://wa.me/994516237394" target="_blank" style="color: #abc32f;">+994 51 623 73 94</a><br>
                    üìß <strong>{{ _('Email') }}</strong>: <a href="mailto:info@yonca.az" style="color: #abc32f;">info@yonca.az</a>
                </p>
            </div>
        </section>
        </div>
    </main>

    <script>
        // API base URL
        const API_BASE = window.location.origin;

        // Current page management
        function showPage(pageId, event) {
            console.log('showPage called with pageId:', pageId, 'event:', event);
            
            // Prevent default if event is provided
            if (event && typeof event.preventDefault === 'function') {
                event.preventDefault();
                console.log('Prevented default event');
            }

            console.log('Hiding all pages...');
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            console.log('Found', pages.length, 'pages');
            pages.forEach(page => {
                page.classList.remove('active');
                console.log('Removed active from page:', page.id);
            });

            console.log('Removing active from all nav links...');
            // Remove active class from all nav links
            const navLinks = document.querySelectorAll('.nav-link');
            console.log('Found', navLinks.length, 'nav links');
            navLinks.forEach(link => {
                link.classList.remove('active');
                console.log('Removed active from link:', link.id);
            });

            // Show selected page
            const pageElement = document.getElementById(pageId);
            const linkElement = document.getElementById(pageId + '-link');
            
            if (pageElement) {
                pageElement.classList.add('active');
                console.log('Activated page:', pageId);
            } else {
                console.error('Page element not found:', pageId);
                return;
            }
            
            if (linkElement) {
                linkElement.classList.add('active');
                console.log('Activated link:', pageId + '-link');
            } else {
                console.error('Link element not found:', pageId + '-link');
            }

            // Load data for specific pages
            if (pageId === 'courses') {
                console.log('Loading courses...');
                loadCourses();
                // Refresh dropdowns in case they were populated before auth check completed
                setTimeout(() => refreshCourseDropdowns(), 100);
            } else if (pageId === 'forum') {
                console.log('Loading forum...');
                loadForumChannels();
            } else if (pageId === 'resources') {
                console.log('Loading resources...');
                loadResources();
            }
            
            console.log('showPage completed for:', pageId);
        }

        // Load courses
        async function loadCourses() {
            // Define translated strings to avoid Jinja2 conflicts in JavaScript
            const enrolledAllCoursesText = "{{ _('You\'re enrolled in all available courses!') }}";
            const errorLoadingCoursesText = "{{ _('Error loading courses. Please try again.') }}";
            const availableCoursesText = "{{ _('Available Courses') }}";
            
            try {
                const response = await fetch(`${API_BASE}/api/courses`);
                const courses = await response.json();

                // Clear both grids
                const enrolledGrid = document.querySelector('.enrolled-courses-grid');
                const availableGrid = document.querySelector('.available-courses-grid');
                const enrolledSection = document.getElementById('enrolled-courses-section');
                const availableTitle = document.getElementById('available-courses-title');

                enrolledGrid.innerHTML = '';
                availableGrid.innerHTML = '';

                if (courses.length === 0) {
                    availableGrid.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">{{ _("No courses available at the moment.") }}</p>';
                    return;
                }

                // Separate courses based on enrollment status
                let enrolledCourses = [];
                let availableCourses = [];

                if (window.currentUser) {
                    // For authenticated users, separate enrolled and available courses
                    enrolledCourses = courses.filter(course => course.is_enrolled);
                    availableCourses = courses.filter(course => !course.is_enrolled);

                    // Show enrolled courses section if user has enrolled courses
                    if (enrolledCourses.length > 0) {
                        enrolledSection.style.display = 'block';
                        availableTitle.textContent = '{{ _("Other Available Courses") }}';
                    } else {
                        enrolledSection.style.display = 'none';
                        availableTitle.textContent = '{{ _("Available Courses") }}';
                    }
                } else {
                    // For non-authenticated users, all courses are "available"
                    availableCourses = courses;
                    enrolledSection.style.display = 'none';
                    availableTitle.textContent = availableCoursesText;
                }

                // Render enrolled courses
                if (enrolledCourses.length > 0) {
                    enrolledCourses.forEach(course => {
                        const courseCard = createCourseCard(course, true); // true = enrolled
                        enrolledGrid.appendChild(courseCard);
                    });
                }

                // Render available courses
                if (availableCourses.length > 0) {
                    availableCourses.forEach(course => {
                        const courseCard = createCourseCard(course, false); // false = not enrolled
                        availableGrid.appendChild(courseCard);
                    });
                } else if (window.currentUser && enrolledCourses.length > 0) {
                    availableGrid.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">' + enrolledAllCoursesText + '</p>';
                }

            } catch (error) {
                console.error('Error loading courses:', error);
                document.querySelector('.available-courses-grid').innerHTML = '<p style="text-align: center; color: #dc2626;">' + errorLoadingCoursesText + '</p>';
            }
        }

        // Create course card with enrollment styling
        function createCourseCard(course, isEnrolled) {
            const courseCard = document.createElement('div');
            courseCard.className = `resource-card course-card ${isEnrolled ? 'enrolled-course' : ''}`;
            courseCard.style.cursor = 'pointer';

            const enrolledBadge = isEnrolled ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">‚úì ENROLLED</span>' : '';

            // Only show dropdown elements for non-enrolled users
            const dropdownElements = isEnrolled ? '' : `
                <div style="margin-top: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <span>${course.profile_emoji || 'üìö'}</span>
                    <span class="dropdown-indicator" style="font-size: 14px; color: #6b7280; margin-left: 8px;">‚ñº</span>
                </div>
                <div class="course-dropdown" style="display: none;"></div>
            `;

            courseCard.innerHTML = `
                <h4>${course.title} ${enrolledBadge}</h4>
                <p>${course.description}</p>
                <p><strong>Time Slot:</strong> ${course.time_slot || 'TBD'}</p>
                ${dropdownElements}
            `;

            // Add special styling for enrolled courses
            if (isEnrolled) {
                courseCard.style.borderLeft = '4px solid #10b981';
                courseCard.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02))';
            }

            // Make course card clickable
            courseCard.addEventListener('click', function(e) {
                e.stopPropagation();

                // If user is enrolled in this course, go directly to student menu
                if (window.currentUser && isEnrolled) {
                    const courseSlug = course.title.toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-') // Replace multiple hyphens with single
                        .trim(); // Remove leading/trailing whitespace
                    window.location.href = `/course/${courseSlug}-${course.id}`;
                    return;
                }

                // For non-enrolled users, show dropdown menu
                const dropdown = this.querySelector('.course-dropdown');
                const indicator = this.querySelector('.dropdown-indicator');

                // Hide other dropdowns
                document.querySelectorAll('.course-dropdown').forEach(d => {
                    if (d !== dropdown) {
                        d.style.display = 'none';
                        d.closest('.course-card').querySelector('.dropdown-indicator').classList.remove('active');
                    }
                });

                // Toggle this dropdown
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    indicator.classList.add('active');
                    populateCourseDropdown(dropdown, course, isEnrolled);
                } else {
                    dropdown.style.display = 'none';
                    indicator.classList.remove('active');
                }
            });

            return courseCard;
        }

        // Populate course dropdown menu
        function populateCourseDropdown(dropdown, course, isEnrolled = false) {
            dropdown.innerHTML = '';

            let menuItems = [];

            // Check if user authentication has been determined
            // If window.currentUser is undefined, it means checkUser() hasn't completed yet
            if (typeof window.currentUser === 'undefined') {
                // Authentication check still pending - show loading or default state
                const courseSlug = course.title.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                    .replace(/\s+/g, '-') // Replace spaces with hyphens
                    .replace(/-+/g, '-') // Replace multiple hyphens with single
                    .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                    .trim();
                menuItems = [
                    { text: '{{ _("Loading...") }}', icon: '‚è≥', url: '#' },
                    { text: '{{ _("View Details") }}', icon: 'üìñ', url: '/course/' + courseSlug + '-' + course.id }
                ];
            } else if (window.currentUser) {
                // User is logged in
                if (isEnrolled) {
                    // User is enrolled in this course - dropdown should not be shown for enrolled users
                    // The entire card will be clickable instead
                    return; // Don't populate dropdown for enrolled users
                } else {
                    // User is logged in but not enrolled
                    const courseSlug = course.title.toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-') // Replace multiple hyphens with single
                        .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                        .trim();
                    menuItems = [
                        { text: '{{ _("Enroll Now") }}', icon: '‚úÖ', url: '/course/' + courseSlug + '-' + course.id },
                        { text: '{{ _("View Details") }}', icon: 'üìñ', url: '/course/' + courseSlug + '-' + course.id }
                    ];
                }
            } else {
                // User is not logged in
                const courseSlug = course.title.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                    .replace(/\s+/g, '-') // Replace spaces with hyphens
                    .replace(/-+/g, '-') // Replace multiple hyphens with single
                    .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                    .trim();
                menuItems = [
                    { text: '{{ _("Login to Enroll") }}', icon: 'üîê', url: '/login' },
                    { text: '{{ _("View Details") }}', icon: 'üìñ', url: '/course/' + courseSlug + '-' + course.id }
                ];
            }

            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'dropdown-item';
                menuItem.style.padding = '10px 15px';
                menuItem.style.cursor = 'pointer';
                menuItem.style.borderBottom = '1px solid #eee';
                menuItem.style.display = 'flex';
                menuItem.style.alignItems = 'center';
                menuItem.innerHTML = `<span style="margin-right: 10px;">${item.icon || 'üîó'}</span>${item.text}`;

                menuItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (item.url && item.url !== '#') {
                        // Replace {description} placeholder with course slug
                        let url = item.url;
                        if (url.includes('{description}')) {
                            const courseSlug = course.title.toLowerCase()
                                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                                .replace(/\s+/g, '-') // Replace spaces with hyphens
                                .replace(/-+/g, '-') // Replace multiple hyphens with single
                                .trim(); // Remove leading/trailing whitespace
                            url = url.replace('{description}', `${courseSlug}-${course.id}`);
                        }
                        window.location.href = url;
                    } else {
                        handleCourseAction('details', course);
                    }
                    dropdown.style.display = 'none';
                });

                menuItem.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });

                menuItem.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'white';
                });

                dropdown.appendChild(menuItem);
            });
        }

        // Handle course actions
        function handleCourseAction(action, course) {
            switch (action) {
                case 'details':
                    // Navigate to course page
                    const courseSlug = course.title.toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .replace(/-+/g, '-') // Replace multiple hyphens with single
                        .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
                        .trim();
                    window.location.href = `/course/${courseSlug}-${course.id}`;
                    break;
                case 'enroll':
                    if (window.currentUser) {
                        alert(`{{ _("Enrolling in") }}: ${course.title}`);
                        // TODO: Implement enrollment logic
                    } else {
                        window.location.href = '/login';
                    }
                    break;
                case 'contact':
                    // Scroll to contact section
                    const contactSection = document.getElementById('contact');
                    if (contactSection) {
                        contactSection.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        window.location.href = '/#contact';
                    }
                    break;
                case 'login':
                    window.location.href = '/login';
                    break;
                default:
                    console.log('Unknown action:', action);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.course-card')) {
                document.querySelectorAll('.course-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });

        // Load resources
        async function loadResources() {
            try {
                const response = await fetch(`${API_BASE}/api/resources`);
                const resources = await response.json();
                const resourcesGrid = document.querySelector('.resources-grid');
                resourcesGrid.innerHTML = '';

                if (resources.length === 0) {
                    resourcesGrid.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">{{ _("No materials available at the moment.") }}</p>';
                    return;
                }

                resources.forEach(resource => {
                    const resourceCard = document.createElement('div');
                    resourceCard.className = 'resource-card';
                    
                    // Check if current user uploaded this resource
                    const isUploader = window.currentUser && resource.uploaded_by === window.currentUser.id;
                    
                    if (resource.has_pin) {
                        // PIN-protected resource
                        let accessButton = '';
                        if (isUploader && resource.access_pin) {
                            // Show PIN to uploader
                            accessButton = `<div style="background: #f0f9ff; border: 1px solid #0ea5e9; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem;">
                                <strong style="color: #0ea5e9;">{{ _('Your Access PIN:') }}</strong> 
                                <span style="font-family: monospace; font-size: 1.1em; color: #1e40af; background: #e0f2fe; padding: 0.25rem 0.5rem; border-radius: 3px; margin-left: 0.5rem;">${resource.access_pin}</span>
                                <br><small style="color: #64748b;">{{ _('Share this PIN with others to grant access') }}</small>
                            </div>
                            <a href="${resource.file_url}" target="_blank" style="background: #059669; color: white; text-decoration: none; border: 1px solid #059669; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 500; transition: all 0.3s ease; display: inline-block; margin-top: 0.5rem;">{{ _('Download') }}</a>`;
                        } else {
                            // Show request access button to others
                            accessButton = `<button onclick="requestResourceAccess(${resource.id}, '${resource.title}')" style="background: #abc32f; color: white; border: 1px solid #abc32f; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">{{ _('Request Access') }}</button>`;
                        }
                        
                        resourceCard.innerHTML = `
                            <h4>${resource.title} üîí</h4>
                            <p>${resource.description || '{{ _("No description available") }}'}</p>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">
                                {{ _('Uploaded:') }} ${new Date(resource.upload_date).toLocaleDateString()}
                            </p>
                            ${accessButton}
                        `;
                    } else {
                        // Public resource
                        resourceCard.innerHTML = `
                            <h4>${resource.title}</h4>
                            <p>${resource.description || '{{ _("No description available") }}'}</p>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">
                                {{ _('Uploaded:') }} ${new Date(resource.upload_date).toLocaleDateString()}
                            </p>
                            <a href="${resource.file_url}" target="_blank" style="background: #abc32f; color: white; text-decoration: none; border: 1px solid #abc32f; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 500; transition: all 0.3s ease; display: inline-block;">{{ _('Download') }}</a>
                        `;
                    }
                    
                    resourcesGrid.appendChild(resourceCard);
                });
            } catch (error) {
                console.error('Error loading resources:', error);
                document.querySelector('.resources-grid').innerHTML = '<p style="text-align: center; color: #dc2626;">{{ _("Error loading materials. Please try again.") }}</p>';
            }
        }

        // Load PDFs
        async function loadPDFs() {
            try {
                const response = await fetch(`${API_BASE}/api/pdfs`);
                const pdfs = await response.json();
                
                const pdfsList = document.getElementById('pdfs-list');
                pdfsList.innerHTML = '';

                if (pdfs.length === 0) {
                    pdfsList.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">{{ _("No PDF documents available at the moment.") }}</p>';
                    return;
                }

                pdfs.forEach(pdf => {
                    const pdfCard = document.createElement('div');
                    pdfCard.className = 'resource-card';
                    
                    // Check if current user uploaded this PDF
                    const isUploader = window.currentUser && pdf.uploaded_by === window.currentUser.id;
                    
                    let accessButton = '';
                    if (isUploader && pdf.access_pin) {
                        // Show PIN to uploader
                        accessButton = `<div style="background: #f0f9ff; border: 1px solid #0ea5e9; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem;">
                            <strong style="color: #0ea5e9;">{{ _('Your Access PIN:') }}</strong> 
                            <span style="font-family: monospace; font-size: 1.1em; color: #1e40af; background: #e0f2fe; padding: 0.25rem 0.5rem; border-radius: 3px; margin-left: 0.5rem;">${pdf.access_pin}</span>
                            <br><small style="color: #64748b;">{{ _('Share this PIN with others to grant access') }}</small>
                        </div>
                        <button onclick="requestPDFAccess(${pdf.id}, '${pdf.title}')" style="background: #059669; color: white; border: 1px solid #059669; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; margin-top: 0.5rem;">{{ _('Access PDF') }}</button>`;
                    } else {
                        // Show request access button to others
                        accessButton = `<button onclick="requestPDFAccess(${pdf.id}, '${pdf.title}')" style="background: #abc32f; color: white; border: 1px solid #abc32f; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">{{ _('Request Access') }}</button>`;
                    }
                    
                    pdfCard.innerHTML = `
                        <h4>${pdf.title}</h4>
                        <p>${pdf.description || '{{ _("No description available") }}'}</p>
                        <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">
                            {{ _('Uploaded:') }} ${new Date(pdf.upload_date).toLocaleDateString()}
                        </p>
                        ${accessButton}
                    `;
                    pdfsList.appendChild(pdfCard);
                });
            } catch (error) {
                console.error('Error loading PDFs:', error);
                document.getElementById('pdfs-list').innerHTML = '<p style="text-align: center; color: #dc2626;">{{ _("Error loading PDFs. Please try again.") }}</p>';
            }
        }

        // Request resource access
        function requestResourceAccess(resourceId, title) {
            const pin = prompt(`{{ _('Enter access PIN for:') }} ${title}`);
            if (pin && pin.trim()) {
                accessResourceById(resourceId, pin.trim());
            }
        }

        // Access resource by ID and PIN
        async function accessResourceById(resourceId, pin) {
            try {
                // Use the download URL with PIN embedded for direct access
                const downloadUrl = `${API_BASE}/api/resources/${resourceId}/download/${pin}`;
                window.open(downloadUrl, '_blank');
            } catch (error) {
                console.error('Error accessing resource:', error);
                alert('{{ _("Error accessing resource. Please try again.") }}');
            }
        }

        // Upload PDF
        async function uploadPDF(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('pdf-upload-btn');
            const statusDiv = document.getElementById('pdf-upload-status');

            submitBtn.disabled = true;
            submitBtn.textContent = '{{ _("Uploading PDF...") }}';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span style="color: #6b7280;">{{ _("Uploading PDF...") }}</span>';

            try {
                const response = await fetch(`${API_BASE}/api/pdfs/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = `<span style="color: #059669;">‚úÖ {{ _("PDF uploaded successfully! Access PIN:") }} <strong>${result.pin}</strong></span>`;

                    // Clear form
                    form.reset();

                    // Reload PDFs
                    loadPDFs();
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå {{ _("Error uploading PDF. Please try again.") }}</span>`;
                }
            } catch (error) {
                console.error('Error uploading PDF:', error);
                statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå {{ _("Error uploading PDF. Please try again.") }}</span>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '{{ _("Upload PDF") }}';
            }
        }

        // Upload resource
        async function uploadResource(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('resource-upload-btn');
            const statusDiv = document.getElementById('resource-upload-status');

            submitBtn.disabled = true;
            submitBtn.textContent = '{{ _("Uploading...") }}';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span style="color: #6b7280;">{{ _("Uploading resource...") }}</span>';

            try {
                const response = await fetch(`${API_BASE}/api/resources`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = `<span style="color: #059669;">‚úÖ {{ _("Material uploaded successfully! Access PIN:") }} <strong>${result.pin}</strong></span>`;

                    // Clear form
                    form.reset();

                    // Reload resources
                    loadResources();
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå ${result.error || '{{ _("Error uploading material. Please try again.") }}'}</span>`;
                }
            } catch (error) {
                console.error('Error uploading resource:', error);
                statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå {{ _("Error uploading resource. Please try again.") }}</span>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '{{ _("Upload Material") }}';
            }
        }

        // Forum functionality
        let currentChannel = 'general';
        let availableChannels = [];

        // Translation functionality
        let targetLanguage = 'en';
        let autoTranslateEnabled = false; // Start with false, will be set by checkbox
        let currentLanguageIndex = 0;
        const availableLanguages = [
            {code: 'en', name: 'EN', flag: 'üåê'},
            {code: 'ru', name: 'RU', flag: 'üá∑üá∫'},
            {code: 'az', name: 'AZ', flag: 'üá¶üáø'}
        ];

        // Forum translation variables only

        async function loadForumChannels() {
            try {
                const response = await fetch(`${API_BASE}/api/forum/channels`);
                const channels = await response.json();
                availableChannels = channels;
                
                // Build channel tabs dynamically
                const channelTabsContainer = document.querySelector('.channel-tabs');
                channelTabsContainer.innerHTML = '';
                
                channels.forEach((channel, index) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'channel-tab' + (index === 0 ? ' active' : '');
                    tabButton.setAttribute('data-channel', channel.slug);
                    tabButton.textContent = channel.name;
                    
                    // Handle channel visibility and access
                    if (channel.admin_only) {
                        // Admin-only channels
                        if (!window.currentUser || !window.currentUser.is_admin) {
                            return; // Don't show this tab to non-admins
                        }
                    } else if (channel.requires_login) {
                        // Login-required channels
                        if (!window.currentUser) {
                            tabButton.classList.add('locked');
                            tabButton.disabled = true;
                        }
                    }
                    // Public channels are always shown and enabled
                    
                    channelTabsContainer.appendChild(tabButton);
                });
                
                // Add event listeners to new tabs
                document.querySelectorAll('.channel-tab').forEach(tab => {
                    tab.addEventListener('click', (event) => {
                        const channel = event.target.getAttribute('data-channel');
                        switchChannel(channel);
                    });
                });
                
                // Load messages for the first channel
                if (channels.length > 0) {
                    currentChannel = channels[0].slug;
                    updateForumAuth(); // Update form visibility for the initial channel
                    loadForumMessages(currentChannel);
                }
            } catch (error) {
                console.error('Error loading forum channels:', error);
                // Fallback to default behavior
                loadForumMessages(currentChannel);
            }
        }

        function switchChannel(channel) {
            // Check permissions
            const channelObj = availableChannels.find(c => c.slug === channel);
            if (channelObj) {
                if (channelObj.admin_only && (!window.currentUser || !window.currentUser.is_admin)) {
                    alert('Admin access required for this channel');
                    return;
                } else if (channelObj.requires_login && !window.currentUser) {
                    alert('Authentication required for this channel');
                    return;
                }
            }
            
            currentChannel = channel;
            
            // Update active tab
            document.querySelectorAll('.channel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-channel="${channel}"]`).classList.add('active');
            
            // Update channel title
            document.getElementById('channel-title').textContent = channelObj ? channelObj.name : channel;
            
            // Update form visibility based on channel permissions
            updateForumAuth();
            
            // Load messages for this channel
            loadForumMessages(channel);
        }

        async function loadForumMessages(channel = 'general') {
            try {
                const response = await fetch(`${API_BASE}/api/forum/messages?channel=${channel}`);
                const data = await response.json();
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';

                // Extract messages from the response object
                const messages = data.messages || [];

                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<div class="forum-message"><div class="user">No messages yet</div><p>Be the first to start a conversation!</p></div>';
                    return;
                }

                function renderMessage(message, container, depth = 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'forum-message' + (message.is_current_user ? ' current-user' : '');
                    messageDiv.setAttribute('data-message-id', message.id);
                    messageDiv.setAttribute('data-original-text', message.message);
                    messageDiv.setAttribute('data-translated-text', '');
                    messageDiv.setAttribute('data-translation-shown', 'false');
                    messageDiv.style.marginLeft = `${depth * 20}px`;

                    let actionsHtml = '';
                    // Show reply button for all users (logged in and anonymous)
                    actionsHtml = `
                        <div class="message-actions">
                            <button onclick="replyToMessage(${message.id}, '${message.username}', '${message.channel}')" class="reply-btn">üí¨ Reply</button>
                            <button onclick="toggleTranslation(${message.id})" class="translate-btn" title="Toggle translation">üåê Translate</button>
                    `;

                    // Show edit/delete buttons only for message owner or admin
                    if (window.currentUser && (message.is_current_user || window.currentUser.is_admin)) {
                        actionsHtml += `
                            <button onclick="editMessage(${message.id}, '${message.message.replace(/'/g, "\\'")}')" class="edit-btn">‚úèÔ∏è Edit</button>
                            <button onclick="deleteMessage(${message.id})" class="delete-btn">üóëÔ∏è Delete</button>
                        `;
                    }

                    actionsHtml += '</div>';

                    messageDiv.innerHTML = `
                        <div class="user">${message.username}${message.is_current_user ? ' (You)' : ''}</div>
                        <p class="message-text" id="message-text-${message.id}">${message.message}</p>
                        <div class="timestamp">Posted on ${new Date(message.timestamp).toLocaleDateString()} at ${new Date(message.timestamp).toLocaleTimeString()}</div>
                        ${actionsHtml}
                    `;
                    container.appendChild(messageDiv);

                    // Note: Auto-translation is handled by toggleAutoTranslate when the setting changes
                    // Individual translation is handled by the translate button

                    // Render replies
                    if (message.replies && message.replies.length > 0) {
                        message.replies.forEach(reply => renderMessage(reply, container, depth + 1));
                    }
                }

                messages.forEach(message => renderMessage(message, messagesContainer));

                // Apply auto-translation if enabled after messages are loaded
                if (autoTranslateEnabled) {
                    setTimeout(() => translateAllVisibleMessages(), 100); // Small delay to ensure DOM is ready
                }
            } catch (error) {
                console.error('Error loading forum messages:', error);
            }
        }

        async function postMessage(event) {
            event.preventDefault();

            const message = document.getElementById('message').value.trim();
            const username = document.getElementById('username').value.trim();

            if (message === '') {
                alert('Please enter a message');
                return;
            }

            // Check if user can post to this channel
            const channelObj = availableChannels.find(c => c.slug === currentChannel);
            if (channelObj && channelObj.requires_login && !window.currentUser) {
                alert('Please log in to post to this channel');
                return;
            }

            if (!window.currentUser && !username) {
                alert('Please enter a username');
                return;
            }

            const postBtn = document.getElementById('post-btn');
            const originalText = postBtn.textContent;
            postBtn.textContent = 'Posting...';
            postBtn.disabled = true;

            try {
                const requestData = { 
                    message,
                    channel: currentChannel
                };
                
                if (!window.currentUser) {
                    requestData.username = username;
                }

                const response = await fetch(`${API_BASE}/api/forum/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(requestData),
                });

                if (response.ok) {
                    // Reload messages
                    loadForumMessages(currentChannel);
                    // Clear form
                    document.getElementById('message').value = '';
                    if (!window.currentUser) {
                        document.getElementById('username').value = '';
                    }
                    alert('Message posted successfully!');
                } else if (response.status === 401 || response.status === 403) {
                    alert('You do not have permission to post to this channel');
                } else {
                    const error = await response.json();
                    alert('Error posting message: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error posting message:', error);
                alert('Error posting message. Please try again.');
            } finally {
                postBtn.textContent = originalText;
                postBtn.disabled = false;
            }
        }

        async function replyToMessage(parentId, parentUsername, channel) {
            let replyMessage = prompt(`Reply to ${parentUsername}:`, '');
            if (replyMessage === null || replyMessage.trim() === '') {
                return;
            }

            let username = null;
            if (!window.currentUser) {
                // Anonymous user - ask for username
                username = prompt('Enter your username:', '');
                if (username === null || username.trim() === '') {
                    alert('Username is required for anonymous posting');
                    return;
                }
                username = username.trim();
            }

            try {
                const requestData = {
                    message: replyMessage.trim(),
                    parent_id: parentId,
                    channel: channel
                };
                
                if (!window.currentUser) {
                    requestData.username = username;
                }

                const response = await fetch(`${API_BASE}/api/forum/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(requestData),
                });

                if (response.ok) {
                    // Reload messages to show the new reply
                    loadForumMessages(currentChannel);
                    alert('Reply posted successfully!');
                } else if (response.status === 401 || response.status === 403) {
                    alert('You do not have permission to reply to messages in this channel');
                } else {
                    const error = await response.json();
                    alert('Error posting reply: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error posting reply:', error);
                alert('Error posting reply. Please try again.');
            }
        }

        async function editMessage(messageId, currentMessage) {
            const newMessage = prompt('Edit your message:', currentMessage);
            if (newMessage === null || newMessage.trim() === '' || newMessage.trim() === currentMessage) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/forum/messages/${messageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ message: newMessage.trim() }),
                });

                if (response.ok) {
                    loadForumMessages(currentChannel);
                    alert('Message updated successfully!');
                } else {
                    const error = await response.json();
                    alert('Error updating message: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error editing message:', error);
                alert('Error updating message. Please try again.');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/forum/messages/${messageId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin',
                });

                if (response.ok) {
                    loadForumMessages(currentChannel);
                    alert('Message deleted successfully!');
                } else {
                    const error = await response.json();
                    alert('Error deleting message: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message. Please try again.');
            }
        }

        // Refresh all course dropdowns with current user authentication status
        function refreshCourseDropdowns() {
            // Find all course cards and refresh their dropdowns if they're open
            const courseCards = document.querySelectorAll('.course-card');
            courseCards.forEach((card, index) => {
                const dropdown = card.querySelector('.course-dropdown');
                if (dropdown && dropdown.style.display !== 'none') {
                    // Check if this card has enrolled styling
                    const isEnrolled = card.classList.contains('enrolled-course');
                    
                    // Create a mock course object - in a real implementation, 
                    // you'd store the full course data in the DOM or have a global courses array
                    const courseTitle = card.querySelector('h4')?.textContent?.replace('‚úì ENROLLED', '').trim() || 'Course';
                    const courseDesc = card.querySelectorAll('p')[0]?.textContent || '';
                    const timeSlot = card.querySelectorAll('p')[1]?.textContent?.replace('Time Slot: ', '') || 'TBD';
                    
                    const mockCourse = { 
                        title: courseTitle, 
                        description: courseDesc,
                        time_slot: timeSlot,
                        dropdown_menu: null,
                        id: index + 1 // Simple ID for URL generation
                    };
                    
                    populateCourseDropdown(dropdown, mockCourse, isEnrolled);
                }
            });
        }
        async function checkUser() {
            try {
                console.log('Checking user login status...');
                const response = await fetch(`${API_BASE}/api/user`, {
                    credentials: 'include'
                });
                console.log('User check response status:', response.status);
                if (response.ok) {
                    const user = await response.json();
                    console.log('User data received:', user);
                    if (user) {
                        // User is logged in
                        console.log('User logged in:', user);
                        document.getElementById('auth-buttons').style.display = 'none';
                        document.getElementById('user-info').style.display = 'block';
                        document.getElementById('user-name').textContent = user.username;
                        window.currentUser = user;
                        updateForumForm(true);
                        showHomeCourses(user.courses);

                        // Set user's preferred language
                        if (user.preferred_language) {
                            targetLanguage = user.preferred_language;
                            const languageSelect = document.getElementById('target-language');
                            if (languageSelect) {
                                languageSelect.value = user.preferred_language;
                            }
                        }

                        // Show admin button for admin users
                        if (user.is_admin) {
                            document.getElementById('admin-btn').style.display = 'inline-block';
                            document.getElementById('resource-upload-section').style.display = 'block';
                        } else {
                            document.getElementById('admin-btn').style.display = 'none';
                            document.getElementById('resource-upload-section').style.display = 'none';
                        }
                        
                        // Load forum messages for authenticated user
                        loadForumMessages(currentChannel);
                        
                        // Refresh course dropdowns with authenticated user context
                        refreshCourseDropdowns();
                    } else {
                        // User is not logged in - anonymous visitor
                        console.log('User is not logged in (anonymous visitor)');
                        document.getElementById('auth-buttons').style.display = 'block';
                        document.getElementById('user-info').style.display = 'none';
                        document.getElementById('admin-btn').style.display = 'none';
                        window.currentUser = null;
                        updateForumForm(false);
                        hideHomeCourses();
                        // Hide resource upload section for anonymous users
                        document.getElementById('resource-upload-section').style.display = 'none';
                        
                        // Load forum messages for anonymous user
                        loadForumMessages(currentChannel);
                        
                        // Refresh course dropdowns with anonymous user context
                        refreshCourseDropdowns();
                    }
                } else {
                    // API error
                    console.warn('API error checking user status:', response.status);
                    document.getElementById('auth-buttons').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('admin-btn').style.display = 'none';
                    window.currentUser = null;
                    updateForumForm(false);
                    hideHomeCourses();
                    document.getElementById('resource-upload-section').style.display = 'none';
                    
                    // Load forum messages for anonymous user (API error)
                    loadForumMessages(currentChannel);
                }
            } catch (error) {
                console.error('Network error checking user:', error);
                // Assume anonymous user on network errors
                document.getElementById('auth-buttons').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('admin-btn').style.display = 'none';
                window.currentUser = null;
                updateForumForm(false);
                hideHomeCourses();
                document.getElementById('resource-upload-section').style.display = 'none';
                
                // Load forum messages for anonymous user (network error)
                loadForumMessages(currentChannel);
            }
        }

        function updateForumForm(isLoggedIn) {
            const usernameGroup = document.getElementById('username-group');
            if (isLoggedIn) {
                usernameGroup.style.display = 'none';
            } else {
                usernameGroup.style.display = 'block';
            }
            updateForumAuth();
        }

        function updateForumAuth() {
            const authRequired = document.getElementById('forum-auth-required');
            const forumContent = document.getElementById('forum-content');
            const messageForm = document.querySelector('.message-form');
            const usernameGroup = document.getElementById('username-group');
            const membersTab = document.getElementById('members-tab');
            const staffTab = document.getElementById('staff-tab');

            if (window.currentUser) {
                // User is logged in - show full forum
                authRequired.style.display = 'none';
                forumContent.style.display = 'block';
                
                // Show form based on channel permissions
                const currentChannelObj = availableChannels.find(c => c.slug === currentChannel);
                if (currentChannelObj) {
                    if (currentChannelObj.admin_only && !window.currentUser.is_admin) {
                        // Admin-only channels require admin access
                        if (messageForm) messageForm.style.display = 'none';
                    } else {
                        // User can post in this channel
                        if (messageForm) messageForm.style.display = 'block';
                    }
                } else {
                    if (messageForm) messageForm.style.display = 'block';
                }
                
                usernameGroup.style.display = 'none';
            } else {
                // User is not logged in
                authRequired.style.display = 'none';
                forumContent.style.display = 'block';
                
                // Check if current channel allows anonymous posting
                const currentChannelObj = availableChannels.find(c => c.slug === currentChannel);
                if (currentChannelObj && !currentChannelObj.requires_login && !currentChannelObj.admin_only) {
                    // Public channel - show form for anonymous posting
                    if (messageForm) messageForm.style.display = 'block';
                    usernameGroup.style.display = 'block';
                } else {
                    // Private channel - hide form
                    if (messageForm) messageForm.style.display = 'none';
                    usernameGroup.style.display = 'none';
                }
                
                // If current channel is private, switch to general
                if (currentChannel === 'members' || currentChannel === 'staff') {
                    switchChannel('general');
                }
            }
        }

        function showHomeCourses(courses) {
            // Implementation for showing user courses on home page
            console.log('User courses:', courses);
        }

        function hideHomeCourses() {
            // Implementation for hiding courses when not logged in
            console.log('Hiding courses');
        }

        // Translation functions
        function changeTargetLanguage() {
            const select = document.getElementById('target-language');
            targetLanguage = select.value;
            console.log('Target language changed to:', targetLanguage);

            // Re-translate all visible messages if auto-translate is enabled
            if (autoTranslateEnabled) {
                translateAllVisibleMessages();
            }
        }

        function toggleAutoTranslate() {
            const checkbox = document.getElementById('auto-translate');
            autoTranslateEnabled = checkbox.checked;

            if (autoTranslateEnabled) {
                translateAllVisibleMessages();
            } else {
                // Show original text for all messages
                const messageElements = document.querySelectorAll('.forum-message');
                messageElements.forEach(element => {
                    const messageId = element.getAttribute('data-message-id');
                    const originalText = element.getAttribute('data-original-text');
                    if (originalText) {
                        const messageTextElement = document.getElementById(`message-text-${messageId}`);
                        if (messageTextElement) {
                            messageTextElement.textContent = originalText;
                            element.setAttribute('data-translation-shown', 'false');
                        }
                    }
                });
            }
        }







        async function translateMessage(messageId, text) {
            if (!text || !text.trim()) return;

            try {
                const response = await fetch(`${API_BASE}/api/translate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        target_language: targetLanguage
                    })
                });

                const data = await response.json();
                if (data.translated_text) {
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.setAttribute('data-translated-text', data.translated_text);
                        // Always update the display when called for auto-translation
                        const messageTextElement = document.getElementById(`message-text-${messageId}`);
                        if (messageTextElement) {
                            messageTextElement.textContent = data.translated_text;
                            messageElement.setAttribute('data-translation-shown', 'true');
                        }
                    }
                }
            } catch (error) {
                // Translation error handled silently
            }
        }

        function toggleTranslation(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;

            const originalText = messageElement.getAttribute('data-original-text');
            const translatedText = messageElement.getAttribute('data-translated-text');
            const currentlyShowingTranslation = messageElement.getAttribute('data-translation-shown') === 'true';
            const messageTextElement = document.getElementById(`message-text-${messageId}`);

            if (!messageTextElement) return;

            if (currentlyShowingTranslation) {
                // Show original text
                messageTextElement.textContent = originalText;
                messageElement.setAttribute('data-translation-shown', 'false');
            } else {
                // Show translated text
                if (translatedText) {
                    messageTextElement.textContent = translatedText;
                    messageElement.setAttribute('data-translation-shown', 'true');
                } else {
                    // Need to translate first
                    const textToTranslate = originalText;
                    translateMessage(messageId, textToTranslate);
                }
            }
        }

        async function translateAllVisibleMessages() {
            const messageElements = document.querySelectorAll('.forum-message');
            const textsToTranslate = [];

            messageElements.forEach(element => {
                const messageId = element.getAttribute('data-message-id');
                const originalText = element.getAttribute('data-original-text');
                if (originalText && originalText.trim()) {
                    textsToTranslate.push({
                        id: messageId,
                        text: originalText
                    });
                }
            });

            if (textsToTranslate.length === 0) return;

            try {
                const response = await fetch(`${API_BASE}/api/translate/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        texts: textsToTranslate.map(item => item.text),
                        target_language: targetLanguage
                    })
                });

                const data = await response.json();
                if (data.translations) {
                    data.translations.forEach((translation, index) => {
                        const item = textsToTranslate[index];
                        const messageElement = document.querySelector(`[data-message-id="${item.id}"]`);
                        if (messageElement) {
                            messageElement.setAttribute('data-translated-text', translation.translated);
                            // Always update the display for "Translate All" function
                            const messageTextElement = document.getElementById(`message-text-${item.id}`);
                            if (messageTextElement) {
                                messageTextElement.textContent = translation.translated;
                                messageElement.setAttribute('data-translation-shown', 'true');
                            }
                        }
                    });
                }
            } catch (error) {
                // Batch translation error handled silently
            }
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize currentUser as undefined to indicate auth check is pending
            window.currentUser = undefined;
            
            // Initialize auto-translate state from checkbox
            const autoTranslateCheckbox = document.getElementById('auto-translate');
            if (autoTranslateCheckbox) {
                autoTranslateEnabled = autoTranslateCheckbox.checked;
            }

            // Check if initial page is set from server
            const initialPage = '{{ initial_page|default("home") }}';
            
            // Check URL hash and show appropriate page
            const hash = window.location.hash.substring(1); // Remove the '#'
            if (hash && hash !== 'home') {
                // Valid page hashes - must match section IDs in HTML
                const validPages = ['courses', 'forum', 'resources', 'tavi', 'contacts', 'about'];
                if (validPages.includes(hash)) {
                    showPage(hash);
                } else {
                    showPage(initialPage);
                }
            } else {
                // Show initial page from server or default to home
                showPage(initialPage);
            }

            checkUser();
            // Don't load forum messages here - let checkUser handle it after determining auth status

            // Add navigation event listeners
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const pageId = link.id.replace('-link', '');
                    showPage(pageId, event);
                });
            });

            // Add PDF upload form listener
            const pdfUploadForm = document.getElementById('pdf-upload-form');
            if (pdfUploadForm) {
                pdfUploadForm.addEventListener('submit', uploadPDF);
            }

            // Add resource upload form listener
            const resourceUploadForm = document.getElementById('resource-upload-form');
            if (resourceUploadForm) {
                resourceUploadForm.addEventListener('submit', uploadResource);
            }

            // Add channel tab event listeners
            const channelTabs = document.querySelectorAll('.channel-tab');
            channelTabs.forEach(tab => {
                tab.addEventListener('click', (event) => {
                    const channel = event.target.getAttribute('data-channel');
                    switchChannel(channel);
                });
            });
        });
    </script>
    <script>
        /*          *     .        *  .    *    *   . 
 .  *  move your mouse to over the stars   .
 *  .  .   change these values:   .  *
   .      * .        .          * .       */
        const STAR_COLOR = '#fff';
        const STAR_SIZE = 3;
        const STAR_MIN_SCALE = 0.2;
        const OVERFLOW_THRESHOLD = 50;
        const STAR_COUNT = ( window.innerWidth + window.innerHeight ) / 8;

        const canvas = document.querySelector( 'canvas' ),
              context = canvas.getContext( '2d' );

        let scale = 1, // device pixel ratio
            width,
            height;

        let stars = [];

        let pointerX,
            pointerY;

        let velocity = { x: 0, y: 0, tx: 0, ty: 0, z: 0.0005 };

        let touchInput = false;

        generate();
        resize();
        step();

        window.onresize = resize;
        document.onmousemove = onMouseMove;
        document.ontouchmove = onTouchMove;
        document.ontouchend = onMouseLeave;
        document.onmouseleave = onMouseLeave;

        function generate() {

           for( let i = 0; i < STAR_COUNT; i++ ) {
            stars.push({
              x: 0,
              y: 0,
              z: STAR_MIN_SCALE + Math.random() * ( 1 - STAR_MIN_SCALE ),
              color: Math.random() < 0.20 ? `hsl(${100 + Math.random() * 40}, 70%, ${40 + Math.random() * 30}%)` : STAR_COLOR
            });
           }

        }

        function placeStar( star ) {

          star.x = Math.random() * width;
          star.y = Math.random() * height;

        }

        function recycleStar( star ) {

          let direction = 'z';

          let vx = Math.abs( velocity.x ),
                vy = Math.abs( velocity.y );

          if( vx > 1 || vy > 1 ) {
            let axis;

            if( vx > vy ) {
              axis = Math.random() < vx / ( vx + vy ) ? 'h' : 'v';
            }
            else {
              axis = Math.random() < vy / ( vx + vy ) ? 'v' : 'h';
            }

            if( axis === 'h' ) {
              direction = velocity.x > 0 ? 'l' : 'r';
            }
            else {
              direction = velocity.y > 0 ? 't' : 'b';
            }
          }
          
          star.z = STAR_MIN_SCALE + Math.random() * ( 1 - STAR_MIN_SCALE );

          if( direction === 'z' ) {
            star.z = 0.1;
            star.x = Math.random() * width;
            star.y = Math.random() * height;
          }
          else if( direction === 'l' ) {
            star.x = -OVERFLOW_THRESHOLD;
            star.y = height * Math.random();
          }
          else if( direction === 'r' ) {
            star.x = width + OVERFLOW_THRESHOLD;
            star.y = height * Math.random();
          }
          else if( direction === 't' ) {
            star.x = width * Math.random();
            star.y = -OVERFLOW_THRESHOLD;
          }
          else if( direction === 'b' ) {
            star.x = width * Math.random();
            star.y = height + OVERFLOW_THRESHOLD;
          }

        }

        function resize() {

          scale = window.devicePixelRatio || 1;

          width = window.innerWidth * scale;
          height = window.innerHeight * scale;

          canvas.width = width;
          canvas.height = height;

          stars.forEach( placeStar );

        }

        function step() {

          context.clearRect( 0, 0, width, height );

          update();
          render();

          requestAnimationFrame( step );

        }

        function update() {

          velocity.tx *= 0.96;
          velocity.ty *= 0.96;

          velocity.x += ( velocity.tx - velocity.x ) * 0.8;
          velocity.y += ( velocity.ty - velocity.y ) * 0.8;

          stars.forEach( ( star ) => {

            star.x += velocity.x * star.z;
            star.y += velocity.y * star.z;

            star.x += ( star.x - width/2 ) * velocity.z * star.z;
            star.y += ( star.y - height/2 ) * velocity.z * star.z;
            star.z += velocity.z;
          
            // recycle when out of bounds
            if( star.x < -OVERFLOW_THRESHOLD || star.x > width + OVERFLOW_THRESHOLD || star.y < -OVERFLOW_THRESHOLD || star.y > height + OVERFLOW_THRESHOLD ) {
              recycleStar( star );
            }

          } );

        }

        function render() {

          stars.forEach( ( star ) => {

            context.beginPath();
            context.lineCap = 'round';
            context.lineWidth = STAR_SIZE * star.z * scale;
            context.globalAlpha = 0.5 + 0.5*Math.random();
            context.strokeStyle = star.color;

            context.beginPath();
            context.moveTo( star.x, star.y );

            var tailX = velocity.x * 2,
                tailY = velocity.y * 2;

            // stroke() wont work on an invisible line
            if( Math.abs( tailX ) < 0.1 ) tailX = 0.5;
            if( Math.abs( tailY ) < 0.1 ) tailY = 0.5;

            context.lineTo( star.x + tailX, star.y + tailY );

            context.stroke();

          } );

        }

        function movePointer( x, y ) {

          if( typeof pointerX === 'number' && typeof pointerY === 'number' ) {

            let ox = x - pointerX,
                oy = y - pointerY;

            velocity.tx = velocity.tx + ( ox / 8*scale ) * ( touchInput ? 1 : -1 );
            velocity.ty = velocity.ty + ( oy / 8*scale ) * ( touchInput ? 1 : -1 );

          }

          pointerX = x;
          pointerY = y;

        }

        function onMouseMove( event ) {

          touchInput = false;

          movePointer( event.clientX, event.clientY );

        }

        function onTouchMove( event ) {

          touchInput = true;

          movePointer( event.touches[0].clientX, event.touches[0].clientY, true );

          event.preventDefault();

        }

        function onMouseLeave() {

          pointerX = null;
          pointerY = null;

        }
    </script>
</body>
</html>